<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"superkatrina123.github.io","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.12.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":5,"unescape":false,"preload":true}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Katrina is trying...">
<meta property="og:type" content="website">
<meta property="og:title" content="耿直咸鱼">
<meta property="og:url" content="https://superkatrina123.github.io/page/2/index.html">
<meta property="og:site_name" content="耿直咸鱼">
<meta property="og:description" content="Katrina is trying...">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Katrina">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://superkatrina123.github.io/page/2/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/2/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>耿直咸鱼</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>
  <a target="_blank" rel="noopener" href="https://github.com/SuperKatrina123" class="github-corner" aria-label="View source on GitHub">
  <svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true">
  <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
  <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path>
  </svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">耿直咸鱼</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">的45°人生</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">65</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories<span class="badge">26</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">106</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Katrina"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">Katrina</p>
  <div class="site-description" itemprop="description">Katrina is trying...</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">106</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">26</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">65</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/SuperKatrina123" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;SuperKatrina123" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:yingyuyan@zju.edu.cn" title="E-Mail → mailto:yingyuyan@zju.edu.cn" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/Katrinasayhello" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;Katrinasayhello" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://instagram.com/katrinasayhello_" title="Instagram → https:&#x2F;&#x2F;instagram.com&#x2F;katrinasayhello_" rel="noopener" target="_blank"><i class="fab fa-instagram fa-fw"></i>Instagram</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://superkatrina123.github.io/2022/08/02/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/redux%E6%BA%90%E7%A0%81%20_Part3_combineReducers%20&&%20bindActionCreators/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Katrina">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="耿直咸鱼">
      <meta itemprop="description" content="Katrina is trying...">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 耿直咸鱼">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/08/02/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/redux%E6%BA%90%E7%A0%81%20_Part3_combineReducers%20&&%20bindActionCreators/" class="post-title-link" itemprop="url">redux源码 | Part3_combineReducers && bindActionCreators</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-08-02 22:33:43 / Modified: 21:55:48" itemprop="dateCreated datePublished" datetime="2022-08-02T22:33:43+08:00">2022-08-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%92%8C%E6%88%91%E4%B8%80%E8%B5%B7%E8%AF%BB%E6%BA%90%E7%A0%81/" itemprop="url" rel="index"><span itemprop="name">和我一起读源码</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>8.3k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>8 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="学习资料"><a href="#学习资料" class="headerlink" title="学习资料"></a>学习资料</h2><p><code>redux</code>源码 <code>v 4.x</code></p>
<h2 id="学习目标"><a href="#学习目标" class="headerlink" title="学习目标"></a>学习目标</h2><ol>
<li>redux源码createStore（Part1）</li>
<li>redux中间件原理（Part2）</li>
<li>redux源码combineReducers（Part3）</li>
</ol>
<h2 id="过程解析"><a href="#过程解析" class="headerlink" title="过程解析"></a>过程解析</h2><h3 id="getundefinedstateerrormessage"><a href="#getUndefinedStateErrorMessage" class="headerlink" title="getUndefinedStateErrorMessage"></a>getUndefinedStateErrorMessage</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">getUndefinedStateErrorMessage</span>(<span class="params">key, action</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> actionType = action &amp;&amp; action.<span class="property">type</span></span><br><span class="line">  <span class="keyword">const</span> actionDescription =</span><br><span class="line">    (actionType &amp;&amp; <span class="string">`action &quot;<span class="subst">$&#123;<span class="built_in">String</span>(actionType)&#125;</span>&quot;`</span>) || <span class="string">&#x27;an action&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="string">`Given <span class="subst">$&#123;actionDescription&#125;</span>, reducer &quot;<span class="subst">$&#123;key&#125;</span>&quot; returned undefined. `</span> +</span><br><span class="line">    <span class="string">`To ignore an action, you must explicitly return the previous state. `</span> +</span><br><span class="line">    <span class="string">`If you want this reducer to hold no value, you can return null instead of undefined.`</span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="getunexpectedstateshapewarningmessage"><a href="#getUnexpectedStateShapeWarningMessage" class="headerlink" title="getUnexpectedStateShapeWarningMessage"></a>getUnexpectedStateShapeWarningMessage</h3><blockquote>
<p>getUnexpectedStateShapeWarningMessage函数：一些错误性的处理</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">getUnexpectedStateShapeWarningMessage</span>(<span class="params"></span></span><br><span class="line"><span class="params">  inputState,</span></span><br><span class="line"><span class="params">  reducers,</span></span><br><span class="line"><span class="params">  action,</span></span><br><span class="line"><span class="params">  unexpectedKeyCache</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> reducerKeys = <span class="title class_">Object</span>.<span class="title function_">keys</span>(reducers)</span><br><span class="line">  <span class="keyword">const</span> argumentName =</span><br><span class="line">    action &amp;&amp; action.<span class="property">type</span> === <span class="title class_">ActionTypes</span>.<span class="property">INIT</span></span><br><span class="line">      ? <span class="string">&#x27;preloadedState argument passed to createStore&#x27;</span></span><br><span class="line">      : <span class="string">&#x27;previous state received by the reducer&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (reducerKeys.<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="string">&#x27;Store does not have a valid reducer. Make sure the argument passed &#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;to combineReducers is an object whose values are reducers.&#x27;</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!<span class="title function_">isPlainObject</span>(inputState)) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="string">`The <span class="subst">$&#123;argumentName&#125;</span> has unexpected type of &quot;`</span> +</span><br><span class="line">      &#123;&#125;.<span class="property">toString</span>.<span class="title function_">call</span>(inputState).<span class="title function_">match</span>(<span class="regexp">/\s([a-z|A-Z]+)/</span>)[<span class="number">1</span>] +</span><br><span class="line">      <span class="string">`&quot;. Expected argument to be an object with the following `</span> +</span><br><span class="line">      <span class="string">`keys: &quot;<span class="subst">$&#123;reducerKeys.join(<span class="string">&#x27;&quot;, &quot;&#x27;</span>)&#125;</span>&quot;`</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> unexpectedKeys = <span class="title class_">Object</span>.<span class="title function_">keys</span>(inputState).<span class="title function_">filter</span>(</span><br><span class="line">    <span class="function"><span class="params">key</span> =&gt;</span> !reducers.<span class="title function_">hasOwnProperty</span>(key) &amp;&amp; !unexpectedKeyCache[key]</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  unexpectedKeys.<span class="title function_">forEach</span>(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">    unexpectedKeyCache[key] = <span class="literal">true</span></span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (action &amp;&amp; action.<span class="property">type</span> === <span class="title class_">ActionTypes</span>.<span class="property">REPLACE</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (unexpectedKeys.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="string">`Unexpected <span class="subst">$&#123;unexpectedKeys.length &gt; <span class="number">1</span> ? <span class="string">&#x27;keys&#x27;</span> : <span class="string">&#x27;key&#x27;</span>&#125;</span> `</span> +</span><br><span class="line">      <span class="string">`&quot;<span class="subst">$&#123;unexpectedKeys.join(<span class="string">&#x27;&quot;, &quot;&#x27;</span>)&#125;</span>&quot; found in <span class="subst">$&#123;argumentName&#125;</span>. `</span> +</span><br><span class="line">      <span class="string">`Expected to find one of the known reducer keys instead: `</span> +</span><br><span class="line">      <span class="string">`&quot;<span class="subst">$&#123;reducerKeys.join(<span class="string">&#x27;&quot;, &quot;&#x27;</span>)&#125;</span>&quot;. Unexpected keys will be ignored.`</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="assertreducershapereducers"><a href="#assertReducerShape-reducers" class="headerlink" title="assertReducerShape(reducers)"></a>assertReducerShape(reducers)</h3><blockquote>
<p>assertReducerShape函数：</p>
<p>​	这部分函数其实就是对reducer的一个校验</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	assertReducerShape(reducers)函数</span></span><br><span class="line"><span class="comment">	输入值分析：</span></span><br><span class="line"><span class="comment">		- reducers </span></span><br><span class="line"><span class="comment">	输出分析：</span></span><br><span class="line"><span class="comment">		- reducers </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">assertReducerShape</span>(<span class="params">reducers</span>) &#123;</span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">keys</span>(reducers).<span class="title function_">forEach</span>(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> reducer = reducers[key]</span><br><span class="line">    <span class="keyword">const</span> initialState = <span class="title function_">reducer</span>(<span class="literal">undefined</span>, &#123; <span class="attr">type</span>: <span class="title class_">ActionTypes</span>.<span class="property">INIT</span> &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> initialState === <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(</span><br><span class="line">        <span class="string">`Reducer &quot;<span class="subst">$&#123;key&#125;</span>&quot; returned undefined during initialization. `</span> +</span><br><span class="line">          <span class="string">`If the state passed to the reducer is undefined, you must `</span> +</span><br><span class="line">          <span class="string">`explicitly return the initial state. The initial state may `</span> +</span><br><span class="line">          <span class="string">`not be undefined. If you don&#x27;t want to set a value for this reducer, `</span> +</span><br><span class="line">          <span class="string">`you can use null instead of undefined.`</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      <span class="keyword">typeof</span> <span class="title function_">reducer</span>(<span class="literal">undefined</span>, &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">ActionTypes</span>.<span class="title function_">PROBE_UNKNOWN_ACTION</span>()</span><br><span class="line">      &#125;) === <span class="string">&#x27;undefined&#x27;</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(</span><br><span class="line">        <span class="string">`Reducer &quot;<span class="subst">$&#123;key&#125;</span>&quot; returned undefined when probed with a random type. `</span> +</span><br><span class="line">          <span class="string">`Don&#x27;t try to handle <span class="subst">$&#123;ActionTypes.INIT&#125;</span> or other actions in &quot;redux/*&quot; `</span> +</span><br><span class="line">          <span class="string">`namespace. They are considered private. Instead, you must return the `</span> +</span><br><span class="line">          <span class="string">`current state for any unknown actions, unless it is undefined, `</span> +</span><br><span class="line">          <span class="string">`in which case you must return the initial state, regardless of the `</span> +</span><br><span class="line">          <span class="string">`action type. The initial state may not be undefined, but can be null.`</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="combinereducersreducers"><a href="#combineReducers-reducers" class="headerlink" title="combineReducers(reducers)"></a>combineReducers(reducers)</h3><blockquote>
<p>combineReducers函数：用于合并reducers</p>
<p>基本思路：</p>
<ul>
<li>reducers浅复制到finalReducers里面</li>
<li>reducers基本校验</li>
<li>返回combination函数</li>
</ul>
<p>combination函数：</p>
<p>基本思路：</p>
<ul>
<li>基本性的检测</li>
<li>维护两个变量hasChanged &#x3D; false[用于监听状态有没有改变]和nextState &#x3D; {}[用于存更新后的状态]</li>
<li>遍历finalReducers，获取reducer和state里面存储的reducer所需要的state<ul>
<li>通过reducer(state,action)得到新的状态</li>
<li>得到新的状态存入nextState里面</li>
<li>判断是否状态改变</li>
</ul>
</li>
<li>最终判断状态改变否</li>
</ul>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	combineReducers函数用于合并reducers</span></span><br><span class="line"><span class="comment">		输入参数说明：</span></span><br><span class="line"><span class="comment">			- reducers：多个reducer</span></span><br><span class="line"><span class="comment">		输出说明：</span></span><br><span class="line"><span class="comment">			- combination 函数 （后面具体分析）</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">combineReducers</span>(<span class="params">reducers</span>) &#123;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  	mock:</span></span><br><span class="line"><span class="comment">  	reducers = &#123;</span></span><br><span class="line"><span class="comment">  		reducer1: reducer1,</span></span><br><span class="line"><span class="comment">  		reducer2: reducer2,</span></span><br><span class="line"><span class="comment">  		...</span></span><br><span class="line"><span class="comment">  		reducern: reducern,</span></span><br><span class="line"><span class="comment">  	&#125;</span></span><br><span class="line"><span class="comment">  	维护两个变量：</span></span><br><span class="line"><span class="comment">  		reducerKeys = [reducer1, reducer2, ..., reducer3]</span></span><br><span class="line"><span class="comment">  		finalReducers = &#123;&#125;</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">const</span> reducerKeys = <span class="title class_">Object</span>.<span class="title function_">keys</span>(reducers)</span><br><span class="line">  <span class="keyword">const</span> finalReducers = &#123;&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 以下是浅复制的过程...   得到finalReducers </span></span><br><span class="line">  <span class="comment">// 遍历reducers</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; reducerKeys.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> key = reducerKeys[i]</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// process.env.NODE_ENV用于判断生产环境或开发环境</span></span><br><span class="line">    <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> reducers[key] === <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">        <span class="title function_">warning</span>(<span class="string">`No reducer provided for key &quot;<span class="subst">$&#123;key&#125;</span>&quot;`</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 如果reducer是一个函数，就添加到finalReducers里面</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> reducers[key] === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      finalReducers[key] = reducers[key]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">  <span class="keyword">const</span> finalReducerKeys = <span class="title class_">Object</span>.<span class="title function_">keys</span>(finalReducers)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// This is used to make sure we don&#x27;t warn about the same</span></span><br><span class="line">  <span class="comment">// keys multiple times.</span></span><br><span class="line">  <span class="keyword">let</span> unexpectedKeyCache</span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">    unexpectedKeyCache = &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 校验reducers中的reducer</span></span><br><span class="line">  <span class="keyword">let</span> shapeAssertionError</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="title function_">assertReducerShape</span>(finalReducers)      <span class="comment">// --------往上翻这个函数做了什么</span></span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    shapeAssertionError = e</span><br><span class="line">  &#125;</span><br><span class="line">	</span><br><span class="line">    </span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  	combination函数：</span></span><br><span class="line"><span class="comment">  	输入参数分析：</span></span><br><span class="line"><span class="comment">  		- state：初始值为空对象</span></span><br><span class="line"><span class="comment">  		- action：一个对象 &#123;type:xxx, data:xxx&#125;</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">combination</span>(<span class="params">state = &#123;&#125;, action</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (shapeAssertionError) &#123;</span><br><span class="line">      <span class="keyword">throw</span> shapeAssertionError</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> warningMessage = <span class="title function_">getUnexpectedStateShapeWarningMessage</span>(</span><br><span class="line">        state,</span><br><span class="line">        finalReducers,</span><br><span class="line">        action,</span><br><span class="line">        unexpectedKeyCache</span><br><span class="line">      )</span><br><span class="line">      <span class="keyword">if</span> (warningMessage) &#123;</span><br><span class="line">        <span class="title function_">warning</span>(warningMessage)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      维护两个变量：</span></span><br><span class="line"><span class="comment">      	hasChanged = false</span></span><br><span class="line"><span class="comment">      	nextState = &#123;&#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">let</span> hasChanged = <span class="literal">false</span>   <span class="comment">// 用于监听状态有没有改变的</span></span><br><span class="line">    <span class="keyword">const</span> nextState = &#123;&#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    	mock:</span></span><br><span class="line"><span class="comment">    	finalReducers = &#123;</span></span><br><span class="line"><span class="comment">            reducer1: reducer1,</span></span><br><span class="line"><span class="comment">            reducer2: reducer2,</span></span><br><span class="line"><span class="comment">            ...</span></span><br><span class="line"><span class="comment">            reducern: reducern,</span></span><br><span class="line"><span class="comment">  		&#125;</span></span><br><span class="line"><span class="comment">  		</span></span><br><span class="line"><span class="comment">  		finalReducerKeys = [reducer1, reducer2, reducer3, ...]</span></span><br><span class="line"><span class="comment">  		</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; finalReducerKeys.<span class="property">length</span>; i++) &#123;  <span class="comment">// 遍历finalReducers</span></span><br><span class="line">      <span class="keyword">const</span> key = finalReducerKeys[i]					<span class="comment">// reducer1, reducer2, reducer3, ...</span></span><br><span class="line">      <span class="keyword">const</span> reducer = finalReducers[key]                 <span class="comment">// 获取当前reducer: reducer1, reducer2, reducer3</span></span><br><span class="line">      <span class="keyword">const</span> previousStateForKey = state[key]             <span class="comment">// 获取当前reducer在state</span></span><br><span class="line">      <span class="keyword">const</span> nextStateForKey = <span class="title function_">reducer</span>(previousStateForKey, action)  <span class="comment">// reducer纯函数加工状态获得新的state</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> nextStateForKey === <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> errorMessage = <span class="title function_">getUndefinedStateErrorMessage</span>(key, action) <span class="comment">// --------往上翻这个函数做了什么</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(errorMessage)</span><br><span class="line">      &#125;</span><br><span class="line">      nextState[key] = nextStateForKey                  <span class="comment">// nextState里面存入新的state [key=key, value=新的state]</span></span><br><span class="line">      hasChanged = hasChanged || nextStateForKey !== previousStateForKey   <span class="comment">// 小状态改变否？？？</span></span><br><span class="line">    &#125;</span><br><span class="line">      </span><br><span class="line">    hasChanged =</span><br><span class="line">      hasChanged || finalReducerKeys.<span class="property">length</span> !== <span class="title class_">Object</span>.<span class="title function_">keys</span>(state).<span class="property">length</span>   <span class="comment">// 整体状态改变否？</span></span><br><span class="line">    <span class="keyword">return</span> hasChanged ? nextState : state   <span class="comment">// 改变了 返回nextState 否则 返回state </span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="bindactioncreatorsactioncreator-dispatch"><a href="#bindActionCreators-actionCreator-dispatch" class="headerlink" title="bindActionCreators(actionCreator, dispatch)"></a>bindActionCreators(actionCreator, dispatch)</h3><blockquote>
<p>bindActionCreator函数：</p>
<p>将一个或多个action和dispatch组合起来生成<code>mapDispatchToProps</code>需要生成的内容</p>
<p>connect(mapStateToProps, mapDispatchToProps)(UI component)  connect用以从UI组件生成容器组件</p>
<p>mapStateToProps：将state映射到UI组件的参数（props）</p>
<p>mapDispatchToProps：将用户对UI组件的操作映射成Action</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">bindActionCreator</span>(<span class="params">actionCreator, dispatch</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">     <span class="comment">/*</span></span><br><span class="line"><span class="comment">     	apply修改this指向</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">dispatch</span>(actionCreator.<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">bindActionCreators</span>(<span class="params">actionCreators, dispatch</span>) &#123;</span><br><span class="line">  <span class="comment">// 参数校验</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    如果actionCreators是一个函数，那么就需要bindActionCreator进行一些处理</span></span><br><span class="line"><span class="comment">    并且看到bindActionCreator返回的是一个函数</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    如果actionCreators不是一个object（排除null），报错！</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> actionCreators === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">bindActionCreator</span>(actionCreators, dispatch)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> actionCreators !== <span class="string">&#x27;object&#x27;</span> || actionCreators === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(</span><br><span class="line">      <span class="string">`bindActionCreators expected an object or a function, instead received <span class="subst">$&#123;</span></span></span><br><span class="line"><span class="subst"><span class="string">        actionCreators === <span class="literal">null</span> ? <span class="string">&#x27;null&#x27;</span> : <span class="keyword">typeof</span> actionCreators</span></span></span><br><span class="line"><span class="subst"><span class="string">      &#125;</span>. `</span> +</span><br><span class="line">        <span class="string">`Did you write &quot;import ActionCreators from&quot; instead of &quot;import * as ActionCreators from&quot;?`</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 维护一个参数boundActionCreators是一个对象，初始为空对象</span></span><br><span class="line">  <span class="keyword">const</span> boundActionCreators = &#123;&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  	遍历actionCreators，如果actionCreator是一个函数，bindActionCreator后返回一个函数</span></span><br><span class="line"><span class="comment">  	最终返回boundActionCreators对象，key为原来的key，value为函数形式</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> actionCreators) &#123;</span><br><span class="line">    <span class="keyword">const</span> actionCreator = actionCreators[key]</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> actionCreator === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      boundActionCreators[key] = <span class="title function_">bindActionCreator</span>(actionCreator, dispatch)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> boundActionCreators</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://superkatrina123.github.io/2022/08/01/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/redux%E6%BA%90%E7%A0%81%20_Part2_%20middleware/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Katrina">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="耿直咸鱼">
      <meta itemprop="description" content="Katrina is trying...">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 耿直咸鱼">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/08/01/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/redux%E6%BA%90%E7%A0%81%20_Part2_%20middleware/" class="post-title-link" itemprop="url">redux源码 | Part2_ middleware</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-08-01 22:33:43" itemprop="dateCreated datePublished" datetime="2022-08-01T22:33:43+08:00">2022-08-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-08-02 21:52:24" itemprop="dateModified" datetime="2022-08-02T21:52:24+08:00">2022-08-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%92%8C%E6%88%91%E4%B8%80%E8%B5%B7%E8%AF%BB%E6%BA%90%E7%A0%81/" itemprop="url" rel="index"><span itemprop="name">和我一起读源码</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>2.7k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>2 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="学习资料"><a href="#学习资料" class="headerlink" title="学习资料"></a>学习资料</h2><p><code>redux</code>源码 <code>v 4.x</code></p>
<h2 id="学习目标"><a href="#学习目标" class="headerlink" title="学习目标"></a>学习目标</h2><ol>
<li>redux源码createStore（Part1）</li>
<li>redux中间件原理（Part2）</li>
<li>redux源码combineReducers（Part3）</li>
</ol>
<h2 id="理解middleware-中间件"><a href="#理解Middleware-中间件" class="headerlink" title="理解Middleware 中间件"></a>理解Middleware 中间件</h2><p><a target="_blank" rel="noopener" href="http://cn.redux.js.org/understanding/history-and-design/middleware/#%E7%90%86%E8%A7%A3-middleware">Middleware 中间件</a></p>
<p>看了官方文档的两个例子：日志和异常监控，对中间件的妙用有了初步的理解</p>
<h3 id="middleware洋葱模型"><a href="#middleware洋葱模型" class="headerlink" title="middleware洋葱模型"></a>middleware洋葱模型</h3><img src="/2022/08/01/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/redux%E6%BA%90%E7%A0%81%20_Part2_%20middleware/middleware.png" class title="middleware">

<h2 id="过程解析"><a href="#过程解析" class="headerlink" title="过程解析"></a>过程解析</h2><h3 id="compose"><a href="#compose" class="headerlink" title="compose"></a>compose</h3><blockquote>
<p>compose函数： 将多个函数按照顺序执行，前一个函数的返回值作为下一个函数的参数，最终返回结果</p>
<p>乍一看，哎呀妈呀，这compose函数也太亲切了吧！[开心出东北话~]</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">compose</span>(<span class="params">...funcs</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (funcs.<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">arg</span> =&gt;</span> arg</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (funcs.<span class="property">length</span> === <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> funcs[<span class="number">0</span>]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> funcs.<span class="title function_">reduce</span>(<span class="function">(<span class="params">a, b</span>) =&gt;</span> <span class="function">(<span class="params">...args</span>) =&gt;</span> <span class="title function_">a</span>(<span class="title function_">b</span>(...args)))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>compose函数妙用：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> funcs = [a, b, c];</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">a</span>(<span class="params">x</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> x+<span class="number">2</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">b</span>(<span class="params">x</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> x+<span class="number">3</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">c</span>(<span class="params">x</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> x+<span class="number">10</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">compose</span>(...funcs)(<span class="number">3</span>))  <span class="comment">// 18 = 3 + 2 + 3 + 10 </span></span><br></pre></td></tr></table></figure>

<h3 id="middleware"><a href="#middleware" class="headerlink" title="middleware"></a>middleware</h3><blockquote>
<p>applyMiddleware函数：这个函数主要是返回一个createStore函数，其中createStore函数的返回值之一的dispatch是经过中间件包装的</p>
<p>所以这个函数我们主要关注dispatch是怎么被包装的~~</p>
<p>输入参数说明：</p>
<p>​	- middlewares  多个中间件</p>
<p>输出说明：</p>
<p>​	- createStore函数</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> compose <span class="keyword">from</span> <span class="string">&#x27;./compose&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">applyMiddleware</span>(<span class="params">...middlewares</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">createStore</span> =&gt;</span> <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 创建一个store</span></span><br><span class="line">    <span class="keyword">const</span> store = <span class="title function_">createStore</span>(...args)</span><br><span class="line">    <span class="keyword">let</span> <span class="title function_">dispatch</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(</span><br><span class="line">        <span class="string">&#x27;Dispatching while constructing your middleware is not allowed. &#x27;</span> +</span><br><span class="line">          <span class="string">&#x27;Other middleware would not be applied to this dispatch.&#x27;</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 下面的代码主要是对dispatch进行包装</span></span><br><span class="line">	</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    	middlewareAPI是一个对象，包含getState方法和dispatch方法（起到包装的作用）</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">const</span> middlewareAPI = &#123;</span><br><span class="line">      <span class="attr">getState</span>: store.<span class="property">getState</span>,</span><br><span class="line">      <span class="attr">dispatch</span>: <span class="function">(<span class="params">...args</span>) =&gt;</span> <span class="title function_">dispatch</span>(...args)   <span class="comment">// 闭包</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    	我们知道，多个middlewares是采用链式调用的解构的</span></span><br><span class="line"><span class="comment">    	首先把每个middleware都包装成一个函数</span></span><br><span class="line"><span class="comment">    	然后很好地用到了compose函数，对这些中间件进行嵌套执行，初始参数为store.dispatch</span></span><br><span class="line"><span class="comment">    	store.dispatch --M1--&gt; res1 --M2--&gt; res2 --M3--&gt; ... --M N--&gt; final res   </span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="comment">// map： middleware -&gt; middleware(middlewareAPI)，相当于返回的是middleware(middlewareAPI)一次调用后的结果</span></span><br><span class="line">    <span class="comment">// 具体看example_redux_thunk里的&#123;dispatch, getState&#125; =&gt; next =&gt; action =&gt; &#123;&#125;这个部分</span></span><br><span class="line">    <span class="comment">// 所以chain相当于是</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    	[</span></span><br><span class="line"><span class="comment">    		(next) =&gt; (action) =&gt; &#123;&#125;,            ---M1</span></span><br><span class="line"><span class="comment">    		(next) =&gt; (action) =&gt; &#123;&#125;,            ---M2</span></span><br><span class="line"><span class="comment">    		(next) =&gt; (action) =&gt; &#123;&#125;,            ---M3</span></span><br><span class="line"><span class="comment">    		...</span></span><br><span class="line"><span class="comment">    	]</span></span><br><span class="line"><span class="comment">    	</span></span><br><span class="line"><span class="comment">    	经过compose之后</span></span><br><span class="line"><span class="comment">    	dispath等于</span></span><br><span class="line"><span class="comment">    	M2(M1(M3(stroe.dispatch)))的结果  </span></span><br><span class="line"><span class="comment">    	</span></span><br><span class="line"><span class="comment">    	[这一步就是利用洋葱模型一步一步再包装dispatch]</span></span><br><span class="line"><span class="comment">    	</span></span><br><span class="line"><span class="comment">    	代入洋葱模型想一想是不是特别容易理解？</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">const</span> chain = middlewares.<span class="title function_">map</span>(<span class="function"><span class="params">middleware</span> =&gt;</span> <span class="title function_">middleware</span>(middlewareAPI))  </span><br><span class="line">    dispatch = <span class="title function_">compose</span>(...chain)(store.<span class="property">dispatch</span>)   <span class="comment">// 利用中间件一层层包装dispatch，生成一个新的dispatch</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      ...store,    <span class="comment">// 对象解构</span></span><br><span class="line">      dispatch     <span class="comment">// 同名属性覆盖</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="example_redux_thunk"><a href="#example-redux-thunk" class="headerlink" title="example_redux_thunk"></a>example_redux_thunk</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createThunkMiddle</span>(<span class="params">extraArgument</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (&#123;dispatch, getState&#125; =&gt; <span class="function">(<span class="params">next</span>) =&gt;</span> <span class="function">(<span class="params">action</span>) =&gt;</span> &#123;   <span class="comment">// 典型的柯里化函数</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> action === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">action</span>(dispatch, getState, extraArgument);   <span class="comment">// 洋葱模型可以提前返回</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">next</span>(action);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> thunk = <span class="title function_">createThunkMiddleware</span>();</span><br><span class="line">thunk.<span class="property">withExtraArgument</span> = createThunkMiddle;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> thunk;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://superkatrina123.github.io/2022/08/01/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/redux%E6%BA%90%E7%A0%81_%20Part1_%20createStore/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Katrina">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="耿直咸鱼">
      <meta itemprop="description" content="Katrina is trying...">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 耿直咸鱼">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/08/01/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/redux%E6%BA%90%E7%A0%81_%20Part1_%20createStore/" class="post-title-link" itemprop="url">redux源码 | Part1_ createStore</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-08-01 21:33:43" itemprop="dateCreated datePublished" datetime="2022-08-01T21:33:43+08:00">2022-08-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-08-02 21:51:50" itemprop="dateModified" datetime="2022-08-02T21:51:50+08:00">2022-08-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%92%8C%E6%88%91%E4%B8%80%E8%B5%B7%E8%AF%BB%E6%BA%90%E7%A0%81/" itemprop="url" rel="index"><span itemprop="name">和我一起读源码</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>14k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>13 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="学习资料"><a href="#学习资料" class="headerlink" title="学习资料"></a>学习资料</h2><p><code>redux</code>源码 <code>v 4.x</code></p>
<h2 id="学习目标"><a href="#学习目标" class="headerlink" title="学习目标"></a>学习目标</h2><ol>
<li>redux源码createStore（Part1）</li>
<li>redux中间件原理（Part2）</li>
<li>redux源码combineReducers（Part3）</li>
</ol>
<h2 id="redux介绍"><a href="#Redux介绍" class="headerlink" title="Redux介绍"></a>Redux介绍</h2><h3 id="redux是什么"><a href="#Redux是什么" class="headerlink" title="Redux是什么"></a>Redux是什么</h3><ul>
<li>redux是专门用于做状态管理的JS库</li>
<li>redux的作用是<strong>集中式管理react应用中多个组件共享的状态</strong></li>
</ul>
<h3 id="什么时候需要用redux"><a href="#什么时候需要用redux" class="headerlink" title="什么时候需要用redux"></a>什么时候需要用redux</h3><ul>
<li>某个组件的状态，需要让其他组件可以随时拿到（共享）</li>
<li>一个组件需要<strong>改变</strong>另一个组件的状态（通信）</li>
</ul>
<h3 id="redux组成"><a href="#Redux组成" class="headerlink" title="Redux组成"></a>Redux组成</h3><h4 id="state-状态"><a href="#State-状态" class="headerlink" title="State 状态"></a>State 状态</h4><p>状态即传递的数据</p>
<p>在React开发的项目的时候，大致可以把State分为三类：</p>
<ul>
<li><strong>DomainDate:</strong> 可以理解为成为服务器端的数据，比如：获取用户的信息，商品的列表等等</li>
<li><strong>UI State:</strong> 决定当前UI决定展现的状态，比如：弹框的显示隐藏，受控组件等等</li>
<li><strong>App State:</strong> App级别的状态，比如：当前是否请求loading，当前路由信息等可能被多个和组件去使用的到的状态</li>
</ul>
<h4 id="action-事件"><a href="#Action-事件" class="headerlink" title="Action 事件"></a>Action 事件</h4><p>Action是把数据从应用传到store的载体，是数据的唯一来源，一般来说，可以通过store.dispatch()将action传递给store</p>
<ul>
<li>action包含2个属性<ul>
<li><strong>type</strong>：标识属性, 值为字符串, 唯一, 必要属性</li>
<li><strong>data</strong>：数据属性, 值类型任意, 可选属性</li>
</ul>
</li>
<li>例子：{ type: ‘ADD_STUDENT’,data:{name: ‘tom’,age:18} }</li>
</ul>
<img src="/2022/08/01/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/redux%E6%BA%90%E7%A0%81_%20Part1_%20createStore/action.png" class title="action">

<h4 id="reducer"><a href="#Reducer" class="headerlink" title="Reducer"></a>Reducer</h4><ul>
<li>Reducer的本质就是一个函数，它用来响应发送过来的actions，然后经过处理，把state发送给Store的，用于<strong>初始化状态</strong>、<strong>加工状态</strong></li>
<li>在Reducer函数中，<strong>需要return返回值</strong>，这样Store才能接收到数据，函数会接收两个参数，一个参数是初始化state【旧】，第二个参数是action，加工时，根据旧的state和action， 产生新的state的<strong>纯函数</strong></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> initState = &#123;...&#125;;</span><br><span class="line"></span><br><span class="line">rootReducer = <span class="function">(<span class="params">state = initState, action</span>) =&gt;</span> &#123;...<span class="keyword">return</span> &#123;...&#125;&#125;;</span><br></pre></td></tr></table></figure>

<img src="/2022/08/01/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/redux%E6%BA%90%E7%A0%81_%20Part1_%20createStore/reducer.png" class title="reducer">

<h3 id="redux三大核心概念"><a href="#Redux三大核心概念" class="headerlink" title="Redux三大核心概念"></a>Redux三大核心概念</h3><h4 id="单一数据源"><a href="#单一数据源" class="headerlink" title="单一数据源"></a>单一数据源</h4><p>整个应用的state被存储在一颗<strong>object tree</strong>中，并且这个<strong>object tree</strong>只存在<strong>唯一</strong>一个store中，使得状态之间更好管理，更容易调试，以及一些撤销&#x2F;重做的功能更容易</p>
<h4 id="state是只读的"><a href="#state是只读的" class="headerlink" title="state是只读的"></a>state是只读的</h4><p>唯一改变state的方法是通过dispatch触发action</p>
<p>这样能够确保视图和网络请求都不能直接去修改state，相反，它们只能表达想要修改的意图，因为所有的修改都被集中化处理，并且严格按照一个接一个的顺序执行</p>
<h4 id="使用纯函数来执行修改"><a href="#使用纯函数来执行修改" class="headerlink" title="使用纯函数来执行修改"></a>使用纯函数来执行修改</h4><p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7057376945939415053">纯函数</a></p>
<blockquote>
<p>纯函数</p>
<ul>
<li>数据不可变（Immutable Data）：此函数在<strong>相同的输入值时</strong>，需产生相同的<strong>输出</strong></li>
<li>无状态（Statelessness）：函数的<strong>输出和输入值以外的其他隐藏信息或状态无关</strong>，也和由<strong>IO设备产生的外部输出无关</strong></li>
<li>没有副作用（No Side Effects）：该函数不能<strong>有语义上可观察的函数副作用</strong>，例如“<strong>触发事件</strong>”，使输出设备输出，或更改输出值以外物件的内容等</li>
</ul>
</blockquote>
<p>为了描述<strong>action</strong>如何改变<strong>state tree</strong>，你需要编写<strong>reducers</strong></p>
<p>Reducers只是一些纯函数，它接收先前的state和action，并且返回新的state， 可以复用，可以控制顺序，传入附加参数State状态</p>
<h3 id="redux工作机制"><a href="#Redux工作机制" class="headerlink" title="Redux工作机制"></a>Redux工作机制</h3><img src="/2022/08/01/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/redux%E6%BA%90%E7%A0%81_%20Part1_%20createStore/redux%E5%B7%A5%E4%BD%9C%E6%9C%BA%E5%88%B6.png" class title="redux工作机制">

<h2 id="过程解析"><a href="#过程解析" class="headerlink" title="过程解析"></a>过程解析</h2><h3 id="createstore"><a href="#createStore" class="headerlink" title="createStore"></a>createStore</h3><blockquote>
<p>源码的注释写得很清楚~这里做一下简单的注释</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> $$observable <span class="keyword">from</span> <span class="string">&#x27;symbol-observable&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ActionTypes</span> <span class="keyword">from</span> <span class="string">&#x27;./utils/actionTypes&#x27;</span></span><br><span class="line"><span class="keyword">import</span> isPlainObject <span class="keyword">from</span> <span class="string">&#x27;./utils/isPlainObject&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	此函数用于创建Redux store（store可以认为是一个管理state的仓库）</span></span><br><span class="line"><span class="comment">		值得注意的是：</span></span><br><span class="line"><span class="comment">			- dispatch是改变state的唯一方法【核心概念2：state只读】</span></span><br><span class="line"><span class="comment">			- app里面只能有一个store【核心概念1:单一数据源】：</span></span><br><span class="line"><span class="comment">				如果你的app有很多模块的话，你可以通过多个reducer来管理，通过combineReducer来组合reducer</span></span><br><span class="line"><span class="comment">				</span></span><br><span class="line"><span class="comment">	参数说明：</span></span><br><span class="line"><span class="comment">		1. reducer &#123;Function&#125; 通过前面的说明已经知道reducer是一个纯函数，用于初始化状态和加工状态</span></span><br><span class="line"><span class="comment">		2. preloadedState &#123;any&#125; 初始状态</span></span><br><span class="line"><span class="comment">		3. enhancer &#123;Function&#125; 增强器（可认为是拓展功能），比如中间件等等 Redux 附带的唯一存储增强器是`applyMiddleware()`。</span></span><br><span class="line"><span class="comment">	返回值说明：</span></span><br><span class="line"><span class="comment">		store</span></span><br><span class="line"><span class="comment">			有如下功能：</span></span><br><span class="line"><span class="comment">			- read state 读取状态                     - getSate</span></span><br><span class="line"><span class="comment">			- dispatch action 调度动作			      - dispatch</span></span><br><span class="line"><span class="comment">			- subscribe to changes  监听变化          - subscribe</span></span><br><span class="line"><span class="comment">			</span></span><br><span class="line"><span class="comment">			[replaceReducer和observable不是很重要]</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">createStore</span>(<span class="params">reducer, preloadedState, enhancer</span>) &#123;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  	Step1：参数校验</span></span><br><span class="line"><span class="comment">  		1. 校验1：直接传入多个enhancers的情况，下面注释说明了，你可能是传入了多个enhancers，直接传入是不对的，你需要把它们组合（compose them）</span></span><br><span class="line"><span class="comment">  		2. 检验2：没传入初始状态的情况，也就是你只穿了两个参数，那么你的第二个参数应该是enhancer，而preloadedState为undefined</span></span><br><span class="line"><span class="comment">  		3. 校验3：检验enhancer是不是一个函数</span></span><br><span class="line"><span class="comment">  		4. 校验4：reducer是不是一个函数</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    (<span class="keyword">typeof</span> preloadedState === <span class="string">&#x27;function&#x27;</span> &amp;&amp; <span class="keyword">typeof</span> enhancer === <span class="string">&#x27;function&#x27;</span>) ||</span><br><span class="line">    (<span class="keyword">typeof</span> enhancer === <span class="string">&#x27;function&#x27;</span> &amp;&amp; <span class="keyword">typeof</span> <span class="variable language_">arguments</span>[<span class="number">3</span>] === <span class="string">&#x27;function&#x27;</span>)</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(</span><br><span class="line">      <span class="string">&#x27;It looks like you are passing several store enhancers to &#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;createStore(). This is not supported. Instead, compose them &#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;together to a single function.&#x27;</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> preloadedState === <span class="string">&#x27;function&#x27;</span> &amp;&amp; <span class="keyword">typeof</span> enhancer === <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">    enhancer = preloadedState</span><br><span class="line">    preloadedState = <span class="literal">undefined</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> enhancer !== <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> enhancer !== <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Expected the enhancer to be a function.&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">enhancer</span>(createStore)(reducer, preloadedState)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> reducer !== <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Expected the reducer to be a function.&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">	</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  	Step2：定义内部变量</span></span><br><span class="line"><span class="comment">  		1. 变量1：currentReducer = reducer             | 当前的reducer </span></span><br><span class="line"><span class="comment">  		2. 变量2：currentState = preloadedState        | 当前的state：可被getState()获取</span></span><br><span class="line"><span class="comment">  		3. 变量3：currentListeners = []                | 监听列表</span></span><br><span class="line"><span class="comment">  		4. 变量4：nextListeners = currentListeners     | 监听列表</span></span><br><span class="line"><span class="comment">  		5. 变量5：isDispatching = false                | 是否正在被dispatch（调度）</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">let</span> currentReducer = reducer</span><br><span class="line">  <span class="keyword">let</span> currentState = preloadedState</span><br><span class="line">  <span class="keyword">let</span> currentListeners = []</span><br><span class="line">  <span class="keyword">let</span> nextListeners = currentListeners</span><br><span class="line">  <span class="keyword">let</span> isDispatching = <span class="literal">false</span></span><br><span class="line">	</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  	 ensureCanMutateNextListeners函数：</span></span><br><span class="line"><span class="comment">  	 	生成currentListeners的浅拷贝，可以把nextListeners作为临时调度列表</span></span><br><span class="line"><span class="comment">  	 	这可以防止消费者调用的任何错误在调度过程中订阅/取消订阅</span></span><br><span class="line"><span class="comment">  </span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">ensureCanMutateNextListeners</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (nextListeners === currentListeners) &#123;</span><br><span class="line">      nextListeners = currentListeners.<span class="title function_">slice</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  	getState函数</span></span><br><span class="line"><span class="comment">  		返回当前状态（currentState）</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">getState</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    	获取state的时候必须保证这个reducer已经结束工作了，store已经接收到新的state了，才能调用getState</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (isDispatching) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(</span><br><span class="line">        <span class="string">&#x27;You may not call store.getState() while the reducer is executing. &#x27;</span> +</span><br><span class="line">          <span class="string">&#x27;The reducer has already received the state as an argument. &#x27;</span> +</span><br><span class="line">          <span class="string">&#x27;Pass it down from the top reducer instead of reading it from the store.&#x27;</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> currentState</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  	subscribe函数：作用是订阅监听</span></span><br><span class="line"><span class="comment">  		任何时候dispatch一个action都会调用这个函数【一触即发！】</span></span><br><span class="line"><span class="comment">  		调用action后state object tree的部分可能已经改变了</span></span><br><span class="line"><span class="comment">  		所以可以再去调用getState()读取回调内的当前状态树	</span></span><br><span class="line"><span class="comment">  		</span></span><br><span class="line"><span class="comment">  	参数说明：</span></span><br><span class="line"><span class="comment">  		- listener：监听到变化后执行的函数，比如subscribe(function() &#123;console.log(1)&#125;) 变化后打印1</span></span><br><span class="line"><span class="comment">  	返回值说明：</span></span><br><span class="line"><span class="comment">  		- unsubscribe &#123;Fuction&#125;： 返回一个具有取消订阅功能的函数</span></span><br><span class="line"><span class="comment">  </span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">subscribe</span>(<span class="params">listener</span>) &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    	listener必须是一个函数</span></span><br><span class="line"><span class="comment">    		举个例子，listener是一个render函数，调用subscribe就会重新渲染某部分的页面（取决于你的render函数需要render什么）</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> listener !== <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Expected the listener to be a function.&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    	同理：获取state的时候必须保证这个reducer已经结束工作了，store已经接收到新的state了，才能调用getState</span></span><br><span class="line"><span class="comment">    	这也就是说明，顺序是 dispatch action -&gt; state改变 -&gt; 被subscribe(listener) 监听到 -&gt; 获取新的状态 -&gt; listener函数调用</span></span><br><span class="line"><span class="comment">    	举例： 计时器：dispatch action [目的在于使得value+1] -&gt; value状态改变 -&gt; 被subscribe(render) 监听到 -&gt; 获取新的state -&gt; 重新渲染</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (isDispatching) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(</span><br><span class="line">        <span class="string">&#x27;You may not call store.subscribe() while the reducer is executing. &#x27;</span> +</span><br><span class="line">          <span class="string">&#x27;If you would like to be notified after the store has been updated, subscribe from a &#x27;</span> +</span><br><span class="line">          <span class="string">&#x27;component and invoke store.getState() in the callback to access the latest state. &#x27;</span> +</span><br><span class="line">          <span class="string">&#x27;See https://redux.js.org/api-reference/store#subscribelistener for more details.&#x27;</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// Sub-Step1: 设置isSubscribed 为 true</span></span><br><span class="line">    <span class="keyword">let</span> isSubscribed = <span class="literal">true</span></span><br><span class="line">	</span><br><span class="line">    <span class="comment">// Sub-Step2: (1) 浅复制currentListeners[当前的监听列表]，(2) 把监听函数push到监听列表中</span></span><br><span class="line">    <span class="title function_">ensureCanMutateNextListeners</span>()</span><br><span class="line">    nextListeners.<span class="title function_">push</span>(listener)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    	unsubscribe函数：具有取消订阅功能</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">unsubscribe</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="comment">// 只有isSubscribed为true的才能被取消订阅</span></span><br><span class="line">      <span class="keyword">if</span> (!isSubscribed) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">	</span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">      	同理：正在被执行的不能取消订阅</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">      <span class="keyword">if</span> (isDispatching) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(</span><br><span class="line">          <span class="string">&#x27;You may not unsubscribe from a store listener while the reducer is executing. &#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;See https://redux.js.org/api-reference/store#subscribelistener for more details.&#x27;</span></span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">		</span><br><span class="line">      <span class="comment">// sub-step3: 修改isSubscribed 为 false</span></span><br><span class="line">      isSubscribed = <span class="literal">false</span></span><br><span class="line">	</span><br><span class="line">      <span class="comment">// sub-step4: 浅复制监听列表</span></span><br><span class="line">      <span class="title function_">ensureCanMutateNextListeners</span>()</span><br><span class="line">        </span><br><span class="line">      <span class="comment">// sub-step5: 监听完毕，从列表中删除它</span></span><br><span class="line">      <span class="keyword">const</span> index = nextListeners.<span class="title function_">indexOf</span>(listener)</span><br><span class="line">      nextListeners.<span class="title function_">splice</span>(index, <span class="number">1</span>)</span><br><span class="line">      currentListeners = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  	 dispatch函数：[调度函数] 划重点！回顾：这是改变状态的唯一方法！！！！！ 【核心概念2：state只读】</span></span><br><span class="line"><span class="comment">  	</span></span><br><span class="line"><span class="comment">  	dispatch被调用后，reducer将会被调用，store通过转发dispatch(action) 中包含的previousState和action给redeucer，reducer返回newState给store，React component可以通过getState获取newState</span></span><br><span class="line"><span class="comment">  	注意：基本实现仅仅支持普通对象的操作，如果的状态是一个Promise Obserable thunk等等，你需要借助与中间件（middleware） 【后面介绍】</span></span><br><span class="line"><span class="comment">  		参数说明：</span></span><br><span class="line"><span class="comment">  			- action 是一个object，格式为 &#123;type:xxx, data:xxx&#125;</span></span><br><span class="line"><span class="comment">  		返回值说明：</span></span><br><span class="line"><span class="comment">  			- &#123;Object&#125; 为了方便，返回action对象，但是里面的data是经过更改了</span></span><br><span class="line"><span class="comment">  */</span> </span><br><span class="line">    </span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">dispatch</span>(<span class="params">action</span>) &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    isPlainObject函数不贴代码了~看源码的意思，isPlainObject就是用来判断action是不是一个对象</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">isPlainObject</span>(action)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(</span><br><span class="line">        <span class="string">&#x27;Actions must be plain objects. &#x27;</span> +</span><br><span class="line">          <span class="string">&#x27;Use custom middleware for async actions.&#x27;</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    只有定义了action.type才能进行后续操作，所以type不能是undefined</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> action.<span class="property">type</span> === <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(</span><br><span class="line">        <span class="string">&#x27;Actions may not have an undefined &quot;type&quot; property. &#x27;</span> +</span><br><span class="line">          <span class="string">&#x27;Have you misspelled a constant?&#x27;</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    正在被dispatch的action不能传入到reducer中处理</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (isDispatching) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Reducers may not dispatch actions.&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    sub-step1：</span></span><br><span class="line"><span class="comment">    	- 切换isDispatching为true</span></span><br><span class="line"><span class="comment">    	- currentState为currentReducer(currentState, action)处理后返回的state</span></span><br><span class="line"><span class="comment">    		reducer函数举例：</span></span><br><span class="line"><span class="comment">    		function currentReducer(state=&#123;count:0&#125;, action) =&gt; &#123;</span></span><br><span class="line"><span class="comment">    			if (action.type === &#x27;INCREMENT&#x27;) &#123;</span></span><br><span class="line"><span class="comment">    				return &#123;...state, count: state.count+1&#125;</span></span><br><span class="line"><span class="comment">    			&#125;</span></span><br><span class="line"><span class="comment">    		&#125;</span></span><br><span class="line"><span class="comment">    执行完毕后，也就是currentState返回后，</span></span><br><span class="line"><span class="comment">    切换isDispatching为false</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      isDispatching = <span class="literal">true</span></span><br><span class="line">      currentState = <span class="title function_">currentReducer</span>(currentState, action)</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      isDispatching = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    sub-step2：</span></span><br><span class="line"><span class="comment">    	触发listener函数</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">const</span> listeners = (currentListeners = nextListeners)</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; listeners.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> listener = listeners[i]</span><br><span class="line">      <span class="title function_">listener</span>()</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="keyword">return</span> action</span><br><span class="line">  &#125;</span><br><span class="line">	</span><br><span class="line">    </span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  	replaceReducer函数：替换store当前使用的reducer来计算 state</span></span><br><span class="line"><span class="comment">  		不是特别重要，就是替换当前的reducer</span></span><br><span class="line"><span class="comment">  		</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">replaceReducer</span>(<span class="params">nextReducer</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> nextReducer !== <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Expected the nextReducer to be a function.&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    currentReducer = nextReducer</span><br><span class="line"></span><br><span class="line">    <span class="title function_">dispatch</span>(&#123; <span class="attr">type</span>: <span class="title class_">ActionTypes</span>.<span class="property">REPLACE</span> &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">   <span class="comment">/*</span></span><br><span class="line"><span class="comment">	observable函数：</span></span><br><span class="line"><span class="comment">		不重要~暂时不说了</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">observable</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> outerSubscribe = subscribe</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">   </span><br><span class="line">      <span class="title function_">subscribe</span>(<span class="params">observer</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> observer !== <span class="string">&#x27;object&#x27;</span> || observer === <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">&#x27;Expected the observer to be an object.&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">function</span> <span class="title function_">observeState</span>(<span class="params"></span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (observer.<span class="property">next</span>) &#123;</span><br><span class="line">            observer.<span class="title function_">next</span>(<span class="title function_">getState</span>())</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="title function_">observeState</span>()</span><br><span class="line">        <span class="keyword">const</span> unsubscribe = <span class="title function_">outerSubscribe</span>(observeState)</span><br><span class="line">        <span class="keyword">return</span> &#123; unsubscribe &#125;</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      [$$observable]() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">dispatch</span>(&#123; <span class="attr">type</span>: <span class="title class_">ActionTypes</span>.<span class="property">INIT</span> &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    dispatch,</span><br><span class="line">    subscribe,</span><br><span class="line">    getState,</span><br><span class="line">    replaceReducer,</span><br><span class="line">    [$$observable]: observable</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>整个createStore函数可以抽象为下图：</p>
<img src="/2022/08/01/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/redux%E6%BA%90%E7%A0%81_%20Part1_%20createStore/createStore.png" class title="createStore">

<p>接下来就稍微解释下getState dispatch subscribe是如何工作的（省略参数校验部分）</p>
<p>首先，在createStore函数内部维护了以下几个变量，并且初始化：</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">变量1：currentReducer = reducer             | 当前的reducer </span><br><span class="line">变量2：currentState = preloadedState        | 当前的state：可被getState()获取</span><br><span class="line">变量3：currentListeners = []                | 监听列表</span><br><span class="line">变量4：nextListeners = currentListeners     | 监听列表</span><br><span class="line">变量5：isDispatching = false                | 是否正在被dispatch（调度）</span><br></pre></td></tr></table></figure>

<h4 id="getstate"><a href="#getState" class="headerlink" title="getState"></a>getState</h4><blockquote>
<p>函数思路非常的简单，就是获取currentState，也就是当前的状态</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">getState</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    	获取state的时候必须保证这个reducer已经结束工作了，store已经接收到新的state了，才能调用getState</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (isDispatching) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(</span><br><span class="line">        <span class="string">&#x27;You may not call store.getState() while the reducer is executing. &#x27;</span> +</span><br><span class="line">          <span class="string">&#x27;The reducer has already received the state as an argument. &#x27;</span> +</span><br><span class="line">          <span class="string">&#x27;Pass it down from the top reducer instead of reading it from the store.&#x27;</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> currentState</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="dispatch"><a href="#dispatch" class="headerlink" title="dispatch"></a>dispatch</h4><blockquote>
<p>dispatch函数是用于调度action的，思路如下：</p>
<ul>
<li>首先需要确保action的isDispatching为false</li>
<li>切换isDispatching的状态为true，说明这个action要被dispatch了</li>
<li>把action和currentState传入reducer中，并且产出newState【但仍然以currentState命名】</li>
<li>切换isDispatching的状态为false，说明这个action要dispatch结束了</li>
<li>因为state发生了变化，所以触发listener函数，可能有很多listener函数，所以维护了一个列表，需要去遍历这个列表</li>
<li>最终返回action，state已经进行更新了</li>
</ul>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">dispatch</span>(<span class="params">action</span>) &#123;	</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    正在被dispatch的action不能传入到reducer中处理</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (isDispatching) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Reducers may not dispatch actions.&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    sub-step1：</span></span><br><span class="line"><span class="comment">    	- 切换isDispatching为true</span></span><br><span class="line"><span class="comment">    	- currentState为currentReducer(currentState, action)处理后返回的state</span></span><br><span class="line"><span class="comment">    		reducer函数举例：</span></span><br><span class="line"><span class="comment">    		function currentReducer(state=&#123;count:0&#125;, action) =&gt; &#123;</span></span><br><span class="line"><span class="comment">    			if (action.type === &#x27;INCREMENT&#x27;) &#123;</span></span><br><span class="line"><span class="comment">    				return &#123;...state, count: state.count+1&#125;</span></span><br><span class="line"><span class="comment">    			&#125;</span></span><br><span class="line"><span class="comment">    		&#125;</span></span><br><span class="line"><span class="comment">    执行完毕后，也就是currentState返回后，</span></span><br><span class="line"><span class="comment">    切换isDispatching为false</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      isDispatching = <span class="literal">true</span></span><br><span class="line">      currentState = <span class="title function_">currentReducer</span>(currentState, action)</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      isDispatching = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    sub-step2：</span></span><br><span class="line"><span class="comment">    	触发listener函数</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">const</span> listeners = (currentListeners = nextListeners)</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; listeners.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> listener = listeners[i]</span><br><span class="line">      <span class="title function_">listener</span>()</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="keyword">return</span> action</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="subscribe"><a href="#subscribe" class="headerlink" title="subscribe"></a>subscribe</h4><blockquote>
<p>subscribe函数有订阅监听的意思，就是把监听函数放入到列表里面，然后在dispatch的时候去遍历列表</p>
<ul>
<li>首先要保证listener是一个函数，结合dispatch函数，state发生变化的时候，需要执行listener，并且要保证没有在调度中</li>
<li>设置isSubscribed 为 true，表示正在被订阅</li>
<li>把listener加入到nextListeners列表</li>
<li>返回一个取消订阅的函数</li>
</ul>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">subscribe</span>(<span class="params">listener</span>) &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    	listener必须是一个函数</span></span><br><span class="line"><span class="comment">    		举个例子，listener是一个render函数，调用subscribe就会重新渲染某部分的页面（取决于你的render函数需要render什么）</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> listener !== <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Expected the listener to be a function.&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="keyword">if</span> (isDispatching) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(</span><br><span class="line">        <span class="string">&#x27;You may not call store.subscribe() while the reducer is executing. &#x27;</span> +</span><br><span class="line">          <span class="string">&#x27;If you would like to be notified after the store has been updated, subscribe from a &#x27;</span> +</span><br><span class="line">          <span class="string">&#x27;component and invoke store.getState() in the callback to access the latest state. &#x27;</span> +</span><br><span class="line">          <span class="string">&#x27;See https://redux.js.org/api-reference/store#subscribelistener for more details.&#x27;</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// Sub-Step1: 设置isSubscribed 为 true</span></span><br><span class="line">    <span class="keyword">let</span> isSubscribed = <span class="literal">true</span></span><br><span class="line">	</span><br><span class="line">    <span class="comment">// Sub-Step2: (1) 浅复制currentListeners[当前的监听列表]，(2) 把监听函数push到监听列表中</span></span><br><span class="line">    <span class="title function_">ensureCanMutateNextListeners</span>()</span><br><span class="line">    nextListeners.<span class="title function_">push</span>(listener)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    	unsubscribe函数：具有取消订阅功能</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">unsubscribe</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="comment">// 只有isSubscribed为true的才能被取消订阅</span></span><br><span class="line">      <span class="keyword">if</span> (!isSubscribed) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">	</span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">      	同理：正在被执行的不能取消订阅</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">      <span class="keyword">if</span> (isDispatching) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(</span><br><span class="line">          <span class="string">&#x27;You may not unsubscribe from a store listener while the reducer is executing. &#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;See https://redux.js.org/api-reference/store#subscribelistener for more details.&#x27;</span></span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">		</span><br><span class="line">      <span class="comment">// sub-step3: 修改isSubscribed 为 false</span></span><br><span class="line">      isSubscribed = <span class="literal">false</span></span><br><span class="line">	</span><br><span class="line">      <span class="comment">// sub-step4: 浅复制监听列表</span></span><br><span class="line">      <span class="title function_">ensureCanMutateNextListeners</span>()</span><br><span class="line">        </span><br><span class="line">      <span class="comment">// sub-step5: 监听完毕，从列表中删除它</span></span><br><span class="line">      <span class="keyword">const</span> index = nextListeners.<span class="title function_">indexOf</span>(listener)</span><br><span class="line">      nextListeners.<span class="title function_">splice</span>(index, <span class="number">1</span>)</span><br><span class="line">      currentListeners = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<img src="/2022/08/01/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/redux%E6%BA%90%E7%A0%81_%20Part1_%20createStore/%E5%87%BD%E6%95%B0%E6%B5%81%E7%A8%8B.png" class title="函数流程">

<h3 id="实例example_计时器"><a href="#实例example-计时器" class="headerlink" title="实例example_计时器"></a>实例example_计时器</h3><h4 id="html部分"><a href="#html部分" class="headerlink" title="html部分"></a>html部分</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://unpkg.com/redux@latest/dist/redux.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;box&quot;</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">         Click<span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">&quot;value&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;increment&quot;</span>&gt;</span>+<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;decrement&quot;</span>&gt;</span>-<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="js部分"><a href="#js部分" class="headerlink" title="js部分"></a>js部分</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取按钮和展示value的标签</span></span><br><span class="line"><span class="keyword">const</span> spanValue = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;value&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> incrementBtn = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;increment&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> decrementBtn = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;decrement&#x27;</span>);</span><br><span class="line"><span class="comment">// 封装一个reducer函数：纯函数，用于初始化状态和加工状态</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">            传入两个参数state和action</span></span><br><span class="line"><span class="comment">                &#123;</span></span><br><span class="line"><span class="comment">                    type: xxx,</span></span><br><span class="line"><span class="comment">                    data: xxx,</span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">count</span>(<span class="params">state, action</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> state === <span class="string">&#x27;undefined&#x27;</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (action.<span class="property">type</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;INCREMENT&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> state + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;DECREMENT&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> state - <span class="number">1</span>;</span><br><span class="line">        <span class="attr">default</span>:</span><br><span class="line">            <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个store，参数参数为reducer = count，其余两个参数忽略</span></span><br><span class="line"><span class="keyword">const</span> store = <span class="title class_">Redux</span>.<span class="title function_">createStore</span>(count);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(store);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置listener函数动态展示数据</span></span><br><span class="line"><span class="keyword">const</span> listener = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    spanValue.<span class="property">innerText</span> = store.<span class="title function_">getState</span>().<span class="title function_">toString</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 订阅listener</span></span><br><span class="line">store.<span class="title function_">subscribe</span>(listener);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置dispatch</span></span><br><span class="line">incrementBtn.<span class="title function_">addEventListener</span>(<span class="string">&quot;click&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    store.<span class="title function_">dispatch</span>(&#123;<span class="attr">type</span>:<span class="string">&#x27;INCREMENT&#x27;</span>&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">decrementBtn.<span class="title function_">addEventListener</span>(<span class="string">&quot;click&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    store.<span class="title function_">dispatch</span>(&#123;<span class="attr">type</span>:<span class="string">&#x27;DECREMENT&#x27;</span>&#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://superkatrina123.github.io/2022/08/01/%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86/%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86_%E5%8D%81%E5%85%AD%E8%BF%9B%E5%88%B6%E9%A2%9C%E8%89%B2%E7%94%9F%E6%88%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Katrina">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="耿直咸鱼">
      <meta itemprop="description" content="Katrina is trying...">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 耿直咸鱼">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/08/01/%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86/%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86_%E5%8D%81%E5%85%AD%E8%BF%9B%E5%88%B6%E9%A2%9C%E8%89%B2%E7%94%9F%E6%88%90/" class="post-title-link" itemprop="url">数据处理 | 颜色生成（16进制 or rgb）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-08-01 12:32:34 / Modified: 16:01:38" itemprop="dateCreated datePublished" datetime="2022-08-01T12:32:34+08:00">2022-08-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86/" itemprop="url" rel="index"><span itemprop="name">数据处理</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>982</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>1 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="需求1"><a href="#需求1" class="headerlink" title="需求1"></a>需求1</h3><p>封装一个函数，用于生成颜色（16进制或者rgba）</p>
<p>传入boolean为true时随机生成颜色的十六进制值，传入false时生成rgba值</p>
<h3 id="需求2"><a href="#需求2" class="headerlink" title="需求2"></a>需求2</h3><p>封装一个函数，能够随机生成16进制颜色值，要求使用内部rag值的转换</p>
<h4 id="十六进制颜色特点"><a href="#十六进制颜色特点" class="headerlink" title="十六进制颜色特点"></a>十六进制颜色特点</h4><p>0-9 A-F组成（字母不区分大小写）</p>
<h4 id="rgb颜色特点"><a href="#rgb颜色特点" class="headerlink" title="rgb颜色特点"></a>rgb颜色特点</h4><p>rgb包含三个参数，分别代表红色、绿色、蓝色</p>
<p>三个参数取值为0-255或者是0%-100%</p>
<h3 id="实现思路"><a href="#实现思路" class="headerlink" title="实现思路"></a>实现思路</h3><p>利用Math.random()生成随机数进行取值</p>
<h3 id="实现1"><a href="#实现1" class="headerlink" title="实现1"></a>实现1</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">getRandomColor</span>(<span class="params">bool</span>) &#123;</span><br><span class="line">    <span class="comment">// 生成十六进制</span></span><br><span class="line">    <span class="keyword">if</span> (bool) &#123;</span><br><span class="line">        <span class="keyword">let</span> str = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">6</span>; i++) &#123;</span><br><span class="line">            <span class="comment">// Math.random() 取值为0-1   toString(16)转为16进制</span></span><br><span class="line">            <span class="keyword">let</span> c = <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>()*<span class="number">16.</span><span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line">            str += c;</span><br><span class="line">        &#125;;</span><br><span class="line">      	<span class="keyword">return</span> <span class="string">`#<span class="subst">$&#123;str&#125;</span>`</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  <span class="comment">// 生成rgba值</span></span><br><span class="line">        <span class="keyword">let</span> r = <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>()*<span class="number">256</span>);</span><br><span class="line">        <span class="keyword">let</span> g = <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>()*<span class="number">256</span>);</span><br><span class="line">        <span class="keyword">let</span> b = <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>()*<span class="number">256</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">`rgb(<span class="subst">$&#123;r&#125;</span>, <span class="subst">$&#123;g&#125;</span>, <span class="subst">$&#123;b&#125;</span>)`</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="实现2"><a href="#实现2" class="headerlink" title="实现2"></a>实现2</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">getColor16</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> arr = [];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">        <span class="comment">// 生成r/g/b</span></span><br><span class="line">        arr[i] = <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>()*<span class="number">256</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 16进制转换</span></span><br><span class="line">        arr[i] = arr[i] &lt; <span class="number">16</span> ? <span class="string">`0<span class="subst">$&#123;arr[i].toString(<span class="number">16</span>)&#125;</span>`</span> : arr[i].<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;#&#x27;</span> + arr.<span class="title function_">join</span>(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// test </span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">getColor16</span>());   <span class="comment">// #6861b8</span></span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://superkatrina123.github.io/2022/07/31/Demo/todoList/todoList_%E8%AE%BE%E8%AE%A1todoList/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Katrina">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="耿直咸鱼">
      <meta itemprop="description" content="Katrina is trying...">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 耿直咸鱼">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/31/Demo/todoList/todoList_%E8%AE%BE%E8%AE%A1todoList/" class="post-title-link" itemprop="url">todoList_设计todoList</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-07-31 19:55:30" itemprop="dateCreated datePublished" datetime="2022-07-31T19:55:30+08:00">2022-07-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-08-01 01:04:21" itemprop="dateModified" datetime="2022-08-01T01:04:21+08:00">2022-08-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Demo/" itemprop="url" rel="index"><span itemprop="name">Demo</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>1k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>1 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="设计需求"><a href="#设计需求" class="headerlink" title="设计需求"></a>设计需求</h3><p>题目来源：字节校招题_<a target="_blank" rel="noopener" href="https://www.nowcoder.com/question/next?pid=8537237&qid=141038&tid=58964111">todoList设计</a></p>
<p>设计一个TODO List，页面结构如下图所示，要求：</p>
<ol>
<li>使用HTML与CSS完成界面开发</li>
<li>实现添加功能：输入框中可输入任意字符，按回车后将输入字符串添加到下方列表的最后，并清空输入框</li>
<li>实现删除功能：点击列表项后面的“X”号，可以删除该项</li>
<li>实现模糊匹配：在输入框中输入字符后，将当前输入字符串与已添加的列表项进行模糊匹配，将匹配到的结果显示在输入框下方。如匹配不到任何列表项，列表显示空</li>
</ol>
<p><strong>注：以上代码实现需要能在浏览器中正常显示与执行。</strong></p>
<p><img src="https://uploadfiles.nowcoder.com/images/20170905/300557_1504600345720_0731F532C5041A67ADDD38896EFDC6DD" alt="img"></p>
<h3 id="实现思路"><a href="#实现思路" class="headerlink" title="实现思路"></a>实现思路</h3><h4 id="1ui部分"><a href="#（1）UI部分" class="headerlink" title="（1）UI部分"></a>（1）UI部分</h4><ul>
<li>title：h1</li>
<li>输入框：input</li>
<li>list展示：ul li</li>
<li>向下箭头和叉叉：<a target="_blank" rel="noopener" href="https://www.iconfont.cn/">阿里图标矢量库</a></li>
</ul>
<p>CSS自己魔改就行~</p>
<p>可以增加一些小细节，比如hover到input框的时候显示input的边框等~</p>
<h4 id="2操作部分"><a href="#（2）操作部分" class="headerlink" title="（2）操作部分"></a>（2）操作部分</h4><ul>
<li>keydown监听——在input框输入，按下回车键后，动态显示<ul>
<li>input输入——输入内容可以由input.value获取</li>
<li>按下回车键后——回车键的keycode为13</li>
<li>动态显示——动态创建li并为li添加显示value的span和显示叉叉的span作为子节点，最后li作为子节点插入到ul中</li>
</ul>
</li>
<li>keyup监听——模糊搜索<ul>
<li>通过监听keyup事件，获取input.value</li>
<li>获取所有的显示value的span，遍历其内容（spanValue），判断spanValue中是否包含value（通过indexOf判断）</li>
<li>如果包含，则利用正则表达式，把符合的部分替换成红色字体</li>
</ul>
</li>
<li>onclick监听——如果点击叉叉则删除内容<ul>
<li>实际上是删除li</li>
<li>需要找到onclick绑定事件的元素，找到其父元素，并通过父元素的父元素（parentNode）删除子节点即可</li>
<li>在这个案例里面，则是找到显示叉叉的span的li节点，并且通过ul删除li即可（removeChildNode）</li>
</ul>
</li>
</ul>
<h3 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h3><ul>
<li>事件监听<ul>
<li>可监听的事件</li>
<li>event.target指向被监听的元素</li>
</ul>
</li>
<li>获取value<ul>
<li>input.value</li>
<li>标签.innerText和innerHTML的区别</li>
</ul>
</li>
<li>DOM<ul>
<li>获取元素的方式：getElementById getElementsByClassName …</li>
<li>动态创建节点：createElement(标签)</li>
<li>添加元素属性：setAttribute(‘calss’， ’box‘)</li>
<li>dom节点属性：parentNode childNodes</li>
<li>元素classList属性【HTML新增】:看这篇：<a href="https://superkatrina123.github.io/2022/07/29/HTML/DOM_classList%E5%B1%9E%E6%80%A7/">DOM | classList属性</a></li>
<li>…</li>
</ul>
</li>
</ul>
<h3 id="实现效果"><a href="#实现效果" class="headerlink" title="实现效果"></a>实现效果</h3><img src="/2022/07/31/Demo/todoList/todoList_%E8%AE%BE%E8%AE%A1todoList/%E6%95%88%E6%9E%9C.png" class title="效果">

<h3 id="code"><a href="#Code" class="headerlink" title="Code"></a>Code</h3><p><a target="_blank" rel="noopener" href="https://github.com/SuperKatrina123/TODOList_demo">todoList_demo</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://superkatrina123.github.io/2022/07/30/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_%E6%B5%81%E7%A8%8B%E6%A6%82%E8%BF%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Katrina">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="耿直咸鱼">
      <meta itemprop="description" content="Katrina is trying...">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 耿直咸鱼">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/30/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_%E6%B5%81%E7%A8%8B%E6%A6%82%E8%BF%B0/" class="post-title-link" itemprop="url">登录功能 | 流程概述</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-07-30 22:22:04 / Modified: 17:45:35" itemprop="dateCreated datePublished" datetime="2022-07-30T22:22:04+08:00">2022-07-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/React/" itemprop="url" rel="index"><span itemprop="name">React</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Demo/" itemprop="url" rel="index"><span itemprop="name">Demo</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>188</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>1 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h3><p>实现一个登录功能页面</p>
<p>要求如下：</p>
<ol>
<li>能够正常登录登出</li>
<li>规定用户名和密码的格式</li>
</ol>
<h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><ol>
<li>react项目构建——不说了</li>
<li>封装后端接口，实现登录调用和身份验证</li>
<li>antd实现登录页面和注册页面部署</li>
</ol>
<h3 id="封装后端接口"><a href="#封装后端接口" class="headerlink" title="封装后端接口"></a>封装后端接口</h3><p>看这篇：<a href="https://superkatrina123.github.io/2022/07/27/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_node+express+mysql%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E4%BB%A5%E5%8F%8Atoken%E6%A0%A1%E9%AA%8C/">登录功能_node+express+mysql实现用户注册以及token校验</a></p>
<h3 id="登录页面实现与优化思路"><a href="#登录页面实现与优化思路" class="headerlink" title="登录页面实现与优化思路"></a>登录页面实现与优化思路</h3><p>看这篇：<a href="https://superkatrina123.github.io/2022/07/28/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_react+antd%E5%AE%9E%E7%8E%B0%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2/">react+antd实现登录页面</a></p>
<h3 id="bug与问题汇总"><a href="#Bug与问题汇总" class="headerlink" title="Bug与问题汇总"></a>Bug与问题汇总</h3><p>看这篇：<a href="https://superkatrina123.github.io/2022/07/30/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_Bug%E4%B8%8E%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/">Bug与问题汇总</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://superkatrina123.github.io/2022/07/30/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_Bug%E4%B8%8E%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Katrina">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="耿直咸鱼">
      <meta itemprop="description" content="Katrina is trying...">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 耿直咸鱼">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/30/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_Bug%E4%B8%8E%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/" class="post-title-link" itemprop="url">登录功能 | Bug与问题汇总</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-07-30 21:22:04 / Modified: 17:33:40" itemprop="dateCreated datePublished" datetime="2022-07-30T21:22:04+08:00">2022-07-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/React/" itemprop="url" rel="index"><span itemprop="name">React</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Demo/" itemprop="url" rel="index"><span itemprop="name">Demo</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>2.9k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>3 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="问题1跨域"><a href="#问题1：跨域" class="headerlink" title="问题1：跨域"></a>问题1：跨域</h3><p>跨域问题真的太太太太太太重要了！</p>
<img src="/2022/07/30/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_Bug%E4%B8%8E%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/%E8%B7%A8%E5%9F%9F.png" class title="跨域">

<p>一开始我采取CROS的方法解决跨域问题，但是不成功，主要原因在于客户端拒绝添加不安全的请求头也就是Origin，后面我采取配置代理的方式解决跨域的问题</p>
<p>代理原理请看下图：</p>
<img src="/2022/07/30/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_Bug%E4%B8%8E%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/%E4%BB%A3%E7%90%86%E5%8E%9F%E7%90%86.png" class title="代理原理">

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/ setupProxy.js</span></span><br><span class="line"><span class="keyword">const</span> &#123; createProxyMiddleware &#125; = <span class="built_in">require</span>(<span class="string">&#x27;http-proxy-middleware&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">function</span> (<span class="params">app</span>) &#123;</span><br><span class="line">    app.<span class="title function_">use</span>(</span><br><span class="line">        <span class="string">&quot;/api&quot;</span>,</span><br><span class="line">    <span class="title function_">createProxyMiddleware</span>(&#123;</span><br><span class="line">            <span class="comment">//api1是需要转发的请求(所有带有/api1前缀的请求都会转发给5000)</span></span><br><span class="line">            <span class="attr">target</span>: <span class="string">&quot;http://localhost:5000&quot;</span>, <span class="comment">//配置转发目标地址(能返回数据的服务器地址)</span></span><br><span class="line">            <span class="attr">changeOrigin</span>: <span class="literal">true</span>, <span class="comment">//控制服务器接收到的请求头中host字段的值</span></span><br><span class="line">            <span class="comment">/* changeOrigin设置为true时，服务器收到的请求头中的host为：localhost:5000 changeOrigin设置为false时，服务器收到的请求头中的host为：localhost:3000 changeOrigin默认值为false，但我们一般将changeOrigin值设为true */</span></span><br><span class="line">            <span class="attr">pathRewrite</span>: &#123;</span><br><span class="line">            <span class="string">&quot;^/api&quot;</span>: <span class="string">&quot;&quot;</span> &#125;, <span class="comment">//去除请求前缀，保证交给后台服务器的是正常请求地址(必须配置)</span></span><br><span class="line">        &#125;)</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样一来，所有带<code>api</code>前缀的请求都会被转发到目标（target）上，最后请注意把&#x2F;api替换为空字符串</p>
<h3 id="问题2-http-proxy-middleware版本问题导致localhost拒绝"><a href="#问题2：-http-proxy-middleware版本问题导致localhost拒绝" class="headerlink" title="问题2： http-proxy-middleware版本问题导致localhost拒绝"></a>问题2： http-proxy-middleware版本问题导致localhost拒绝</h3><p>一开始，我配置了createProxyMiddleware之后，再次启动react app的时候，竟然！！！localhost拒绝访问！！！【惊了个大呆！】我不信邪，于是我采取最原始的方式，重新创建一个react项目，确定能跑起来之后，把文件一个个复制进去，排查问题在<code>setupProxy.js</code>上，后面发现，不同版本的<code>http-proxy-middleware</code>配置的方式是不同的，主要差别在于<code>createProxyMiddleware</code>引入方式上【高版本按照上面的代码写就好了，顺便提一下，我采用的是<code>&quot;http-proxy-middleware&quot;: &quot;^2.0.6&quot;</code>】</p>
<p>具体看这里：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/tddnr/p/15882820.html">react中配置setupProxy.js后localhost拒绝访问的问题</a></p>
<h3 id="问题3-post请求数据格式问题"><a href="#问题3：-post请求数据格式问题" class="headerlink" title="问题3： post请求数据格式问题"></a>问题3： post请求数据格式问题</h3><p>这个问题困扰了我整整一个下午！！！！</p>
<p>我解决跨域问题之后，不管我怎么输入数据访问一直报错！</p>
<img src="/2022/07/30/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_Bug%E4%B8%8E%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/post.png" class title="post">

<p>我目前的请求配置如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 登录请求（我单独写出来了~）</span></span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&#x27;axios&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; username, password &#125; = values;  <span class="comment">// 解构</span></span><br><span class="line"><span class="keyword">const</span> data = &#123;</span><br><span class="line">    username,</span><br><span class="line">    password,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> response = <span class="title function_">aixos</span>(</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">    url, </span><br><span class="line">    data,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>我百思不得其解，postman能够请求成功，但是我通过登录页面却不能成功，并且状态码为500，说明服务器在执行请求的时候错误，于是开始了排bug之旅</p>
<ul>
<li>首先我想知道服务器有没有接收到我的请求，所以我在服务器写了一个test接口</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/register&#x27;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">    res.<span class="title function_">send</span>(&#123;<span class="attr">msg</span>: <span class="string">&#x27;test接口调用成功！&#x27;</span>&#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>我在前端调用后，返回结果证明，服务器正常返回，接口调用成功</p>
<ul>
<li>既然接口能够调用成功，说明基本功能是没有问题的，所以我开始思考是不是数据格式的问题，我查看了postman数据格式，我发现postman发送请求的时候，数据格式为<code>x-www-form-urlencoded</code></li>
</ul>
<img src="/2022/07/30/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_Bug%E4%B8%8E%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F1.png" class title="数据格式1">

<p>后面了解到，发送post请求有几种常见的数据格式：<a target="_blank" rel="noopener" href="https://blog.51cto.com/zhangchiworkos/2714290"><strong>HTTP POST body常见的四种数据格式</strong></a>，之前有看到过说POST请求的时候必须指定数据格式，当时不以为意，现在终于了解了，发送POST请求的时候需要：</p>
<ul>
<li>设置请求头：<code>&#39;Context-type&#39;: &#39;application/xxx&#39;</code></li>
<li>转换xxx数据格式</li>
</ul>
<p>因为平时最熟悉的莫过于JSON数据，于是乎，我一顿操作之后得到了下面的代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 登录请求（我单独写出来了~）</span></span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&#x27;axios&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; username, password &#125; = values;  <span class="comment">// 解构</span></span><br><span class="line"><span class="keyword">const</span> data = &#123;</span><br><span class="line">    username,</span><br><span class="line">    password,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> response = <span class="title function_">aixos</span>(</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">    url, </span><br><span class="line">    <span class="attr">data</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(data),</span><br><span class="line">    <span class="attr">headers</span>: &#123;</span><br><span class="line">    	<span class="string">&#x27;Context-type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">    &#125;, </span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>我想我的春天要来了，终于能够请求成功了！但是依旧报错500！我不甘心，后端打印了’req.body’，发现了问题</p>
<img src="/2022/07/30/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_Bug%E4%B8%8E%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F2.png" class title="数据格式2">

<p>什么？数据怎么变这样了！</p>
<p>最终只有一位大哥点题了！</p>
<img src="/2022/07/30/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_Bug%E4%B8%8E%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/%E8%A7%A3%E5%86%B31.png" class title="解决1">

<p>最终代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 登录请求（我单独写出来了~）</span></span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&#x27;axios&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> qs <span class="keyword">from</span> <span class="string">&#x27;qs&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; username, password &#125; = values;  <span class="comment">// 解构</span></span><br><span class="line"><span class="keyword">const</span> data = &#123;</span><br><span class="line">    username,</span><br><span class="line">    password,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> response = <span class="title function_">aixos</span>(</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">    url, </span><br><span class="line">    <span class="attr">data</span>: qs.<span class="title function_">stringify</span>(data),</span><br><span class="line">    <span class="attr">headers</span>: &#123;</span><br><span class="line">    	<span class="string">&#x27;Context-type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">    &#125;, </span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>成功~撒花！</p>
<p>血泪教训~</p>
<h3 id="问题3-react-router-dom-v6的一些改变"><a href="#问题3：-React-router-dom-v6的一些改变" class="headerlink" title="问题3： React-router-dom v6的一些改变"></a>问题3： React-router-dom v6的一些改变</h3><p>不得不说，React-router-dom v6的变革是真的大！不过咱也要与时俱进，不可以逃避呀~</p>
<p>多写学习吧！</p>
<h3 id="问题4-组件间通讯"><a href="#问题4：-组件间通讯" class="headerlink" title="问题4： 组件间通讯"></a>问题4： 组件间通讯</h3><p>这个我打算后面单独出一篇博客，到时候贴地址，因为我现在还没完全解决组件通信的问题~</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://superkatrina123.github.io/2022/07/29/HTML/DOM_classList%E5%B1%9E%E6%80%A7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Katrina">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="耿直咸鱼">
      <meta itemprop="description" content="Katrina is trying...">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 耿直咸鱼">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/29/HTML/DOM_classList%E5%B1%9E%E6%80%A7/" class="post-title-link" itemprop="url">DOM | classList属性</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-07-29 13:33:39 / Modified: 14:37:48" itemprop="dateCreated datePublished" datetime="2022-07-29T13:33:39+08:00">2022-07-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/HTML/" itemprop="url" rel="index"><span itemprop="name">HTML</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/DOM/" itemprop="url" rel="index"><span itemprop="name">DOM</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>1.1k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>1 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>HTML5新增了一个classList属性：用于操作元素的className属性，满足基本的增删查</p>
</blockquote>
<p>classList是一个新的集合类型DOMTokenList的实例，具有以下方法：</p>
<ul>
<li>length：表示有几项</li>
<li>item或者中括号取得元素</li>
<li>add(value)：向类名列表中添加指定的字符串值value，如果这个值已经存在，则什么也不做</li>
<li>contains(value)：返回布尔值，表示给定的value 是否存在</li>
<li>remove(value)：从类名列表中删除指定的字符串值value</li>
<li>toggle(value)：如果类名列表中已经存在指定的value，则删除；如果不存在，则添加</li>
</ul>
<p><strong>基本语法</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">element.<span class="property">classList</span>.[method](value)</span><br></pre></td></tr></table></figure>

<p><strong>实例分析</strong></p>
<p>假设现在有一个<code>div</code>，它的class名有：<code>container box selected</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container box selected&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> div = <span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&#x27;div&#x27;</span>)[<span class="number">0</span>];</span></span><br><span class="line"><span class="language-javascript">  <span class="variable language_">console</span>.<span class="title function_">log</span>(div.<span class="property">classList</span>);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol>
<li>获取classList</li>
</ol>
<img src="/2022/07/29/HTML/DOM_classList%E5%B1%9E%E6%80%A7/classList.png" class title="classList">

<p>从上图可以看到，<code>div.classList</code>是一个DOMTokenList的实例，里面分别枚举了div的class属性值，并且包含length和value属性</p>
<ol start="2">
<li>增加disabled类</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">div.<span class="property">classList</span>.<span class="title function_">add</span>(<span class="string">&#x27;disabled&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(div.<span class="property">classList</span>);</span><br></pre></td></tr></table></figure>

<img src="/2022/07/29/HTML/DOM_classList%E5%B1%9E%E6%80%A7/add.png" class title="add">

<ol start="3">
<li>判断是否包含disabled类</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(div.<span class="property">classList</span>.<span class="title function_">contains</span>(<span class="string">&#x27;disabled&#x27;</span>));</span><br></pre></td></tr></table></figure>

<img src="/2022/07/29/HTML/DOM_classList%E5%B1%9E%E6%80%A7/contains.png" class title="contains">

<ol start="4">
<li>删除disabled类</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">div.<span class="property">classList</span>.<span class="title function_">remove</span>(<span class="string">&#x27;disabled&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(div.<span class="property">classList</span>);</span><br></pre></td></tr></table></figure>

<img src="/2022/07/29/HTML/DOM_classList%E5%B1%9E%E6%80%A7/remove.png" class title="remove">

<ol start="5">
<li>切换selected类和user类</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">div.<span class="property">classList</span>.<span class="title function_">toggle</span>(<span class="string">&#x27;selected&#x27;</span>);</span><br><span class="line">div.<span class="property">classList</span>.<span class="title function_">toggle</span>(<span class="string">&#x27;user&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(div.<span class="property">classList</span>);</span><br></pre></td></tr></table></figure>

<img src="/2022/07/29/HTML/DOM_classList%E5%B1%9E%E6%80%A7/toggle.png" class title="toggle">

<p><strong>迭代</strong></p>
<p>classList可以通过for…of来迭代</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> div = <span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&#x27;div&#x27;</span>)[<span class="number">0</span>];</span><br><span class="line">  </span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> name <span class="keyword">of</span> div.<span class="property">classList</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="/2022/07/29/HTML/DOM_classList%E5%B1%9E%E6%80%A7/%E8%BF%AD%E4%BB%A3.png" class title="迭代">

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://superkatrina123.github.io/2022/07/28/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_react+antd%E5%AE%9E%E7%8E%B0%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Katrina">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="耿直咸鱼">
      <meta itemprop="description" content="Katrina is trying...">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 耿直咸鱼">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/28/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_react+antd%E5%AE%9E%E7%8E%B0%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2/" class="post-title-link" itemprop="url">登录功能 | react+antd实现登录页面</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-07-28 21:22:04" itemprop="dateCreated datePublished" datetime="2022-07-28T21:22:04+08:00">2022-07-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-07-30 16:55:40" itemprop="dateModified" datetime="2022-07-30T16:55:40+08:00">2022-07-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/React/" itemprop="url" rel="index"><span itemprop="name">React</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Demo/" itemprop="url" rel="index"><span itemprop="name">Demo</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/antd/" itemprop="url" rel="index"><span itemprop="name">antd</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>5.5k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>5 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="实现需求"><a href="#实现需求" class="headerlink" title="实现需求"></a>实现需求</h2><ul>
<li>登录页面展示</li>
<li>实现注册和登录功能</li>
<li>实现登出功能</li>
<li>登录成功实现页面跳转</li>
<li>短时间不需要再登录</li>
</ul>
<h2 id="实现过程"><a href="#实现过程" class="headerlink" title="实现过程"></a>实现过程</h2><h3 id="创建react项目"><a href="#创建React项目" class="headerlink" title="创建React项目"></a>创建React项目</h3><p>注意：新版React和之前有较大不同</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createRoot &#125; <span class="keyword">from</span> <span class="string">&#x27;react-dom/client&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./App&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// @ts-ignore</span></span><br><span class="line"><span class="keyword">const</span> root = <span class="title function_">createRoot</span>(<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;root&#x27;</span>));</span><br><span class="line">root.<span class="title function_">render</span>(</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">App</span>&gt;</span><span class="tag">&lt;/<span class="name">App</span>&gt;</span></span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 之前的写法是</span></span><br><span class="line"><span class="comment">// ReactDOM.render(&lt;App&gt;&lt;/App&gt;, document.getElementById(&#x27;root&#x27;))</span></span><br></pre></td></tr></table></figure>

<h3 id="前端ui登录界面基本布局"><a href="#前端UI登录界面基本布局" class="headerlink" title="前端UI登录界面基本布局"></a>前端UI登录界面基本布局</h3><blockquote>
<p>这部分我是在pages&#x2F;login&#x2F;index.js完成的</p>
<p>当然不要忘记把组件放到App中去~</p>
</blockquote>
<p>需求：</p>
<ol>
<li><p>完成登录界面基本布局</p>
</li>
<li><p>完成登录表单</p>
</li>
</ol>
<h4 id="实现登录界面"><a href="#实现登录界面" class="headerlink" title="实现登录界面"></a>实现登录界面</h4><p>采用<a target="_blank" rel="noopener" href="https://ant.design/">antd</a>里面的基本布局（header content footer）和表单实现</p>
<p>【不要怕！按照你想的魔改就好了！】</p>
<p>实现效果：</p>
<img src="/2022/07/28/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_react+antd%E5%AE%9E%E7%8E%B0%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2/%E7%99%BB%E5%BD%95%E7%95%8C%E9%9D%A2.png" class title="登录界面">

<h3 id="完善注册页面"><a href="#完善注册页面" class="headerlink" title="完善注册页面"></a>完善注册页面</h3><p>还是采用antd里面的表单进行实现，这里要注意的是，是点击register now!之后，才会切换到注册页面，这里我觉得注册页面单独没什么必要，所以我采取的是把注册页面嵌套在对话框里面，根据自己的喜好啦~</p>
<p>实现效果：</p>
<img src="/2022/07/28/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_react+antd%E5%AE%9E%E7%8E%B0%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2/%E6%B3%A8%E5%86%8C%E7%95%8C%E9%9D%A2.png" class title="注册界面">

<h3 id="接口配置"><a href="#接口配置" class="headerlink" title="接口配置"></a>接口配置</h3><h4 id="promise对axios进行二次封装"><a href="#Promise对axios进行二次封装" class="headerlink" title="Promise对axios进行二次封装"></a>Promise对axios进行二次封装</h4><p>二次封装的好处在于：</p>
<ol>
<li>实现全局axios模块，因为平时发送网络请求多样，有get请求，post请求等等</li>
<li>可以全局部署请求拦截器和响应拦截器</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/api/ajax.js</span></span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&#x27;axios&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> qs <span class="keyword">from</span> <span class="string">&#x27;qs&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;message&#125; <span class="keyword">from</span> <span class="string">&#x27;antd&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> instance = axios.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">timeout</span>: <span class="number">10000</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加请求拦截器</span></span><br><span class="line">instance.<span class="property">interceptors</span>.<span class="property">request</span>.<span class="title function_">use</span>(<span class="function"><span class="params">config</span> =&gt;</span> &#123; </span><br><span class="line">    <span class="comment">// console.log(&#x27;config&#x27;, config);</span></span><br><span class="line">    config.<span class="property">headers</span>.<span class="property">Authorization</span> = sessionStorage.<span class="title function_">getItem</span>(<span class="string">&#x27;token&#x27;</span>) || <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> config;</span><br><span class="line">&#125;, <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(err);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加响应拦截器</span></span><br><span class="line">instance.<span class="property">interceptors</span>.<span class="property">response</span>.<span class="title function_">use</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(response);</span><br><span class="line">    <span class="comment">// 我后端是权限校验成功</span></span><br><span class="line">    <span class="keyword">if</span> (response.<span class="property">data</span>.<span class="property">msg</span> === <span class="string">&#x27;权限校验成功！&#x27;</span>) &#123;</span><br><span class="line">        <span class="variable language_">window</span>.<span class="property">history</span>.<span class="title function_">pushState</span>(<span class="literal">null</span>, <span class="string">&#x27;home&#x27;</span>,<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(response.<span class="property">data</span>.<span class="property">msg</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err.<span class="property">response</span>) &#123;</span><br><span class="line">        <span class="comment">// token失效，回到登录页面</span></span><br><span class="line">        <span class="variable language_">window</span>.<span class="property">history</span>.<span class="title function_">pushState</span>(<span class="literal">null</span>, <span class="string">&#x27;login&#x27;</span>,<span class="string">&#x27;/login&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">ajax</span>(<span class="params">method=<span class="string">&#x27;GET&#x27;</span>, url, data=&#123;&#125;, config</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> promise;</span><br><span class="line">        <span class="comment">// 执行异步ajax请求</span></span><br><span class="line">        <span class="keyword">if</span> (method === <span class="string">&#x27;GET&#x27;</span>) &#123;</span><br><span class="line">            promise = <span class="title function_">instance</span>(&#123;</span><br><span class="line">                <span class="attr">method</span>:<span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">                url, </span><br><span class="line">                <span class="attr">params</span>:data,</span><br><span class="line">                ...config,</span><br><span class="line">            &#125;)  <span class="comment">// params配置指定的是query参数</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            promise = <span class="title function_">axios</span>(&#123;</span><br><span class="line">                <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">                url, </span><br><span class="line">                <span class="attr">data</span>: qs.<span class="title function_">stringify</span>(data),</span><br><span class="line">                <span class="attr">headers</span>: &#123;</span><br><span class="line">                  <span class="string">&#x27;Context-type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">                  <span class="string">&#x27;Authorization&#x27;</span>: <span class="string">&#x27;Bearer &#x27;</span> + <span class="variable language_">window</span>.<span class="property">sessionStorage</span>.<span class="title function_">getItem</span>(<span class="string">&#x27;token&#x27;</span>),</span><br><span class="line">                &#125;, </span><br><span class="line">                ...config,</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        promise.<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 如果成功了，调用resolve(response.data)</span></span><br><span class="line">            <span class="title function_">resolve</span>(response);</span><br><span class="line">        &#125;).<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;    <span class="comment">// 对所有ajax请求出错做统一处理，这样外层就不用再处理错误了</span></span><br><span class="line">            <span class="comment">// 如果失败了，提示请求后台出错</span></span><br><span class="line">            <span class="title function_">reject</span>(message.<span class="title function_">error</span>(error));</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="写接口"><a href="#写接口" class="headerlink" title="写接口"></a>写接口</h4><p>接口主要根据写的后端接口配</p>
<h4 id="解决跨域问题"><a href="#解决跨域问题" class="headerlink" title="解决跨域问题"></a>解决跨域问题</h4><img src="/2022/07/28/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_react+antd%E5%AE%9E%E7%8E%B0%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2/%E8%B7%A8%E5%9F%9F.png" class title="跨域">

<p>一开始，我采用CORS解决<a href="https://superkatrina123.github.io/2022/07/13/%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82/%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82_%E8%B7%A8%E5%9F%9F/?highlight=%E8%B7%A8%E5%9F%9F">跨域</a></p>
<h5 id="报错问题-refused-to-set-unsafe-header-origin"><a href="#报错问题：-Refused-to-set-unsafe-header-“Origin”" class="headerlink" title="报错问题： Refused to set unsafe header “Origin”"></a>报错问题： Refused to set unsafe header “Origin”</h5><img src="/2022/07/28/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_react+antd%E5%AE%9E%E7%8E%B0%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2/%E6%8A%A5%E9%94%991.png" class title="报错1">

<blockquote>
<p>这说明设置的Origin字段是无效的，不管我设置什么或者不设置这个字段时查看Origin字段时它的值都是null，有人说那个Origin字段本来就应该是浏览器来设置的，自己设置不安全</p>
</blockquote>
<p>所以导致我在服务端写了Access-Control-Allow-Origin一直还是没用，所以后面采用了代理的方式进行跨域</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/setupProxy.js</span></span><br><span class="line"><span class="keyword">const</span> &#123; createProxyMiddleware &#125; = <span class="built_in">require</span>(<span class="string">&#x27;http-proxy-middleware&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">function</span> (<span class="params">app</span>) &#123;</span><br><span class="line">    app.<span class="title function_">use</span>(</span><br><span class="line">        <span class="string">&quot;/api&quot;</span>,</span><br><span class="line">    <span class="title function_">createProxyMiddleware</span>(&#123;</span><br><span class="line">            <span class="comment">//api1是需要转发的请求(所有带有/api1前缀的请求都会转发给5000)</span></span><br><span class="line">            <span class="attr">target</span>: <span class="string">&quot;http://localhost:5000&quot;</span>, <span class="comment">//配置转发目标地址(能返回数据的服务器地址)</span></span><br><span class="line">            <span class="attr">changeOrigin</span>: <span class="literal">true</span>, <span class="comment">//控制服务器接收到的请求头中host字段的值</span></span><br><span class="line">            <span class="comment">/* changeOrigin设置为true时，服务器收到的请求头中的host为：localhost:5000 changeOrigin设置为false时，服务器收到的请求头中的host为：localhost:3000 changeOrigin默认值为false，但我们一般将changeOrigin值设为true */</span></span><br><span class="line">            <span class="attr">pathRewrite</span>: &#123;</span><br><span class="line">            <span class="string">&quot;^/api&quot;</span>: <span class="string">&quot;&quot;</span> &#125;, <span class="comment">//去除请求前缀，保证交给后台服务器的是正常请求地址(必须配置)</span></span><br><span class="line">        &#125;)</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终接口代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/api/index.js</span></span><br><span class="line"><span class="keyword">import</span> ajax <span class="keyword">from</span> <span class="string">&#x27;./ajax&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">reqRegister</span> = (<span class="params">username, password</span>) =&gt; <span class="title function_">ajax</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/api/register&#x27;</span>, &#123;username, password&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 登录</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">reqLogin</span> = (<span class="params">username, password</span>) =&gt; <span class="title function_">ajax</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/api/login&#x27;</span>, &#123;username, password&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 权限校验 </span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">reqAuth</span> = (<span class="params"></span>) =&gt; <span class="title function_">ajax</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/api/auth&#x27;</span>, &#123;&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="路由部署"><a href="#路由部署" class="headerlink" title="路由部署"></a>路由部署</h3><p>实现效果：</p>
<ol>
<li>访问home页面，如果没有登录，重定向到login页面</li>
<li>登录成功后跳转到home页面</li>
<li>home页面设置登出</li>
<li>设置注册页面，可以提交表单信息</li>
</ol>
<blockquote>
<p>好久没写router了，此时最新的是<code>&quot;react-router-dom&quot;: &quot;^6.3.0&quot;</code>，发现更新了不少~</p>
<p>不要因为不熟悉就卸载下载旧版本呀【以前的我经常这么干！哈哈哈哈哈】</p>
<p>还是要不断学习！拥抱变化！</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7040289734836355085">(干货) 全网最全 react-router-dom v6.0学习指南</a></p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/router/index.js</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Home</span> <span class="keyword">from</span> <span class="string">&#x27;../pages/home&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Login</span> <span class="keyword">from</span> <span class="string">&#x27;../pages/login&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> routes = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="title class_">Home</span>,</span><br><span class="line">        <span class="attr">exact</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;/login&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="title class_">Login</span>,</span><br><span class="line">    &#125;</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/App.js</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">BrowserRouter</span>, <span class="title class_">Routes</span>, <span class="title class_">Route</span>, <span class="title class_">Navigate</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;react-router-dom&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; routes &#125; <span class="keyword">from</span> <span class="string">&#x27;./router&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">BrowserRouter</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Routes</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;</span></span><br><span class="line"><span class="language-xml">          routes.map((route) =&gt; (</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Route</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">              <span class="attr">key</span>=<span class="string">&#123;route.path&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">              <span class="attr">path</span>=<span class="string">&#123;route.path&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">              //<span class="attr">exact</span>=<span class="string">&#123;route.exact&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">              <span class="attr">element</span>=<span class="string">&#123;</span>&lt;<span class="attr">route.component</span>/&gt;</span>&#125;</span></span><br><span class="line"><span class="language-xml">            &gt;<span class="tag">&lt;/<span class="name">Route</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          ))</span></span><br><span class="line"><span class="language-xml">        &#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&#x27;*&#x27;</span> <span class="attr">element</span>=<span class="string">&#123;</span>&lt;<span class="attr">Navigate</span> <span class="attr">to</span>=<span class="string">&#x27;/login&#x27;</span>/&gt;</span>&#125;&gt;<span class="tag">&lt;/<span class="name">Route</span>&gt;</span>   </span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">Routes</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">BrowserRouter</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样能够实现路由正常跳转了~</p>
<h3 id="接口调用"><a href="#接口调用" class="headerlink" title="接口调用"></a>接口调用</h3><p>接口主要用于实现登录功能，所以基本是下面的流程：</p>
<ol>
<li>输入用户名和密码，登录（发送登录请求）</li>
<li>根据后端返回的结果判断是哪种状态<ol>
<li>登录成功：跳转到主页（’&#x2F;‘），把返回的token存在sessionStorage里面</li>
<li>用户不存在：停留在原页面，提示用户不存在<ol>
<li>用户点击register now!之后，弹出注册页面，用户输入信息后，注册（发送注册请求）</li>
</ol>
</li>
<li>密码错误：停留在原页面，提示密码错误，用户需要再次输入</li>
</ol>
</li>
</ol>
<p>具体看&#x2F;src&#x2F;login部分源码吧~</p>
<p>值得注意的是：跳转页面采用<code>useNavigate</code></p>
<h3 id="自动校验token"><a href="#自动校验token" class="headerlink" title="自动校验token"></a>自动校验token</h3><p>我这里采取的是，在login页面渲染的时候发送自动校验的请求，目前只想到这个~</p>
<h3 id="登出页面"><a href="#登出页面" class="headerlink" title="登出页面"></a>登出页面</h3><p>我主要设置在home组件里面，登出就很简单，要做的就是：</p>
<ol>
<li>删除sessionStorage里面的token</li>
<li>跳转到登录页面（非必要！）</li>
</ol>
<h2 id="优化思考"><a href="#优化思考" class="headerlink" title="优化思考"></a>优化思考</h2><h3 id="优化1-考虑设置token的有效时长"><a href="#优化1：-考虑设置token的有效时长" class="headerlink" title="优化1： 考虑设置token的有效时长"></a>优化1： 考虑设置token的有效时长</h3><h3 id="优化2-考虑组件间传值"><a href="#优化2：-考虑组件间传值" class="headerlink" title="优化2： 考虑组件间传值"></a>优化2： 考虑组件间传值</h3><p>比如用户登陆后可以在home组件访问到是谁登录的，欢迎<code>XXX</code>诸如此类</p>
<h2 id="知识点总结"><a href="#知识点总结" class="headerlink" title="知识点总结"></a>知识点总结</h2><ul>
<li>登录流程</li>
<li><code>antd</code>组件应用</li>
<li><code>axios</code>请求相关：封装、请求头设置、发请求、拦截器等</li>
<li>跨域</li>
<li>react-router：基本配置，跳转路由</li>
<li>token相关</li>
<li>cookie sessionStorage localStorage</li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://ant.design/">antd</a></p>
<p><a target="_blank" rel="noopener" href="https://styled-components.com/">styled-components</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7040289734836355085">(干货) 全网最全 react-router-dom v6.0学习指南</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://superkatrina123.github.io/2022/07/27/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_node+express+mysql%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E4%BB%A5%E5%8F%8Atoken%E6%A0%A1%E9%AA%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Katrina">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="耿直咸鱼">
      <meta itemprop="description" content="Katrina is trying...">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 耿直咸鱼">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/27/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_node+express+mysql%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E4%BB%A5%E5%8F%8Atoken%E6%A0%A1%E9%AA%8C/" class="post-title-link" itemprop="url">登录功能 | node+express+mysql实现用户注册以及token校验</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-07-27 21:22:04" itemprop="dateCreated datePublished" datetime="2022-07-27T21:22:04+08:00">2022-07-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-07-30 16:55:30" itemprop="dateModified" datetime="2022-07-30T16:55:30+08:00">2022-07-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Demo/" itemprop="url" rel="index"><span itemprop="name">Demo</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/node/" itemprop="url" rel="index"><span itemprop="name">node</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>6.1k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>6 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="实现需求"><a href="#实现需求" class="headerlink" title="实现需求"></a>实现需求</h2><ul>
<li>登录</li>
<li>注册</li>
<li>权限校验</li>
</ul>
<h2 id="实现过程"><a href="#实现过程" class="headerlink" title="实现过程"></a>实现过程</h2><ul>
<li>客户端使用用户名和密码请求登录</li>
<li>服务端收到请求后验证是否登录成功<ul>
<li>成功：返回一个token给客户端</li>
<li>失败：提示失败信息</li>
</ul>
</li>
<li>客户端收到token后存储token（token采用jwt进行加密，而不是普通的base64）</li>
<li>每次发起请求时将token发给服务端</li>
<li>服务端接收到请求后，token的合法性<ul>
<li>成功：返回客户端所需数据</li>
<li>失败：返回验证失败的信息</li>
</ul>
</li>
</ul>
<h2 id="流程图解"><a href="#流程图解" class="headerlink" title="流程图解"></a>流程图解</h2><img src="/2022/07/27/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_node+express+mysql%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E4%BB%A5%E5%8F%8Atoken%E6%A0%A1%E9%AA%8C/%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C%E6%B5%81%E7%A8%8B.png" class title="登录注册流程">

<img src="/2022/07/27/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_node+express+mysql%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E4%BB%A5%E5%8F%8Atoken%E6%A0%A1%E9%AA%8C/JWT.png" class title="JWT">

<h2 id="实现流程"><a href="#实现流程" class="headerlink" title="实现流程"></a>实现流程</h2><h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><ul>
<li>node</li>
<li>express</li>
<li>mysql</li>
</ul>
<h4 id="初始化项目"><a href="#初始化项目" class="headerlink" title="初始化项目"></a>初始化项目</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm init <span class="literal">-y</span></span><br></pre></td></tr></table></figure>

<h4 id="安装express"><a href="#安装express" class="headerlink" title="安装express"></a>安装express</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i express</span><br></pre></td></tr></table></figure>

<h4 id="启动node服务_新建appjs文件"><a href="#启动node服务-新建app-js文件" class="headerlink" title="启动node服务_新建app.js文件"></a>启动node服务_新建app.js文件</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.js</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    port: 4000</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">4000</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;serve is running on port: 4000&#x27;</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/express-js-app-listen-function/">app.listen参数</a></p>
<p>启动端口</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node app.js </span><br></pre></td></tr></table></figure>

<img src="/2022/07/27/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_node+express+mysql%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E4%BB%A5%E5%8F%8Atoken%E6%A0%A1%E9%AA%8C/%E5%90%AF%E5%8A%A8node.png" class title="启动node">

<h3 id="连接mysql"><a href="#连接MySQL" class="headerlink" title="连接MySQL"></a>连接MySQL</h3><p>下面的过程都可以看文档：<a target="_blank" rel="noopener" href="https://www.sequelize.com.cn/">sequelize文档</a></p>
<h4 id="安装sequelize和mysql"><a href="#安装Sequelize和MySql" class="headerlink" title="安装Sequelize和MySql"></a>安装Sequelize和MySql</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm i sequelize <span class="comment"># 这将安装最新版本的 Sequelize</span></span><br><span class="line">npm i mysql2 <span class="comment"># MySQL</span></span><br></pre></td></tr></table></figure>

<h4 id="连接到数据库_databasex2finitjs"><a href="#连接到数据库-database-x2F-init-js" class="headerlink" title="连接到数据库_database&#x2F;init.js"></a>连接到数据库_database&#x2F;init.js</h4><p>要连接到数据库,必须创建一个 Sequelize 实例. 这可以通过将连接参数分别传递到 Sequelize 构造函数或通过传递一个连接 URI 来完成</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// database/init.js</span></span><br><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">Sequelize</span> &#125; = <span class="built_in">require</span>(<span class="string">&#x27;sequelize&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> sequelize= <span class="keyword">new</span> <span class="title class_">Sequelize</span>(<span class="string">&#x27;数据库名称&#x27;</span>, <span class="string">&#x27;root&#x27;</span>, <span class="string">&#x27;你的密码&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">host</span>: <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">    <span class="attr">port</span>: <span class="string">&#x27;3306&#x27;</span>,</span><br><span class="line">    <span class="attr">dialect</span>: <span class="string">&#x27;mysql&#x27;</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="测试连接"><a href="#测试连接" class="headerlink" title="测试连接"></a>测试连接</h4><p>引入到app.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;./database/init&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>你可以使用 <code>.authenticate()</code> 函数测试连接是否正常：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="keyword">await</span> sequelize.<span class="title function_">authenticate</span>();</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Connection has been established successfully.&#x27;</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Unable to connect to the database:&#x27;</span>, error);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="关闭连接"><a href="#关闭连接" class="headerlink" title="关闭连接"></a>关闭连接</h4><p>默认情况下,<code>Sequelize</code> 将保持连接打开状态,并对所有查询使用相同的连接. 如果你需要关闭连接,请调用 <code>sequelize.close()</code>(这是异步的并返回一个 Promise).</p>
<h4 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// database/init.js</span></span><br><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">Sequelize</span> &#125; = <span class="built_in">require</span>(<span class="string">&#x27;sequelize&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> sequelize= <span class="keyword">new</span> <span class="title class_">Sequelize</span>(<span class="string">&#x27;test_login&#x27;</span>, <span class="string">&#x27;root&#x27;</span>, <span class="string">&#x27;yyy674531&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">host</span>: <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="attr">port</span>: <span class="string">&#x27;3306&#x27;</span>,</span><br><span class="line">    <span class="attr">dialect</span>: <span class="string">&#x27;mysql&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试连接</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    sequelize.<span class="title function_">authenticate</span>();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Connection has been established successfully.&#x27;</span>);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Unable to connect to the database:&#x27;</span>, error);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span>  = &#123;<span class="title class_">Sequelize</span>, sequelize&#125;;  <span class="comment">// 这里导出，下面有用！</span></span><br></pre></td></tr></table></figure>

<h3 id="同步表模型"><a href="#同步表模型" class="headerlink" title="同步表模型"></a>同步表模型</h3><h4 id="创建模型实例_databasex2fmodelsx2fuserjs"><a href="#创建模型实例-database-x2F-models-x2F-User-js" class="headerlink" title="创建模型实例_database&#x2F;models&#x2F;User.js"></a>创建模型实例_database&#x2F;models&#x2F;User.js</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// database/models/User.js</span></span><br><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">Op</span>, <span class="title class_">Model</span>, <span class="title class_">DataTypes</span> &#125; = <span class="built_in">require</span>(<span class="string">&#x27;sequelize&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">Sequelize</span>, sequelize &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../init.js&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">User</span> = sequelize.<span class="title function_">define</span>(<span class="string">&#x27;users_info&#x27;</span>, &#123;</span><br><span class="line">    <span class="comment">// 应用属性： 禁止null 唯一约束 验证器</span></span><br><span class="line">    <span class="attr">username</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">DataTypes</span>.<span class="property">STRING</span>,  </span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,   <span class="comment">// 1. 禁止 null 值</span></span><br><span class="line">        <span class="attr">unique</span>: <span class="literal">true</span>,   <span class="comment">// 2. 唯一约束</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">password</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">DataTypes</span>.<span class="property">STRING</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="comment">// validate: &#123;    // 3. 验证器</span></span><br><span class="line">        <span class="comment">//    is: /^[0-9a-f]&#123;64&#125;$/i</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将模型与数据库同步</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    注意：如果表已经存在，使用&#123;force: true&#125;将该表删除 </span></span><br><span class="line"><span class="comment">*/</span> </span><br><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">sync</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;user表模型已经同步&#x27;</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<h4 id="导出到appjs并启动"><a href="#导出到app-js并启动" class="headerlink" title="导出到app.js并启动"></a>导出到app.js并启动</h4><img src="/2022/07/27/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_node+express+mysql%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E4%BB%A5%E5%8F%8Atoken%E6%A0%A1%E9%AA%8C/%E6%96%B0%E5%BB%BAUser.png" class title="新建User">

<h3 id="实现路由部署准备"><a href="#实现路由部署（准备）" class="headerlink" title="实现路由部署（准备）"></a>实现路由部署（准备）</h3><p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/learn/Server-side/Express_Nodejs/routes">Express 教程 4：路由和控制器</a></p>
<h4 id="路由部署_expressrouter"><a href="#路由部署-express-Router" class="headerlink" title="路由部署_express.Router"></a>路由部署_express.Router</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// router/user.js</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> router = express.<span class="title class_">Router</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// middleware that is specific to this router</span></span><br><span class="line"><span class="comment">// router.use(function timeLog(req, res, next) &#123;</span></span><br><span class="line"><span class="comment">//     console.log(&#x27;Time:&#x27;, Date.now());</span></span><br><span class="line"><span class="comment">//     next();</span></span><br><span class="line"><span class="comment">// &#125;);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册</span></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/home&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    res.<span class="title function_">send</span>(&#123;<span class="attr">msg</span>: <span class="string">&#x27;Welcome!&#x27;</span>&#125;);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router;</span><br></pre></td></tr></table></figure>

<h4 id="引入使用"><a href="#引入使用" class="headerlink" title="引入使用"></a>引入使用</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.js</span></span><br><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">&#x27;./router/user&#x27;</span>);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">urlencoded</span>(&#123;<span class="attr">extended</span>: <span class="literal">false</span>&#125;));</span><br><span class="line">app.<span class="title function_">use</span>(<span class="string">&#x27;/user&#x27;</span>, router);</span><br></pre></td></tr></table></figure>

<h4 id="postman测试"><a href="#postman测试" class="headerlink" title="postman测试"></a>postman测试</h4><img src="/2022/07/27/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_node+express+mysql%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E4%BB%A5%E5%8F%8Atoken%E6%A0%A1%E9%AA%8C/%E6%B5%8B%E8%AF%951.png" class title="测试1">

<h3 id="实现注册功能"><a href="#实现注册功能" class="headerlink" title="实现注册功能"></a>实现注册功能</h3><h4 id="路由部署"><a href="#路由部署" class="headerlink" title="路由部署"></a>路由部署</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// router/user.js</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/register&#x27;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;username, password&#125; = req.<span class="property">body</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(username);  <span class="comment">// postman测试能够拿到username信息</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<img src="/2022/07/27/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_node+express+mysql%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E4%BB%A5%E5%8F%8Atoken%E6%A0%A1%E9%AA%8C/%E6%B5%8B%E8%AF%952.png" class title="测试2">

<img src="/2022/07/27/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_node+express+mysql%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E4%BB%A5%E5%8F%8Atoken%E6%A0%A1%E9%AA%8C/%E6%B5%8B%E8%AF%952-1.png" class title="测试2-1">

<p>可以看到控制台已经打印了~说明能够获取到username的信息</p>
<blockquote>
<p>注册功能说明：</p>
<p>服务器获取到浏览器传过来的username</p>
<p>首先检验是否存在这个username，如果存在就返回“该用户已经存在，请直接登录”</p>
<p>如果不存在，再进行创建</p>
<ol>
<li>去哪里检验——MySQL数据库里面</li>
<li>怎么创建——利用MySQL的create</li>
</ol>
<p>接下来会详细说明</p>
</blockquote>
<h4 id="用户查询"><a href="#用户查询" class="headerlink" title="用户查询"></a>用户查询</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// router/user.js</span></span><br><span class="line"><span class="comment">// 注册</span></span><br><span class="line"><span class="keyword">const</span> bcryptjs = <span class="built_in">require</span>(<span class="string">&#x27;bcryptjs&#x27;</span>);</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/register&#x27;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;username, password&#125; = req.<span class="property">body</span>;</span><br><span class="line">    <span class="comment">// console.log(username);  // postman测试能够拿到username信息</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用户查询</span></span><br><span class="line">    <span class="keyword">const</span> model = <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">findOne</span>(&#123;<span class="attr">where</span>: &#123;<span class="attr">username</span>: username&#125;&#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (model) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">send</span>(&#123;<span class="attr">msg</span>: <span class="string">&#x27;该用户已经存在，请直接登录！&#x27;</span>&#125;)</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">create</span>(&#123;username, <span class="attr">password</span>:bcryptjs.<span class="title function_">hashSync</span>(password, <span class="number">5</span>)&#125;); <span class="comment">// 加密</span></span><br><span class="line">        <span class="comment">// console.log(user.dataValues);</span></span><br><span class="line">        res.<span class="title function_">send</span>(&#123;<span class="attr">msg</span>: <span class="string">&#x27;注册成功！&#x27;</span>&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>postman测试：创建成功~</p>
<img src="/2022/07/27/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_node+express+mysql%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E4%BB%A5%E5%8F%8Atoken%E6%A0%A1%E9%AA%8C/%E6%B5%8B%E8%AF%953.png" class title="测试3">

<p>查询数据库：创建成功~</p>
<img src="/2022/07/27/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_node+express+mysql%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E4%BB%A5%E5%8F%8Atoken%E6%A0%A1%E9%AA%8C/%E6%B3%A8%E5%86%8C1.png" class title="注册1">

<p>当我再次用同样的username进行注册请求的时候，返回结果为：<strong>该用户已经存在，请直接登录！</strong></p>
<img src="/2022/07/27/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_node+express+mysql%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E4%BB%A5%E5%8F%8Atoken%E6%A0%A1%E9%AA%8C/%E6%B5%8B%E8%AF%952-2.png" class title="测试2-2">

<p>注册功能验证成功~</p>
<h3 id="实现登录功能"><a href="#实现登录功能" class="headerlink" title="实现登录功能"></a>实现登录功能</h3><blockquote>
<p>登录功能说明：</p>
<p>通过发送username和password进行登录</p>
<ul>
<li><p>如果uername不存在，就返回“该用户不存在，请先注册”</p>
</li>
<li><p>如果username存在，要先进行密码校验</p>
<ul>
<li>密码校验不成功——返回“密码错误”</li>
<li>密码校验成功——返回token</li>
</ul>
</li>
</ul>
</blockquote>
<h4 id="登录功能部署"><a href="#登录功能部署" class="headerlink" title="登录功能部署"></a>登录功能部署</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// router/user.js</span></span><br><span class="line"><span class="comment">// 登录功能</span></span><br><span class="line"><span class="keyword">const</span> bcryptjs = <span class="built_in">require</span>(<span class="string">&#x27;bcryptjs&#x27;</span>);</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/login&#x27;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;username, password&#125; = req.<span class="property">body</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(req.<span class="property">body</span>);</span><br><span class="line">    <span class="keyword">const</span> model = <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">findOne</span>(&#123;<span class="attr">where</span>: &#123;<span class="attr">username</span>: username&#125;&#125;);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(model);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!model) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">send</span>(&#123;<span class="attr">msg</span>: <span class="string">&#x27;该用户不存在，请先注册！&#x27;</span>&#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 如果存在username就要进行密码校验</span></span><br><span class="line">        <span class="keyword">const</span> passwordValid = bcryptjs.<span class="title function_">compareSync</span>(password, model.<span class="property">dataValues</span>.<span class="property">password</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!passwordValid) &#123;</span><br><span class="line">            <span class="keyword">return</span> res.<span class="title function_">send</span>(&#123;<span class="attr">msg</span>: <span class="string">&#x27;密码错误！&#x27;</span>&#125;)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           res.<span class="title function_">send</span>(&#123;<span class="attr">msg</span>: <span class="string">&#x27;登录成功！&#x27;</span>&#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>正确输入用户名和密码：</p>
<img src="/2022/07/27/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_node+express+mysql%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E4%BB%A5%E5%8F%8Atoken%E6%A0%A1%E9%AA%8C/%E7%99%BB%E5%BD%951.png" class title="登录1">

<p>输入错误密码：</p>
<img src="/2022/07/27/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_node+express+mysql%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E4%BB%A5%E5%8F%8Atoken%E6%A0%A1%E9%AA%8C/%E7%99%BB%E5%BD%952.png" class title="登录2">

<p>输入未注册用户名：</p>
<img src="/2022/07/27/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_node+express+mysql%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E4%BB%A5%E5%8F%8Atoken%E6%A0%A1%E9%AA%8C/%E7%99%BB%E5%BD%953.png" class title="登录3">

<h4 id="token生成及返回_jsonwebtoken"><a href="#token生成及返回-jsonwebtoken" class="headerlink" title="token生成及返回_jsonwebtoken"></a>token生成及返回_jsonwebtoken</h4><p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000009494020">jwt中文文档</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jwt.<span class="title function_">sign</span>(payload, secretOrPrivateKey, [options, callback]);</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// router/user.js</span></span><br><span class="line"><span class="keyword">const</span> token = jwt.<span class="title function_">sign</span>(&#123;username&#125;, <span class="string">&#x27;ccken&#x27;</span>)</span><br><span class="line">res.<span class="title function_">send</span>(&#123;token&#125;)</span><br></pre></td></tr></table></figure>

<img src="/2022/07/27/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_node+express+mysql%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E4%BB%A5%E5%8F%8Atoken%E6%A0%A1%E9%AA%8C/token.png" class title="token">

<h3 id="实现权限校验"><a href="#实现权限校验" class="headerlink" title="实现权限校验"></a>实现权限校验</h3><blockquote>
<p>权限校验说明：</p>
<ol>
<li>token包含在请求头里面，所以第一步我们要获取token<ul>
<li>如果没有token说明前面没有登录过或者是登录已经失效，返回“请登录”</li>
</ul>
</li>
<li>利用token 密钥 和 payload对token进行解析</li>
<li>对解析结果进行校验查询<ul>
<li>如果查询结果为空，返回’请注册‘</li>
<li>如果不为空，则说明“权限校验成功！”</li>
</ul>
</li>
</ol>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// router/user.js</span></span><br><span class="line"><span class="comment">// 权限校验</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/auth&#x27;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 获取token，token是在请求头里面的</span></span><br><span class="line">    <span class="keyword">const</span> token =  <span class="title class_">String</span>(req.<span class="property">headers</span>.<span class="property">authorization</span>).<span class="title function_">split</span>(<span class="string">&#x27; &#x27;</span>).<span class="title function_">pop</span>();</span><br><span class="line">    <span class="comment">// 如果没有token说明前面没有登录过或者是登录已经失效</span></span><br><span class="line">    <span class="keyword">if</span> (!token) <span class="keyword">return</span> res.<span class="title function_">send</span>(&#123;<span class="attr">msg</span>: <span class="string">&#x27;请登录！&#x27;</span>&#125;)</span><br><span class="line">    <span class="comment">// 根据密钥和字段解析token</span></span><br><span class="line">    <span class="keyword">const</span> &#123;username&#125; = jwt.<span class="title function_">verify</span>(token, <span class="string">&#x27;ccken&#x27;</span>);   <span class="comment">// 之前使用username进行注册的</span></span><br><span class="line">    <span class="comment">// 对解析结果进行校验查询</span></span><br><span class="line">    <span class="keyword">const</span> model = <span class="title class_">User</span>.<span class="title function_">findOne</span>(&#123;<span class="attr">where</span>: &#123;<span class="attr">username</span>: username&#125;&#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!model) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">send</span>(&#123;<span class="attr">msg</span>: <span class="string">&#x27;请注册！&#x27;</span>&#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        res.<span class="title function_">send</span>(&#123;<span class="attr">msg</span>: <span class="string">&#x27;权限校验成功！&#x27;</span>&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<img src="/2022/07/27/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_node+express+mysql%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E4%BB%A5%E5%8F%8Atoken%E6%A0%A1%E9%AA%8C/%E6%A0%A1%E9%AA%8C1.png" class title="校验1">



<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p>以上过程的代码放在github了~</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/express-js-app-listen-function/">app.listen参数</a></p>
<p><a target="_blank" rel="noopener" href="https://www.sequelize.com.cn/">sequelize文档</a></p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/learn/Server-side/Express_Nodejs/routes">Express 教程 4：路由和控制器</a></p>
<p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000009494020">jwt中文文档</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6898630134530752520">cookie、session、token、jwt、单点登录</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Katrina</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="Symbols count total">349k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">5:17</span>
  </span>
</div>
<div class="busuanzi-count">
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

<!-- 不蒜子统计 -->
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div>
	<span class="user-icon">
      <i class="fa fa-user-md"></i>
    </span>
	Views:<span id="busuanzi_value_site_pv"></span>     
	<span class="post-meta-divider">|</span>
	<span class="view-icon">
      <i class="fa fa-eye"></i>
    </span>
	Visitors:<span id="busuanzi_value_site_uv"></span>
</div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.0/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
