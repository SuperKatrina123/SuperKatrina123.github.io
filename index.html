<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"superkatrina123.github.io","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.12.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":5,"unescape":false,"preload":true}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Katrina is trying...">
<meta property="og:type" content="website">
<meta property="og:title" content="耿直咸鱼">
<meta property="og:url" content="https://superkatrina123.github.io/index.html">
<meta property="og:site_name" content="耿直咸鱼">
<meta property="og:description" content="Katrina is trying...">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Katrina">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://superkatrina123.github.io/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>耿直咸鱼</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>
  <a target="_blank" rel="noopener" href="https://github.com/SuperKatrina123" class="github-corner" aria-label="View source on GitHub">
  <svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true">
  <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
  <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path>
  </svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">耿直咸鱼</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">的45°人生</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">55</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories<span class="badge">24</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">92</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Katrina"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">Katrina</p>
  <div class="site-description" itemprop="description">Katrina is trying...</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">92</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">24</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">55</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/SuperKatrina123" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;SuperKatrina123" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:yingyuyan@zju.edu.cn" title="E-Mail → mailto:yingyuyan@zju.edu.cn" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/Katrinasayhello" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;Katrinasayhello" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://instagram.com/katrinasayhello_" title="Instagram → https:&#x2F;&#x2F;instagram.com&#x2F;katrinasayhello_" rel="noopener" target="_blank"><i class="fab fa-instagram fa-fw"></i>Instagram</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://superkatrina123.github.io/2022/07/30/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_%E6%B5%81%E7%A8%8B%E6%A6%82%E8%BF%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Katrina">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="耿直咸鱼">
      <meta itemprop="description" content="Katrina is trying...">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 耿直咸鱼">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/30/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_%E6%B5%81%E7%A8%8B%E6%A6%82%E8%BF%B0/" class="post-title-link" itemprop="url">登录功能 | 流程概述</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-07-30 22:22:04 / Modified: 17:38:20" itemprop="dateCreated datePublished" datetime="2022-07-30T22:22:04+08:00">2022-07-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/React/" itemprop="url" rel="index"><span itemprop="name">React</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Demo/" itemprop="url" rel="index"><span itemprop="name">Demo</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>188</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>1 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h3><p>实现一个登录功能页面</p>
<p>要求如下：</p>
<ol>
<li>能够正常登录登出</li>
<li>规定用户名和密码的格式</li>
</ol>
<h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><ol>
<li>react项目构建——不说了</li>
<li>封装后端接口，实现登录调用和身份验证</li>
<li>antd实现登录页面和注册页面部署</li>
</ol>
<h3 id="封装后端接口"><a href="#封装后端接口" class="headerlink" title="封装后端接口"></a>封装后端接口</h3><p>看这篇：<a href="https://superkatrina123.github.io/2022/07/27/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_node+express+mysql%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E4%BB%A5%E5%8F%8Atoken%E6%A0%A1%E9%AA%8C/">登录功能_node+express+mysql实现用户注册以及token校验</a></p>
<h3 id="登录页面实现与优化思路"><a href="#登录页面实现与优化思路" class="headerlink" title="登录页面实现与优化思路"></a>登录页面实现与优化思路</h3><p>看这篇：<a href="https://superkatrina123.github.io/2022/07/28/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_react+antd%E5%AE%9E%E7%8E%B0%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2/">react+antd实现登录页面</a></p>
<h3 id="bug与问题汇总"><a href="#Bug与问题汇总" class="headerlink" title="Bug与问题汇总"></a>Bug与问题汇总</h3><p>看这篇：<a href="https://superkatrina123.github.io/2022/07/30/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_Bug%E4%B8%8E%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/">Bug与问题汇总</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://superkatrina123.github.io/2022/07/30/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_Bug%E4%B8%8E%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Katrina">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="耿直咸鱼">
      <meta itemprop="description" content="Katrina is trying...">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 耿直咸鱼">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/30/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_Bug%E4%B8%8E%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/" class="post-title-link" itemprop="url">登录功能 | Bug与问题汇总</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-07-30 21:22:04 / Modified: 17:33:40" itemprop="dateCreated datePublished" datetime="2022-07-30T21:22:04+08:00">2022-07-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/React/" itemprop="url" rel="index"><span itemprop="name">React</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Demo/" itemprop="url" rel="index"><span itemprop="name">Demo</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>2.9k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>3 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="问题1跨域"><a href="#问题1：跨域" class="headerlink" title="问题1：跨域"></a>问题1：跨域</h3><p>跨域问题真的太太太太太太重要了！</p>
<img src="/2022/07/30/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_Bug%E4%B8%8E%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/%E8%B7%A8%E5%9F%9F.png" class title="跨域">

<p>一开始我采取CROS的方法解决跨域问题，但是不成功，主要原因在于客户端拒绝添加不安全的请求头也就是Origin，后面我采取配置代理的方式解决跨域的问题</p>
<p>代理原理请看下图：</p>
<img src="/2022/07/30/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_Bug%E4%B8%8E%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/%E4%BB%A3%E7%90%86%E5%8E%9F%E7%90%86.png" class title="代理原理">

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/ setupProxy.js</span></span><br><span class="line"><span class="keyword">const</span> &#123; createProxyMiddleware &#125; = <span class="built_in">require</span>(<span class="string">&#x27;http-proxy-middleware&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">function</span> (<span class="params">app</span>) &#123;</span><br><span class="line">    app.<span class="title function_">use</span>(</span><br><span class="line">        <span class="string">&quot;/api&quot;</span>,</span><br><span class="line">    <span class="title function_">createProxyMiddleware</span>(&#123;</span><br><span class="line">            <span class="comment">//api1是需要转发的请求(所有带有/api1前缀的请求都会转发给5000)</span></span><br><span class="line">            <span class="attr">target</span>: <span class="string">&quot;http://localhost:5000&quot;</span>, <span class="comment">//配置转发目标地址(能返回数据的服务器地址)</span></span><br><span class="line">            <span class="attr">changeOrigin</span>: <span class="literal">true</span>, <span class="comment">//控制服务器接收到的请求头中host字段的值</span></span><br><span class="line">            <span class="comment">/* changeOrigin设置为true时，服务器收到的请求头中的host为：localhost:5000 changeOrigin设置为false时，服务器收到的请求头中的host为：localhost:3000 changeOrigin默认值为false，但我们一般将changeOrigin值设为true */</span></span><br><span class="line">            <span class="attr">pathRewrite</span>: &#123;</span><br><span class="line">            <span class="string">&quot;^/api&quot;</span>: <span class="string">&quot;&quot;</span> &#125;, <span class="comment">//去除请求前缀，保证交给后台服务器的是正常请求地址(必须配置)</span></span><br><span class="line">        &#125;)</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样一来，所有带<code>api</code>前缀的请求都会被转发到目标（target）上，最后请注意把&#x2F;api替换为空字符串</p>
<h3 id="问题2-http-proxy-middleware版本问题导致localhost拒绝"><a href="#问题2：-http-proxy-middleware版本问题导致localhost拒绝" class="headerlink" title="问题2： http-proxy-middleware版本问题导致localhost拒绝"></a>问题2： http-proxy-middleware版本问题导致localhost拒绝</h3><p>一开始，我配置了createProxyMiddleware之后，再次启动react app的时候，竟然！！！localhost拒绝访问！！！【惊了个大呆！】我不信邪，于是我采取最原始的方式，重新创建一个react项目，确定能跑起来之后，把文件一个个复制进去，排查问题在<code>setupProxy.js</code>上，后面发现，不同版本的<code>http-proxy-middleware</code>配置的方式是不同的，主要差别在于<code>createProxyMiddleware</code>引入方式上【高版本按照上面的代码写就好了，顺便提一下，我采用的是<code>&quot;http-proxy-middleware&quot;: &quot;^2.0.6&quot;</code>】</p>
<p>具体看这里：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/tddnr/p/15882820.html">react中配置setupProxy.js后localhost拒绝访问的问题</a></p>
<h3 id="问题3-post请求数据格式问题"><a href="#问题3：-post请求数据格式问题" class="headerlink" title="问题3： post请求数据格式问题"></a>问题3： post请求数据格式问题</h3><p>这个问题困扰了我整整一个下午！！！！</p>
<p>我解决跨域问题之后，不管我怎么输入数据访问一直报错！</p>
<img src="/2022/07/30/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_Bug%E4%B8%8E%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/post.png" class title="post">

<p>我目前的请求配置如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 登录请求（我单独写出来了~）</span></span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&#x27;axios&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; username, password &#125; = values;  <span class="comment">// 解构</span></span><br><span class="line"><span class="keyword">const</span> data = &#123;</span><br><span class="line">    username,</span><br><span class="line">    password,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> response = <span class="title function_">aixos</span>(</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">    url, </span><br><span class="line">    data,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>我百思不得其解，postman能够请求成功，但是我通过登录页面却不能成功，并且状态码为500，说明服务器在执行请求的时候错误，于是开始了排bug之旅</p>
<ul>
<li>首先我想知道服务器有没有接收到我的请求，所以我在服务器写了一个test接口</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/register&#x27;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">    res.<span class="title function_">send</span>(&#123;<span class="attr">msg</span>: <span class="string">&#x27;test接口调用成功！&#x27;</span>&#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>我在前端调用后，返回结果证明，服务器正常返回，接口调用成功</p>
<ul>
<li>既然接口能够调用成功，说明基本功能是没有问题的，所以我开始思考是不是数据格式的问题，我查看了postman数据格式，我发现postman发送请求的时候，数据格式为<code>x-www-form-urlencoded</code></li>
</ul>
<img src="/2022/07/30/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_Bug%E4%B8%8E%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F1.png" class title="数据格式1">

<p>后面了解到，发送post请求有几种常见的数据格式：<a target="_blank" rel="noopener" href="https://blog.51cto.com/zhangchiworkos/2714290"><strong>HTTP POST body常见的四种数据格式</strong></a>，之前有看到过说POST请求的时候必须指定数据格式，当时不以为意，现在终于了解了，发送POST请求的时候需要：</p>
<ul>
<li>设置请求头：<code>&#39;Context-type&#39;: &#39;application/xxx&#39;</code></li>
<li>转换xxx数据格式</li>
</ul>
<p>因为平时最熟悉的莫过于JSON数据，于是乎，我一顿操作之后得到了下面的代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 登录请求（我单独写出来了~）</span></span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&#x27;axios&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; username, password &#125; = values;  <span class="comment">// 解构</span></span><br><span class="line"><span class="keyword">const</span> data = &#123;</span><br><span class="line">    username,</span><br><span class="line">    password,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> response = <span class="title function_">aixos</span>(</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">    url, </span><br><span class="line">    <span class="attr">data</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(data),</span><br><span class="line">    <span class="attr">headers</span>: &#123;</span><br><span class="line">    	<span class="string">&#x27;Context-type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">    &#125;, </span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>我想我的春天要来了，终于能够请求成功了！但是依旧报错500！我不甘心，后端打印了’req.body’，发现了问题</p>
<img src="/2022/07/30/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_Bug%E4%B8%8E%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F2.png" class title="数据格式2">

<p>什么？数据怎么变这样了！</p>
<p>最终只有一位大哥点题了！</p>
<img src="/2022/07/30/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_Bug%E4%B8%8E%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/%E8%A7%A3%E5%86%B31.png" class title="解决1">

<p>最终代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 登录请求（我单独写出来了~）</span></span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&#x27;axios&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> qs <span class="keyword">from</span> <span class="string">&#x27;qs&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; username, password &#125; = values;  <span class="comment">// 解构</span></span><br><span class="line"><span class="keyword">const</span> data = &#123;</span><br><span class="line">    username,</span><br><span class="line">    password,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> response = <span class="title function_">aixos</span>(</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">    url, </span><br><span class="line">    <span class="attr">data</span>: qs.<span class="title function_">stringify</span>(data),</span><br><span class="line">    <span class="attr">headers</span>: &#123;</span><br><span class="line">    	<span class="string">&#x27;Context-type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">    &#125;, </span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>成功~撒花！</p>
<p>血泪教训~</p>
<h3 id="问题3-react-router-dom-v6的一些改变"><a href="#问题3：-React-router-dom-v6的一些改变" class="headerlink" title="问题3： React-router-dom v6的一些改变"></a>问题3： React-router-dom v6的一些改变</h3><p>不得不说，React-router-dom v6的变革是真的大！不过咱也要与时俱进，不可以逃避呀~</p>
<p>多写学习吧！</p>
<h3 id="问题4-组件间通讯"><a href="#问题4：-组件间通讯" class="headerlink" title="问题4： 组件间通讯"></a>问题4： 组件间通讯</h3><p>这个我打算后面单独出一篇博客，到时候贴地址，因为我现在还没完全解决组件通信的问题~</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://superkatrina123.github.io/2022/07/29/HTML/DOM_classList%E5%B1%9E%E6%80%A7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Katrina">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="耿直咸鱼">
      <meta itemprop="description" content="Katrina is trying...">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 耿直咸鱼">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/29/HTML/DOM_classList%E5%B1%9E%E6%80%A7/" class="post-title-link" itemprop="url">DOM | classList属性</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-07-29 13:33:39 / Modified: 14:37:48" itemprop="dateCreated datePublished" datetime="2022-07-29T13:33:39+08:00">2022-07-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/HTML/" itemprop="url" rel="index"><span itemprop="name">HTML</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/DOM/" itemprop="url" rel="index"><span itemprop="name">DOM</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>1.1k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>1 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>HTML5新增了一个classList属性：用于操作元素的className属性，满足基本的增删查</p>
</blockquote>
<p>classList是一个新的集合类型DOMTokenList的实例，具有以下方法：</p>
<ul>
<li>length：表示有几项</li>
<li>item或者中括号取得元素</li>
<li>add(value)：向类名列表中添加指定的字符串值value，如果这个值已经存在，则什么也不做</li>
<li>contains(value)：返回布尔值，表示给定的value 是否存在</li>
<li>remove(value)：从类名列表中删除指定的字符串值value</li>
<li>toggle(value)：如果类名列表中已经存在指定的value，则删除；如果不存在，则添加</li>
</ul>
<p><strong>基本语法</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">element.<span class="property">classList</span>.[method](value)</span><br></pre></td></tr></table></figure>

<p><strong>实例分析</strong></p>
<p>假设现在有一个<code>div</code>，它的class名有：<code>container box selected</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container box selected&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> div = <span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&#x27;div&#x27;</span>)[<span class="number">0</span>];</span></span><br><span class="line"><span class="language-javascript">  <span class="variable language_">console</span>.<span class="title function_">log</span>(div.<span class="property">classList</span>);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol>
<li>获取classList</li>
</ol>
<img src="/2022/07/29/HTML/DOM_classList%E5%B1%9E%E6%80%A7/classList.png" class title="classList">

<p>从上图可以看到，<code>div.classList</code>是一个DOMTokenList的实例，里面分别枚举了div的class属性值，并且包含length和value属性</p>
<ol start="2">
<li>增加disabled类</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">div.<span class="property">classList</span>.<span class="title function_">add</span>(<span class="string">&#x27;disabled&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(div.<span class="property">classList</span>);</span><br></pre></td></tr></table></figure>

<img src="/2022/07/29/HTML/DOM_classList%E5%B1%9E%E6%80%A7/add.png" class title="add">

<ol start="3">
<li>判断是否包含disabled类</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(div.<span class="property">classList</span>.<span class="title function_">contains</span>(<span class="string">&#x27;disabled&#x27;</span>));</span><br></pre></td></tr></table></figure>

<img src="/2022/07/29/HTML/DOM_classList%E5%B1%9E%E6%80%A7/contains.png" class title="contains">

<ol start="4">
<li>删除disabled类</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">div.<span class="property">classList</span>.<span class="title function_">remove</span>(<span class="string">&#x27;disabled&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(div.<span class="property">classList</span>);</span><br></pre></td></tr></table></figure>

<img src="/2022/07/29/HTML/DOM_classList%E5%B1%9E%E6%80%A7/remove.png" class title="remove">

<ol start="5">
<li>切换selected类和user类</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">div.<span class="property">classList</span>.<span class="title function_">toggle</span>(<span class="string">&#x27;selected&#x27;</span>);</span><br><span class="line">div.<span class="property">classList</span>.<span class="title function_">toggle</span>(<span class="string">&#x27;user&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(div.<span class="property">classList</span>);</span><br></pre></td></tr></table></figure>

<img src="/2022/07/29/HTML/DOM_classList%E5%B1%9E%E6%80%A7/toggle.png" class title="toggle">

<p><strong>迭代</strong></p>
<p>classList可以通过for…of来迭代</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> div = <span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&#x27;div&#x27;</span>)[<span class="number">0</span>];</span><br><span class="line">  </span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> name <span class="keyword">of</span> div.<span class="property">classList</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="/2022/07/29/HTML/DOM_classList%E5%B1%9E%E6%80%A7/%E8%BF%AD%E4%BB%A3.png" class title="迭代">

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://superkatrina123.github.io/2022/07/28/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_react+antd%E5%AE%9E%E7%8E%B0%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Katrina">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="耿直咸鱼">
      <meta itemprop="description" content="Katrina is trying...">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 耿直咸鱼">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/28/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_react+antd%E5%AE%9E%E7%8E%B0%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2/" class="post-title-link" itemprop="url">登录功能 | react+antd实现登录页面</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-07-28 21:22:04" itemprop="dateCreated datePublished" datetime="2022-07-28T21:22:04+08:00">2022-07-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-07-30 16:55:40" itemprop="dateModified" datetime="2022-07-30T16:55:40+08:00">2022-07-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/React/" itemprop="url" rel="index"><span itemprop="name">React</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Demo/" itemprop="url" rel="index"><span itemprop="name">Demo</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/antd/" itemprop="url" rel="index"><span itemprop="name">antd</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>5.5k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>5 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="实现需求"><a href="#实现需求" class="headerlink" title="实现需求"></a>实现需求</h2><ul>
<li>登录页面展示</li>
<li>实现注册和登录功能</li>
<li>实现登出功能</li>
<li>登录成功实现页面跳转</li>
<li>短时间不需要再登录</li>
</ul>
<h2 id="实现过程"><a href="#实现过程" class="headerlink" title="实现过程"></a>实现过程</h2><h3 id="创建react项目"><a href="#创建React项目" class="headerlink" title="创建React项目"></a>创建React项目</h3><p>注意：新版React和之前有较大不同</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createRoot &#125; <span class="keyword">from</span> <span class="string">&#x27;react-dom/client&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./App&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// @ts-ignore</span></span><br><span class="line"><span class="keyword">const</span> root = <span class="title function_">createRoot</span>(<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;root&#x27;</span>));</span><br><span class="line">root.<span class="title function_">render</span>(</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">App</span>&gt;</span><span class="tag">&lt;/<span class="name">App</span>&gt;</span></span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 之前的写法是</span></span><br><span class="line"><span class="comment">// ReactDOM.render(&lt;App&gt;&lt;/App&gt;, document.getElementById(&#x27;root&#x27;))</span></span><br></pre></td></tr></table></figure>

<h3 id="前端ui登录界面基本布局"><a href="#前端UI登录界面基本布局" class="headerlink" title="前端UI登录界面基本布局"></a>前端UI登录界面基本布局</h3><blockquote>
<p>这部分我是在pages&#x2F;login&#x2F;index.js完成的</p>
<p>当然不要忘记把组件放到App中去~</p>
</blockquote>
<p>需求：</p>
<ol>
<li><p>完成登录界面基本布局</p>
</li>
<li><p>完成登录表单</p>
</li>
</ol>
<h4 id="实现登录界面"><a href="#实现登录界面" class="headerlink" title="实现登录界面"></a>实现登录界面</h4><p>采用<a target="_blank" rel="noopener" href="https://ant.design/">antd</a>里面的基本布局（header content footer）和表单实现</p>
<p>【不要怕！按照你想的魔改就好了！】</p>
<p>实现效果：</p>
<img src="/2022/07/28/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_react+antd%E5%AE%9E%E7%8E%B0%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2/%E7%99%BB%E5%BD%95%E7%95%8C%E9%9D%A2.png" class title="登录界面">

<h3 id="完善注册页面"><a href="#完善注册页面" class="headerlink" title="完善注册页面"></a>完善注册页面</h3><p>还是采用antd里面的表单进行实现，这里要注意的是，是点击register now!之后，才会切换到注册页面，这里我觉得注册页面单独没什么必要，所以我采取的是把注册页面嵌套在对话框里面，根据自己的喜好啦~</p>
<p>实现效果：</p>
<img src="/2022/07/28/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_react+antd%E5%AE%9E%E7%8E%B0%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2/%E6%B3%A8%E5%86%8C%E7%95%8C%E9%9D%A2.png" class title="注册界面">

<h3 id="接口配置"><a href="#接口配置" class="headerlink" title="接口配置"></a>接口配置</h3><h4 id="promise对axios进行二次封装"><a href="#Promise对axios进行二次封装" class="headerlink" title="Promise对axios进行二次封装"></a>Promise对axios进行二次封装</h4><p>二次封装的好处在于：</p>
<ol>
<li>实现全局axios模块，因为平时发送网络请求多样，有get请求，post请求等等</li>
<li>可以全局部署请求拦截器和响应拦截器</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/api/ajax.js</span></span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&#x27;axios&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> qs <span class="keyword">from</span> <span class="string">&#x27;qs&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;message&#125; <span class="keyword">from</span> <span class="string">&#x27;antd&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> instance = axios.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">timeout</span>: <span class="number">10000</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加请求拦截器</span></span><br><span class="line">instance.<span class="property">interceptors</span>.<span class="property">request</span>.<span class="title function_">use</span>(<span class="function"><span class="params">config</span> =&gt;</span> &#123; </span><br><span class="line">    <span class="comment">// console.log(&#x27;config&#x27;, config);</span></span><br><span class="line">    config.<span class="property">headers</span>.<span class="property">Authorization</span> = sessionStorage.<span class="title function_">getItem</span>(<span class="string">&#x27;token&#x27;</span>) || <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> config;</span><br><span class="line">&#125;, <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(err);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加响应拦截器</span></span><br><span class="line">instance.<span class="property">interceptors</span>.<span class="property">response</span>.<span class="title function_">use</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(response);</span><br><span class="line">    <span class="comment">// 我后端是权限校验成功</span></span><br><span class="line">    <span class="keyword">if</span> (response.<span class="property">data</span>.<span class="property">msg</span> === <span class="string">&#x27;权限校验成功！&#x27;</span>) &#123;</span><br><span class="line">        <span class="variable language_">window</span>.<span class="property">history</span>.<span class="title function_">pushState</span>(<span class="literal">null</span>, <span class="string">&#x27;home&#x27;</span>,<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(response.<span class="property">data</span>.<span class="property">msg</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err.<span class="property">response</span>) &#123;</span><br><span class="line">        <span class="comment">// token失效，回到登录页面</span></span><br><span class="line">        <span class="variable language_">window</span>.<span class="property">history</span>.<span class="title function_">pushState</span>(<span class="literal">null</span>, <span class="string">&#x27;login&#x27;</span>,<span class="string">&#x27;/login&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">ajax</span>(<span class="params">method=<span class="string">&#x27;GET&#x27;</span>, url, data=&#123;&#125;, config</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> promise;</span><br><span class="line">        <span class="comment">// 执行异步ajax请求</span></span><br><span class="line">        <span class="keyword">if</span> (method === <span class="string">&#x27;GET&#x27;</span>) &#123;</span><br><span class="line">            promise = <span class="title function_">instance</span>(&#123;</span><br><span class="line">                <span class="attr">method</span>:<span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">                url, </span><br><span class="line">                <span class="attr">params</span>:data,</span><br><span class="line">                ...config,</span><br><span class="line">            &#125;)  <span class="comment">// params配置指定的是query参数</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            promise = <span class="title function_">axios</span>(&#123;</span><br><span class="line">                <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">                url, </span><br><span class="line">                <span class="attr">data</span>: qs.<span class="title function_">stringify</span>(data),</span><br><span class="line">                <span class="attr">headers</span>: &#123;</span><br><span class="line">                  <span class="string">&#x27;Context-type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">                  <span class="string">&#x27;Authorization&#x27;</span>: <span class="string">&#x27;Bearer &#x27;</span> + <span class="variable language_">window</span>.<span class="property">sessionStorage</span>.<span class="title function_">getItem</span>(<span class="string">&#x27;token&#x27;</span>),</span><br><span class="line">                &#125;, </span><br><span class="line">                ...config,</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        promise.<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 如果成功了，调用resolve(response.data)</span></span><br><span class="line">            <span class="title function_">resolve</span>(response);</span><br><span class="line">        &#125;).<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;    <span class="comment">// 对所有ajax请求出错做统一处理，这样外层就不用再处理错误了</span></span><br><span class="line">            <span class="comment">// 如果失败了，提示请求后台出错</span></span><br><span class="line">            <span class="title function_">reject</span>(message.<span class="title function_">error</span>(error));</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="写接口"><a href="#写接口" class="headerlink" title="写接口"></a>写接口</h4><p>接口主要根据写的后端接口配</p>
<h4 id="解决跨域问题"><a href="#解决跨域问题" class="headerlink" title="解决跨域问题"></a>解决跨域问题</h4><img src="/2022/07/28/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_react+antd%E5%AE%9E%E7%8E%B0%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2/%E8%B7%A8%E5%9F%9F.png" class title="跨域">

<p>一开始，我采用CORS解决<a href="https://superkatrina123.github.io/2022/07/13/%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82/%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82_%E8%B7%A8%E5%9F%9F/?highlight=%E8%B7%A8%E5%9F%9F">跨域</a></p>
<h5 id="报错问题-refused-to-set-unsafe-header-origin"><a href="#报错问题：-Refused-to-set-unsafe-header-“Origin”" class="headerlink" title="报错问题： Refused to set unsafe header “Origin”"></a>报错问题： Refused to set unsafe header “Origin”</h5><img src="/2022/07/28/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_react+antd%E5%AE%9E%E7%8E%B0%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2/%E6%8A%A5%E9%94%991.png" class title="报错1">

<blockquote>
<p>这说明设置的Origin字段是无效的，不管我设置什么或者不设置这个字段时查看Origin字段时它的值都是null，有人说那个Origin字段本来就应该是浏览器来设置的，自己设置不安全</p>
</blockquote>
<p>所以导致我在服务端写了Access-Control-Allow-Origin一直还是没用，所以后面采用了代理的方式进行跨域</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/setupProxy.js</span></span><br><span class="line"><span class="keyword">const</span> &#123; createProxyMiddleware &#125; = <span class="built_in">require</span>(<span class="string">&#x27;http-proxy-middleware&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">function</span> (<span class="params">app</span>) &#123;</span><br><span class="line">    app.<span class="title function_">use</span>(</span><br><span class="line">        <span class="string">&quot;/api&quot;</span>,</span><br><span class="line">    <span class="title function_">createProxyMiddleware</span>(&#123;</span><br><span class="line">            <span class="comment">//api1是需要转发的请求(所有带有/api1前缀的请求都会转发给5000)</span></span><br><span class="line">            <span class="attr">target</span>: <span class="string">&quot;http://localhost:5000&quot;</span>, <span class="comment">//配置转发目标地址(能返回数据的服务器地址)</span></span><br><span class="line">            <span class="attr">changeOrigin</span>: <span class="literal">true</span>, <span class="comment">//控制服务器接收到的请求头中host字段的值</span></span><br><span class="line">            <span class="comment">/* changeOrigin设置为true时，服务器收到的请求头中的host为：localhost:5000 changeOrigin设置为false时，服务器收到的请求头中的host为：localhost:3000 changeOrigin默认值为false，但我们一般将changeOrigin值设为true */</span></span><br><span class="line">            <span class="attr">pathRewrite</span>: &#123;</span><br><span class="line">            <span class="string">&quot;^/api&quot;</span>: <span class="string">&quot;&quot;</span> &#125;, <span class="comment">//去除请求前缀，保证交给后台服务器的是正常请求地址(必须配置)</span></span><br><span class="line">        &#125;)</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终接口代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/api/index.js</span></span><br><span class="line"><span class="keyword">import</span> ajax <span class="keyword">from</span> <span class="string">&#x27;./ajax&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">reqRegister</span> = (<span class="params">username, password</span>) =&gt; <span class="title function_">ajax</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/api/register&#x27;</span>, &#123;username, password&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 登录</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">reqLogin</span> = (<span class="params">username, password</span>) =&gt; <span class="title function_">ajax</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/api/login&#x27;</span>, &#123;username, password&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 权限校验 </span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">reqAuth</span> = (<span class="params"></span>) =&gt; <span class="title function_">ajax</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/api/auth&#x27;</span>, &#123;&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="路由部署"><a href="#路由部署" class="headerlink" title="路由部署"></a>路由部署</h3><p>实现效果：</p>
<ol>
<li>访问home页面，如果没有登录，重定向到login页面</li>
<li>登录成功后跳转到home页面</li>
<li>home页面设置登出</li>
<li>设置注册页面，可以提交表单信息</li>
</ol>
<blockquote>
<p>好久没写router了，此时最新的是<code>&quot;react-router-dom&quot;: &quot;^6.3.0&quot;</code>，发现更新了不少~</p>
<p>不要因为不熟悉就卸载下载旧版本呀【以前的我经常这么干！哈哈哈哈哈】</p>
<p>还是要不断学习！拥抱变化！</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7040289734836355085">(干货) 全网最全 react-router-dom v6.0学习指南</a></p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/router/index.js</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Home</span> <span class="keyword">from</span> <span class="string">&#x27;../pages/home&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Login</span> <span class="keyword">from</span> <span class="string">&#x27;../pages/login&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> routes = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="title class_">Home</span>,</span><br><span class="line">        <span class="attr">exact</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;/login&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="title class_">Login</span>,</span><br><span class="line">    &#125;</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/App.js</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">BrowserRouter</span>, <span class="title class_">Routes</span>, <span class="title class_">Route</span>, <span class="title class_">Navigate</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;react-router-dom&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; routes &#125; <span class="keyword">from</span> <span class="string">&#x27;./router&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">BrowserRouter</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Routes</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;</span></span><br><span class="line"><span class="language-xml">          routes.map((route) =&gt; (</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Route</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">              <span class="attr">key</span>=<span class="string">&#123;route.path&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">              <span class="attr">path</span>=<span class="string">&#123;route.path&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">              //<span class="attr">exact</span>=<span class="string">&#123;route.exact&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">              <span class="attr">element</span>=<span class="string">&#123;</span>&lt;<span class="attr">route.component</span>/&gt;</span>&#125;</span></span><br><span class="line"><span class="language-xml">            &gt;<span class="tag">&lt;/<span class="name">Route</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          ))</span></span><br><span class="line"><span class="language-xml">        &#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&#x27;*&#x27;</span> <span class="attr">element</span>=<span class="string">&#123;</span>&lt;<span class="attr">Navigate</span> <span class="attr">to</span>=<span class="string">&#x27;/login&#x27;</span>/&gt;</span>&#125;&gt;<span class="tag">&lt;/<span class="name">Route</span>&gt;</span>   </span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">Routes</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">BrowserRouter</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样能够实现路由正常跳转了~</p>
<h3 id="接口调用"><a href="#接口调用" class="headerlink" title="接口调用"></a>接口调用</h3><p>接口主要用于实现登录功能，所以基本是下面的流程：</p>
<ol>
<li>输入用户名和密码，登录（发送登录请求）</li>
<li>根据后端返回的结果判断是哪种状态<ol>
<li>登录成功：跳转到主页（’&#x2F;‘），把返回的token存在sessionStorage里面</li>
<li>用户不存在：停留在原页面，提示用户不存在<ol>
<li>用户点击register now!之后，弹出注册页面，用户输入信息后，注册（发送注册请求）</li>
</ol>
</li>
<li>密码错误：停留在原页面，提示密码错误，用户需要再次输入</li>
</ol>
</li>
</ol>
<p>具体看&#x2F;src&#x2F;login部分源码吧~</p>
<p>值得注意的是：跳转页面采用<code>useNavigate</code></p>
<h3 id="自动校验token"><a href="#自动校验token" class="headerlink" title="自动校验token"></a>自动校验token</h3><p>我这里采取的是，在login页面渲染的时候发送自动校验的请求，目前只想到这个~</p>
<h3 id="登出页面"><a href="#登出页面" class="headerlink" title="登出页面"></a>登出页面</h3><p>我主要设置在home组件里面，登出就很简单，要做的就是：</p>
<ol>
<li>删除sessionStorage里面的token</li>
<li>跳转到登录页面（非必要！）</li>
</ol>
<h2 id="优化思考"><a href="#优化思考" class="headerlink" title="优化思考"></a>优化思考</h2><h3 id="优化1-考虑设置token的有效时长"><a href="#优化1：-考虑设置token的有效时长" class="headerlink" title="优化1： 考虑设置token的有效时长"></a>优化1： 考虑设置token的有效时长</h3><h3 id="优化2-考虑组件间传值"><a href="#优化2：-考虑组件间传值" class="headerlink" title="优化2： 考虑组件间传值"></a>优化2： 考虑组件间传值</h3><p>比如用户登陆后可以在home组件访问到是谁登录的，欢迎<code>XXX</code>诸如此类</p>
<h2 id="知识点总结"><a href="#知识点总结" class="headerlink" title="知识点总结"></a>知识点总结</h2><ul>
<li>登录流程</li>
<li><code>antd</code>组件应用</li>
<li><code>axios</code>请求相关：封装、请求头设置、发请求、拦截器等</li>
<li>跨域</li>
<li>react-router：基本配置，跳转路由</li>
<li>token相关</li>
<li>cookie sessionStorage localStorage</li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://ant.design/">antd</a></p>
<p><a target="_blank" rel="noopener" href="https://styled-components.com/">styled-components</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7040289734836355085">(干货) 全网最全 react-router-dom v6.0学习指南</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://superkatrina123.github.io/2022/07/27/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_node+express+mysql%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E4%BB%A5%E5%8F%8Atoken%E6%A0%A1%E9%AA%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Katrina">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="耿直咸鱼">
      <meta itemprop="description" content="Katrina is trying...">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 耿直咸鱼">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/27/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_node+express+mysql%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E4%BB%A5%E5%8F%8Atoken%E6%A0%A1%E9%AA%8C/" class="post-title-link" itemprop="url">登录功能 | node+express+mysql实现用户注册以及token校验</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-07-27 21:22:04" itemprop="dateCreated datePublished" datetime="2022-07-27T21:22:04+08:00">2022-07-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-07-30 16:55:30" itemprop="dateModified" datetime="2022-07-30T16:55:30+08:00">2022-07-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/node/" itemprop="url" rel="index"><span itemprop="name">node</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Demo/" itemprop="url" rel="index"><span itemprop="name">Demo</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>6.1k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>6 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="实现需求"><a href="#实现需求" class="headerlink" title="实现需求"></a>实现需求</h2><ul>
<li>登录</li>
<li>注册</li>
<li>权限校验</li>
</ul>
<h2 id="实现过程"><a href="#实现过程" class="headerlink" title="实现过程"></a>实现过程</h2><ul>
<li>客户端使用用户名和密码请求登录</li>
<li>服务端收到请求后验证是否登录成功<ul>
<li>成功：返回一个token给客户端</li>
<li>失败：提示失败信息</li>
</ul>
</li>
<li>客户端收到token后存储token（token采用jwt进行加密，而不是普通的base64）</li>
<li>每次发起请求时将token发给服务端</li>
<li>服务端接收到请求后，token的合法性<ul>
<li>成功：返回客户端所需数据</li>
<li>失败：返回验证失败的信息</li>
</ul>
</li>
</ul>
<h2 id="流程图解"><a href="#流程图解" class="headerlink" title="流程图解"></a>流程图解</h2><img src="/2022/07/27/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_node+express+mysql%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E4%BB%A5%E5%8F%8Atoken%E6%A0%A1%E9%AA%8C/%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C%E6%B5%81%E7%A8%8B.png" class title="登录注册流程">

<img src="/2022/07/27/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_node+express+mysql%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E4%BB%A5%E5%8F%8Atoken%E6%A0%A1%E9%AA%8C/JWT.png" class title="JWT">

<h2 id="实现流程"><a href="#实现流程" class="headerlink" title="实现流程"></a>实现流程</h2><h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><ul>
<li>node</li>
<li>express</li>
<li>mysql</li>
</ul>
<h4 id="初始化项目"><a href="#初始化项目" class="headerlink" title="初始化项目"></a>初始化项目</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm init <span class="literal">-y</span></span><br></pre></td></tr></table></figure>

<h4 id="安装express"><a href="#安装express" class="headerlink" title="安装express"></a>安装express</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i express</span><br></pre></td></tr></table></figure>

<h4 id="启动node服务_新建appjs文件"><a href="#启动node服务-新建app-js文件" class="headerlink" title="启动node服务_新建app.js文件"></a>启动node服务_新建app.js文件</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.js</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    port: 4000</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">4000</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;serve is running on port: 4000&#x27;</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/express-js-app-listen-function/">app.listen参数</a></p>
<p>启动端口</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node app.js </span><br></pre></td></tr></table></figure>

<img src="/2022/07/27/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_node+express+mysql%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E4%BB%A5%E5%8F%8Atoken%E6%A0%A1%E9%AA%8C/%E5%90%AF%E5%8A%A8node.png" class title="启动node">

<h3 id="连接mysql"><a href="#连接MySQL" class="headerlink" title="连接MySQL"></a>连接MySQL</h3><p>下面的过程都可以看文档：<a target="_blank" rel="noopener" href="https://www.sequelize.com.cn/">sequelize文档</a></p>
<h4 id="安装sequelize和mysql"><a href="#安装Sequelize和MySql" class="headerlink" title="安装Sequelize和MySql"></a>安装Sequelize和MySql</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm i sequelize <span class="comment"># 这将安装最新版本的 Sequelize</span></span><br><span class="line">npm i mysql2 <span class="comment"># MySQL</span></span><br></pre></td></tr></table></figure>

<h4 id="连接到数据库_databasex2finitjs"><a href="#连接到数据库-database-x2F-init-js" class="headerlink" title="连接到数据库_database&#x2F;init.js"></a>连接到数据库_database&#x2F;init.js</h4><p>要连接到数据库,必须创建一个 Sequelize 实例. 这可以通过将连接参数分别传递到 Sequelize 构造函数或通过传递一个连接 URI 来完成</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// database/init.js</span></span><br><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">Sequelize</span> &#125; = <span class="built_in">require</span>(<span class="string">&#x27;sequelize&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> sequelize= <span class="keyword">new</span> <span class="title class_">Sequelize</span>(<span class="string">&#x27;数据库名称&#x27;</span>, <span class="string">&#x27;root&#x27;</span>, <span class="string">&#x27;你的密码&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">host</span>: <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">    <span class="attr">port</span>: <span class="string">&#x27;3306&#x27;</span>,</span><br><span class="line">    <span class="attr">dialect</span>: <span class="string">&#x27;mysql&#x27;</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="测试连接"><a href="#测试连接" class="headerlink" title="测试连接"></a>测试连接</h4><p>引入到app.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;./database/init&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>你可以使用 <code>.authenticate()</code> 函数测试连接是否正常：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="keyword">await</span> sequelize.<span class="title function_">authenticate</span>();</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Connection has been established successfully.&#x27;</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Unable to connect to the database:&#x27;</span>, error);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="关闭连接"><a href="#关闭连接" class="headerlink" title="关闭连接"></a>关闭连接</h4><p>默认情况下,<code>Sequelize</code> 将保持连接打开状态,并对所有查询使用相同的连接. 如果你需要关闭连接,请调用 <code>sequelize.close()</code>(这是异步的并返回一个 Promise).</p>
<h4 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// database/init.js</span></span><br><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">Sequelize</span> &#125; = <span class="built_in">require</span>(<span class="string">&#x27;sequelize&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> sequelize= <span class="keyword">new</span> <span class="title class_">Sequelize</span>(<span class="string">&#x27;test_login&#x27;</span>, <span class="string">&#x27;root&#x27;</span>, <span class="string">&#x27;yyy674531&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">host</span>: <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="attr">port</span>: <span class="string">&#x27;3306&#x27;</span>,</span><br><span class="line">    <span class="attr">dialect</span>: <span class="string">&#x27;mysql&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试连接</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    sequelize.<span class="title function_">authenticate</span>();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Connection has been established successfully.&#x27;</span>);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Unable to connect to the database:&#x27;</span>, error);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span>  = &#123;<span class="title class_">Sequelize</span>, sequelize&#125;;  <span class="comment">// 这里导出，下面有用！</span></span><br></pre></td></tr></table></figure>

<h3 id="同步表模型"><a href="#同步表模型" class="headerlink" title="同步表模型"></a>同步表模型</h3><h4 id="创建模型实例_databasex2fmodelsx2fuserjs"><a href="#创建模型实例-database-x2F-models-x2F-User-js" class="headerlink" title="创建模型实例_database&#x2F;models&#x2F;User.js"></a>创建模型实例_database&#x2F;models&#x2F;User.js</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// database/models/User.js</span></span><br><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">Op</span>, <span class="title class_">Model</span>, <span class="title class_">DataTypes</span> &#125; = <span class="built_in">require</span>(<span class="string">&#x27;sequelize&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">Sequelize</span>, sequelize &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../init.js&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">User</span> = sequelize.<span class="title function_">define</span>(<span class="string">&#x27;users_info&#x27;</span>, &#123;</span><br><span class="line">    <span class="comment">// 应用属性： 禁止null 唯一约束 验证器</span></span><br><span class="line">    <span class="attr">username</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">DataTypes</span>.<span class="property">STRING</span>,  </span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,   <span class="comment">// 1. 禁止 null 值</span></span><br><span class="line">        <span class="attr">unique</span>: <span class="literal">true</span>,   <span class="comment">// 2. 唯一约束</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">password</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">DataTypes</span>.<span class="property">STRING</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="comment">// validate: &#123;    // 3. 验证器</span></span><br><span class="line">        <span class="comment">//    is: /^[0-9a-f]&#123;64&#125;$/i</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将模型与数据库同步</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    注意：如果表已经存在，使用&#123;force: true&#125;将该表删除 </span></span><br><span class="line"><span class="comment">*/</span> </span><br><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">sync</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;user表模型已经同步&#x27;</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<h4 id="导出到appjs并启动"><a href="#导出到app-js并启动" class="headerlink" title="导出到app.js并启动"></a>导出到app.js并启动</h4><img src="/2022/07/27/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_node+express+mysql%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E4%BB%A5%E5%8F%8Atoken%E6%A0%A1%E9%AA%8C/%E6%96%B0%E5%BB%BAUser.png" class title="新建User">

<h3 id="实现路由部署准备"><a href="#实现路由部署（准备）" class="headerlink" title="实现路由部署（准备）"></a>实现路由部署（准备）</h3><p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/learn/Server-side/Express_Nodejs/routes">Express 教程 4：路由和控制器</a></p>
<h4 id="路由部署_expressrouter"><a href="#路由部署-express-Router" class="headerlink" title="路由部署_express.Router"></a>路由部署_express.Router</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// router/user.js</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> router = express.<span class="title class_">Router</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// middleware that is specific to this router</span></span><br><span class="line"><span class="comment">// router.use(function timeLog(req, res, next) &#123;</span></span><br><span class="line"><span class="comment">//     console.log(&#x27;Time:&#x27;, Date.now());</span></span><br><span class="line"><span class="comment">//     next();</span></span><br><span class="line"><span class="comment">// &#125;);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册</span></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/home&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    res.<span class="title function_">send</span>(&#123;<span class="attr">msg</span>: <span class="string">&#x27;Welcome!&#x27;</span>&#125;);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router;</span><br></pre></td></tr></table></figure>

<h4 id="引入使用"><a href="#引入使用" class="headerlink" title="引入使用"></a>引入使用</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.js</span></span><br><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">&#x27;./router/user&#x27;</span>);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">urlencoded</span>(&#123;<span class="attr">extended</span>: <span class="literal">false</span>&#125;));</span><br><span class="line">app.<span class="title function_">use</span>(<span class="string">&#x27;/user&#x27;</span>, router);</span><br></pre></td></tr></table></figure>

<h4 id="postman测试"><a href="#postman测试" class="headerlink" title="postman测试"></a>postman测试</h4><img src="/2022/07/27/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_node+express+mysql%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E4%BB%A5%E5%8F%8Atoken%E6%A0%A1%E9%AA%8C/%E6%B5%8B%E8%AF%951.png" class title="测试1">

<h3 id="实现注册功能"><a href="#实现注册功能" class="headerlink" title="实现注册功能"></a>实现注册功能</h3><h4 id="路由部署"><a href="#路由部署" class="headerlink" title="路由部署"></a>路由部署</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// router/user.js</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/register&#x27;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;username, password&#125; = req.<span class="property">body</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(username);  <span class="comment">// postman测试能够拿到username信息</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<img src="/2022/07/27/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_node+express+mysql%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E4%BB%A5%E5%8F%8Atoken%E6%A0%A1%E9%AA%8C/%E6%B5%8B%E8%AF%952.png" class title="测试2">

<img src="/2022/07/27/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_node+express+mysql%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E4%BB%A5%E5%8F%8Atoken%E6%A0%A1%E9%AA%8C/%E6%B5%8B%E8%AF%952-1.png" class title="测试2-1">

<p>可以看到控制台已经打印了~说明能够获取到username的信息</p>
<blockquote>
<p>注册功能说明：</p>
<p>服务器获取到浏览器传过来的username</p>
<p>首先检验是否存在这个username，如果存在就返回“该用户已经存在，请直接登录”</p>
<p>如果不存在，再进行创建</p>
<ol>
<li>去哪里检验——MySQL数据库里面</li>
<li>怎么创建——利用MySQL的create</li>
</ol>
<p>接下来会详细说明</p>
</blockquote>
<h4 id="用户查询"><a href="#用户查询" class="headerlink" title="用户查询"></a>用户查询</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// router/user.js</span></span><br><span class="line"><span class="comment">// 注册</span></span><br><span class="line"><span class="keyword">const</span> bcryptjs = <span class="built_in">require</span>(<span class="string">&#x27;bcryptjs&#x27;</span>);</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/register&#x27;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;username, password&#125; = req.<span class="property">body</span>;</span><br><span class="line">    <span class="comment">// console.log(username);  // postman测试能够拿到username信息</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用户查询</span></span><br><span class="line">    <span class="keyword">const</span> model = <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">findOne</span>(&#123;<span class="attr">where</span>: &#123;<span class="attr">username</span>: username&#125;&#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (model) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">send</span>(&#123;<span class="attr">msg</span>: <span class="string">&#x27;该用户已经存在，请直接登录！&#x27;</span>&#125;)</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">create</span>(&#123;username, <span class="attr">password</span>:bcryptjs.<span class="title function_">hashSync</span>(password, <span class="number">5</span>)&#125;); <span class="comment">// 加密</span></span><br><span class="line">        <span class="comment">// console.log(user.dataValues);</span></span><br><span class="line">        res.<span class="title function_">send</span>(&#123;<span class="attr">msg</span>: <span class="string">&#x27;注册成功！&#x27;</span>&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>postman测试：创建成功~</p>
<img src="/2022/07/27/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_node+express+mysql%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E4%BB%A5%E5%8F%8Atoken%E6%A0%A1%E9%AA%8C/%E6%B5%8B%E8%AF%953.png" class title="测试3">

<p>查询数据库：创建成功~</p>
<img src="/2022/07/27/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_node+express+mysql%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E4%BB%A5%E5%8F%8Atoken%E6%A0%A1%E9%AA%8C/%E6%B3%A8%E5%86%8C1.png" class title="注册1">

<p>当我再次用同样的username进行注册请求的时候，返回结果为：<strong>该用户已经存在，请直接登录！</strong></p>
<img src="/2022/07/27/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_node+express+mysql%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E4%BB%A5%E5%8F%8Atoken%E6%A0%A1%E9%AA%8C/%E6%B5%8B%E8%AF%952-2.png" class title="测试2-2">

<p>注册功能验证成功~</p>
<h3 id="实现登录功能"><a href="#实现登录功能" class="headerlink" title="实现登录功能"></a>实现登录功能</h3><blockquote>
<p>登录功能说明：</p>
<p>通过发送username和password进行登录</p>
<ul>
<li><p>如果uername不存在，就返回“该用户不存在，请先注册”</p>
</li>
<li><p>如果username存在，要先进行密码校验</p>
<ul>
<li>密码校验不成功——返回“密码错误”</li>
<li>密码校验成功——返回token</li>
</ul>
</li>
</ul>
</blockquote>
<h4 id="登录功能部署"><a href="#登录功能部署" class="headerlink" title="登录功能部署"></a>登录功能部署</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// router/user.js</span></span><br><span class="line"><span class="comment">// 登录功能</span></span><br><span class="line"><span class="keyword">const</span> bcryptjs = <span class="built_in">require</span>(<span class="string">&#x27;bcryptjs&#x27;</span>);</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/login&#x27;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;username, password&#125; = req.<span class="property">body</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(req.<span class="property">body</span>);</span><br><span class="line">    <span class="keyword">const</span> model = <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">findOne</span>(&#123;<span class="attr">where</span>: &#123;<span class="attr">username</span>: username&#125;&#125;);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(model);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!model) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">send</span>(&#123;<span class="attr">msg</span>: <span class="string">&#x27;该用户不存在，请先注册！&#x27;</span>&#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 如果存在username就要进行密码校验</span></span><br><span class="line">        <span class="keyword">const</span> passwordValid = bcryptjs.<span class="title function_">compareSync</span>(password, model.<span class="property">dataValues</span>.<span class="property">password</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!passwordValid) &#123;</span><br><span class="line">            <span class="keyword">return</span> res.<span class="title function_">send</span>(&#123;<span class="attr">msg</span>: <span class="string">&#x27;密码错误！&#x27;</span>&#125;)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           res.<span class="title function_">send</span>(&#123;<span class="attr">msg</span>: <span class="string">&#x27;登录成功！&#x27;</span>&#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>正确输入用户名和密码：</p>
<img src="/2022/07/27/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_node+express+mysql%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E4%BB%A5%E5%8F%8Atoken%E6%A0%A1%E9%AA%8C/%E7%99%BB%E5%BD%951.png" class title="登录1">

<p>输入错误密码：</p>
<img src="/2022/07/27/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_node+express+mysql%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E4%BB%A5%E5%8F%8Atoken%E6%A0%A1%E9%AA%8C/%E7%99%BB%E5%BD%952.png" class title="登录2">

<p>输入未注册用户名：</p>
<img src="/2022/07/27/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_node+express+mysql%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E4%BB%A5%E5%8F%8Atoken%E6%A0%A1%E9%AA%8C/%E7%99%BB%E5%BD%953.png" class title="登录3">

<h4 id="token生成及返回_jsonwebtoken"><a href="#token生成及返回-jsonwebtoken" class="headerlink" title="token生成及返回_jsonwebtoken"></a>token生成及返回_jsonwebtoken</h4><p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000009494020">jwt中文文档</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jwt.<span class="title function_">sign</span>(payload, secretOrPrivateKey, [options, callback]);</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// router/user.js</span></span><br><span class="line"><span class="keyword">const</span> token = jwt.<span class="title function_">sign</span>(&#123;username&#125;, <span class="string">&#x27;ccken&#x27;</span>)</span><br><span class="line">res.<span class="title function_">send</span>(&#123;token&#125;)</span><br></pre></td></tr></table></figure>

<img src="/2022/07/27/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_node+express+mysql%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E4%BB%A5%E5%8F%8Atoken%E6%A0%A1%E9%AA%8C/token.png" class title="token">

<h3 id="实现权限校验"><a href="#实现权限校验" class="headerlink" title="实现权限校验"></a>实现权限校验</h3><blockquote>
<p>权限校验说明：</p>
<ol>
<li>token包含在请求头里面，所以第一步我们要获取token<ul>
<li>如果没有token说明前面没有登录过或者是登录已经失效，返回“请登录”</li>
</ul>
</li>
<li>利用token 密钥 和 payload对token进行解析</li>
<li>对解析结果进行校验查询<ul>
<li>如果查询结果为空，返回’请注册‘</li>
<li>如果不为空，则说明“权限校验成功！”</li>
</ul>
</li>
</ol>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// router/user.js</span></span><br><span class="line"><span class="comment">// 权限校验</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/auth&#x27;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 获取token，token是在请求头里面的</span></span><br><span class="line">    <span class="keyword">const</span> token =  <span class="title class_">String</span>(req.<span class="property">headers</span>.<span class="property">authorization</span>).<span class="title function_">split</span>(<span class="string">&#x27; &#x27;</span>).<span class="title function_">pop</span>();</span><br><span class="line">    <span class="comment">// 如果没有token说明前面没有登录过或者是登录已经失效</span></span><br><span class="line">    <span class="keyword">if</span> (!token) <span class="keyword">return</span> res.<span class="title function_">send</span>(&#123;<span class="attr">msg</span>: <span class="string">&#x27;请登录！&#x27;</span>&#125;)</span><br><span class="line">    <span class="comment">// 根据密钥和字段解析token</span></span><br><span class="line">    <span class="keyword">const</span> &#123;username&#125; = jwt.<span class="title function_">verify</span>(token, <span class="string">&#x27;ccken&#x27;</span>);   <span class="comment">// 之前使用username进行注册的</span></span><br><span class="line">    <span class="comment">// 对解析结果进行校验查询</span></span><br><span class="line">    <span class="keyword">const</span> model = <span class="title class_">User</span>.<span class="title function_">findOne</span>(&#123;<span class="attr">where</span>: &#123;<span class="attr">username</span>: username&#125;&#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!model) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">send</span>(&#123;<span class="attr">msg</span>: <span class="string">&#x27;请注册！&#x27;</span>&#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        res.<span class="title function_">send</span>(&#123;<span class="attr">msg</span>: <span class="string">&#x27;权限校验成功！&#x27;</span>&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<img src="/2022/07/27/Demo/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD_node+express+mysql%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E4%BB%A5%E5%8F%8Atoken%E6%A0%A1%E9%AA%8C/%E6%A0%A1%E9%AA%8C1.png" class title="校验1">



<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p>以上过程的代码放在github了~</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/express-js-app-listen-function/">app.listen参数</a></p>
<p><a target="_blank" rel="noopener" href="https://www.sequelize.com.cn/">sequelize文档</a></p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/learn/Server-side/Express_Nodejs/routes">Express 教程 4：路由和控制器</a></p>
<p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000009494020">jwt中文文档</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6898630134530752520">cookie、session、token、jwt、单点登录</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://superkatrina123.github.io/2022/07/27/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E7%AE%97%E6%B3%95/DFS_%E5%88%A4%E6%96%AD%E6%98%AF%E5%90%A6%E6%98%AF%E5%AD%90%E7%9F%A9%E9%98%B5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Katrina">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="耿直咸鱼">
      <meta itemprop="description" content="Katrina is trying...">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 耿直咸鱼">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/27/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E7%AE%97%E6%B3%95/DFS_%E5%88%A4%E6%96%AD%E6%98%AF%E5%90%A6%E6%98%AF%E5%AD%90%E7%9F%A9%E9%98%B5/" class="post-title-link" itemprop="url">DFS | 判断是否为子矩阵</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-07-27 17:15:15 / Modified: 18:36:59" itemprop="dateCreated datePublished" datetime="2022-07-27T17:15:15+08:00">2022-07-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%AE%97%E6%B3%95/" itemprop="url" rel="index"><span itemprop="name">算法</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/DFS/" itemprop="url" rel="index"><span itemprop="name">DFS</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>1.7k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>2 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>题目来源于某次蔚来笔试~</p>
<p>本渣只能想到这一种方法！感觉好暴力啊！截至目前还没有想到更好的方法呜呜~但是这种方法是可以做的！</p>
</blockquote>
<h3 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h3><p>有两个矩阵，矩阵1（m×m），矩阵2（n×n），判断矩阵2是不是矩阵1的子矩阵，若是输出Yes，若不是输出No</p>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> m1 = [</span><br><span class="line">    [<span class="string">&#x27;#&#x27;</span>, <span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;#&#x27;</span>],</span><br><span class="line">    [<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, <span class="string">&#x27;.&#x27;</span>],</span><br><span class="line">    [<span class="string">&#x27;#&#x27;</span>, <span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;#&#x27;</span>]</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> m2 = [</span><br><span class="line">    [<span class="string">&#x27;#&#x27;</span>, <span class="string">&#x27;.&#x27;</span>],</span><br><span class="line">    [<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;#&#x27;</span>]</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出 &#x27;Yes&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="解题思路"><a href="#解题思路" class="headerlink" title="解题思路"></a>解题思路</h3><ul>
<li><p>设两个指针<code>i</code>和<code>j</code>，用于遍历<code>m1</code>，找到<code>m1[i][j] ===  m2[0][0]</code></p>
</li>
<li><p>设置指针<code>a</code>和<code>b</code>，用于遍历<code>m2</code>，同时<code>i+a</code>和<code>j+b</code>继续遍历<code>m1</code></p>
<ul>
<li>设置边界<ul>
<li><code>i+a &gt;= m1.length</code>  || <code>j+b &gt;= m2.length</code> 返回false</li>
<li><code>m1[i+a][j+b] !== m2[a][b]</code> 返回false</li>
</ul>
</li>
<li>满足条件<ul>
<li><code>a === m2.length -1 &amp;&amp; b === m2.length -1</code>， 返回true</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="算法实现"><a href="#算法实现" class="headerlink" title="算法实现"></a>算法实现</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">fn</span>(<span class="params">matrix1, matrix2</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> m = matrix1.<span class="property">length</span>, n= matrix2.<span class="property">length</span>;</span><br><span class="line">    <span class="comment">// 用于判断是否存在符合的情况</span></span><br><span class="line">    <span class="keyword">let</span> flag = <span class="literal">false</span>;    <span class="comment">// 初始条件为false</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> j = <span class="number">0</span>; j &lt; n; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (matrix1[i][j] === matrix2[<span class="number">0</span>][<span class="number">0</span>]) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_">dfs</span>(i, j)) flag = <span class="literal">true</span>;  <span class="comment">// 只要有一次满足，就可以~</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> flag ? <span class="string">&#x27;Yes&#x27;</span> : <span class="string">&#x27;No&#x27;</span>; <span class="comment">// 只要有一次满足，就为true，如果一次都没满足，就是false</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">dfs</span>(<span class="params">i, j</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> a = <span class="number">0</span>; a &lt; n; a++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> b = <span class="number">0</span>; b &lt; n; b++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (i+a &gt;= n || j+b &gt;= n || matrix1[i+a][j+b] !== matrix2[a][b]) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试一下~</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// eg1</span></span><br><span class="line"><span class="keyword">const</span> m1 = [</span><br><span class="line">    [<span class="string">&#x27;#&#x27;</span>, <span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;#&#x27;</span>],</span><br><span class="line">    [<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, <span class="string">&#x27;.&#x27;</span>],</span><br><span class="line">    [<span class="string">&#x27;#&#x27;</span>, <span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;#&#x27;</span>]</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> m2 = [</span><br><span class="line">    [<span class="string">&#x27;#&#x27;</span>, <span class="string">&#x27;.&#x27;</span>],</span><br><span class="line">    [<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;#&#x27;</span>]</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">fn</span>(m1, m2)) <span class="comment">// &#x27;Yes&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// eg2</span></span><br><span class="line"><span class="keyword">const</span> m1 = [</span><br><span class="line">    [<span class="string">&#x27;#&#x27;</span>, <span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;#&#x27;</span>],</span><br><span class="line">    [<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, <span class="string">&#x27;.&#x27;</span>],</span><br><span class="line">    [<span class="string">&#x27;#&#x27;</span>, <span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;#&#x27;</span>]</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> m2 = [</span><br><span class="line">    [<span class="string">&#x27;#&#x27;</span>, <span class="string">&#x27;.&#x27;</span>],</span><br><span class="line">    [<span class="string">&#x27;#&#x27;</span>, <span class="string">&#x27;#&#x27;</span>]</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">fn</span>(m1, m2))  <span class="comment">// No</span></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://superkatrina123.github.io/2022/07/22/%E6%89%8B%E5%86%99%E5%9C%BA%E6%99%AF/%E6%89%8B%E5%86%99%E5%9C%BA%E6%99%AF_%E5%AE%9E%E7%8E%B0mergePromise%E5%87%BD%E6%95%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Katrina">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="耿直咸鱼">
      <meta itemprop="description" content="Katrina is trying...">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 耿直咸鱼">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/22/%E6%89%8B%E5%86%99%E5%9C%BA%E6%99%AF/%E6%89%8B%E5%86%99%E5%9C%BA%E6%99%AF_%E5%AE%9E%E7%8E%B0mergePromise%E5%87%BD%E6%95%B0/" class="post-title-link" itemprop="url">手写场景 | 实现mergePromise函数</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-07-22 19:06:20" itemprop="dateCreated datePublished" datetime="2022-07-22T19:06:20+08:00">2022-07-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-07-30 16:54:39" itemprop="dateModified" datetime="2022-07-30T16:54:39+08:00">2022-07-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%89%8B%E5%86%99%E5%9C%BA%E6%99%AF/" itemprop="url" rel="index"><span itemprop="name">手写场景</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">异步编程</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>1.4k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>1 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h3><p>实现<code>mergePromise</code>函数，把传进去的数组按顺序先后执行，并且把返回的数据先后放到数据data里面</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">time</span> = (<span class="params">timer</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="title function_">resolve</span>();</span><br><span class="line">        &#125;, timer);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">ajax1</span> = (<span class="params"></span>) =&gt; <span class="title function_">time</span>(<span class="number">2000</span>).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">ajax2</span> = (<span class="params"></span>) =&gt; <span class="title function_">time</span>(<span class="number">1000</span>).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">ajax3</span> = (<span class="params"></span>) =&gt; <span class="title function_">time</span>(<span class="number">1000</span>).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">3</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">mergePromise</span>(<span class="params">promises</span>) &#123;</span><br><span class="line">    <span class="comment">// code in here</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_">mergePromise</span>([ajax1, ajax2, ajax3]).<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;done&#x27;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;data:&#x27;</span>, data); <span class="comment">// data: [1,2,3]</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="思路分析"><a href="#思路分析" class="headerlink" title="思路分析"></a>思路分析</h3><p>这里要按照顺序执行，也就是执行1-2-3这样的顺序，但是1-2-3都用了setTimeout并且时间是不一致的，如果按照普通的思路，那么2-3会在1之前去执行，这样显然是不对的</p>
<ul>
<li><p>可以在执行ajax函数之前包装一个promise实例，让ajax在then里面执行</p>
</li>
<li><p>定义一个数组data用于保存所有的结果</p>
</li>
<li><p><code>mergePromise</code>一定返回一个promise实例</p>
</li>
</ul>
<h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">mergePromise</span>(<span class="params">ajaxArray</span>) &#123;</span><br><span class="line">    <span class="comment">// promises = [ajax1, ajax2, ajax3];</span></span><br><span class="line">    <span class="comment">// 存放结果</span></span><br><span class="line">    <span class="keyword">let</span> data = [];</span><br><span class="line">    <span class="keyword">let</span> promise = <span class="title class_">Promise</span>.<span class="title function_">resolve</span>();</span><br><span class="line">    ajaxArray.<span class="title function_">forEach</span>(<span class="function"><span class="params">ajax</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 第一次then是为了调用ajax函数</span></span><br><span class="line">        <span class="comment">// 第二次then是为了获取结果</span></span><br><span class="line">        promise = promise.<span class="title function_">then</span>(ajax).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">            data.<span class="title function_">push</span>(res);</span><br><span class="line">            <span class="keyword">return</span> data;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> promise;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	promise执行结果如下</span></span><br><span class="line"><span class="comment">	初始化：</span></span><br><span class="line"><span class="comment">	Promise &#123;&lt;fulfilled&gt;: undefined&#125;</span></span><br><span class="line"><span class="comment">	第一次：</span></span><br><span class="line"><span class="comment">	Promise &#123;&lt;fulfilled&gt;: [1]&#125;</span></span><br><span class="line"><span class="comment">	第二次：</span></span><br><span class="line"><span class="comment">	Promise &#123;&lt;fulfilled&gt;: [1，2]&#125;</span></span><br><span class="line"><span class="comment">	第三次：</span></span><br><span class="line"><span class="comment">	Promise &#123;&lt;fulfilled&gt;: [1，2，3]&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行结果为：</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	1</span></span><br><span class="line"><span class="comment">    2</span></span><br><span class="line"><span class="comment">    3</span></span><br><span class="line"><span class="comment">    done</span></span><br><span class="line"><span class="comment">    data: [ 1, 2, 3 ]</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://superkatrina123.github.io/2022/07/22/JavaScript/%E5%BC%82%E6%AD%A5%E5%87%BD%E6%95%B0_forEach%E9%81%87%E4%B8%8Aawait/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Katrina">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="耿直咸鱼">
      <meta itemprop="description" content="Katrina is trying...">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 耿直咸鱼">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/22/JavaScript/%E5%BC%82%E6%AD%A5%E5%87%BD%E6%95%B0_forEach%E9%81%87%E4%B8%8Aawait/" class="post-title-link" itemprop="url">异步函数 | forEach遇上await</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-07-22 17:37:03 / Modified: 18:46:07" itemprop="dateCreated datePublished" datetime="2022-07-22T17:37:03+08:00">2022-07-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>2.5k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>2 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>forEach和await我们都不陌生</p>
<p>其中，forEach是JS中Array的API，用于遍历数组中的元素，并且可以传入一个回调函数去修改数组中的每一项，特点是没有返回值【不能用return，也不能用break跳出循环】，且会修改原数组</p>
<p>await是异步函数async&#x2F;await发挥主要作用的标识符，用于阻塞代码的执行，实现异步效果</p>
<p>那么，forEach遇上await会擦出怎样的火花呢？</p>
<h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>看下面的例子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">getNumber</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]);  </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 返回结果为一个Promise实例</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        Promise &#123;&lt;fulfilled&gt;: [1,2,3]&#125;;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">multi</span>(<span class="params">num</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (num) &#123;</span><br><span class="line">                <span class="title function_">resolve</span>(num * num);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;num not specified&#x27;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">1000</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">test</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> nums = <span class="keyword">await</span> <span class="title function_">getNumber</span>();  <span class="comment">// await解包：如果表达式是 promise 对象, await 返回的是 promise 成功的值</span></span><br><span class="line">    <span class="comment">// nums是一个数组[1,2,3]</span></span><br><span class="line">    nums.<span class="title function_">forEach</span>(<span class="keyword">async</span> item =&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> res = <span class="keyword">await</span> <span class="title function_">multi</span>(item);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(res);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">test</span>();</span><br></pre></td></tr></table></figure>

<p>我们期望的打印结果是：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1秒后</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 1秒后</span></span><br><span class="line"><span class="comment">// 4</span></span><br><span class="line"><span class="comment">// 1秒后</span></span><br><span class="line"><span class="comment">// 9</span></span><br></pre></td></tr></table></figure>

<p>实际的打印结果是：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1秒后</span></span><br><span class="line"><span class="comment">// 1 </span></span><br><span class="line"><span class="comment">// 4</span></span><br><span class="line"><span class="comment">// 9</span></span><br></pre></td></tr></table></figure>

<p>说明，forEach里面的回调函数并没有异步执行，而是同步执行的</p>
<h3 id="分析问题"><a href="#分析问题" class="headerlink" title="分析问题"></a>分析问题</h3><p>在上面这个例子中，我们给forEach的回调函数套上了async&#x2F;await，使其具有异步函数的功能，我们期望其可以串行执行函数，但实际却是并行执行了</p>
<p><code>forEach</code> 的 polyfill 参考：<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Array/forEach">MDN-Array.prototype.forEach()</a>，可以帮助我们理解：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">forEach</span> = <span class="keyword">function</span>(<span class="params">cb</span>) &#123;</span><br><span class="line">    <span class="comment">// this指代调用forEach的array</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> index = <span class="number">0</span>; i &lt; <span class="variable language_">this</span>.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="comment">// 回调函数的三个参数：index，item，array</span></span><br><span class="line">        <span class="title function_">cb</span>(index, <span class="variable language_">this</span>[index], <span class="variable language_">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面的代码可以得知，forEach只是简单地执行了回调函数而已，而不会去处理异步的情况</p>
<p>test函数可以修改为等价的代码，如下所示：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">test</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> nums = <span class="keyword">await</span> <span class="title function_">getNumber</span>();   <span class="comment">// nums为 [1,2,3]</span></span><br><span class="line"> 	</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; nums.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        (<span class="keyword">async</span> item =&gt; &#123;</span><br><span class="line">            <span class="keyword">let</span> res = <span class="keyword">await</span> <span class="title function_">multi</span>(item);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(res);</span><br><span class="line">        &#125;)(nums[i]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从以上代码可以得知：forEach中异步函数是并行执行，导致了一次性全部输出结果：1，4，9</p>
<h3 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h3><h4 id="方式一for循环"><a href="#方式一：for循环" class="headerlink" title="方式一：for循环"></a>方式一：for循环</h4><p>通过改造forEach，确保每一个异步的回调执行之后再去执行下一个</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">asyncForEach</span>(<span class="params">array, cb</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; array.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">await</span> <span class="title function_">cb</span>(array[i], i, array);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">test</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> nums = <span class="keyword">await</span> <span class="title function_">getNumber</span>();   <span class="comment">// nums为 [1,2,3]</span></span><br><span class="line">    </span><br><span class="line">    <span class="title function_">asyncForEach</span>(nums, <span class="keyword">async</span> item =&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> res = <span class="keyword">await</span> <span class="title function_">multi</span>(item);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(res);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="方式二forof"><a href="#方式二：for…of" class="headerlink" title="方式二：for…of"></a>方式二：for…of</h4><p>for…of用于遍历可迭代对象，先调用可迭代对象的迭代器方法<code>[Symbol.iterator]()</code>方法，该方法返回一个迭代器对象，对象内部包含next()方法，然后调用迭代器对象上的next方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">test</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> nums = <span class="keyword">await</span> <span class="title function_">getNumber</span>();   <span class="comment">// nums为 [1,2,3]</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> num <span class="keyword">of</span> nums) &#123;</span><br><span class="line">        <span class="keyword">let</span> res = <span class="keyword">await</span> <span class="title function_">multi</span>(num);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(res);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述代码等价于下列代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">test</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> nums = <span class="keyword">await</span> <span class="title function_">getNumber</span>();   <span class="comment">// nums为 [1,2,3]</span></span><br><span class="line">    <span class="keyword">let</span> iterator = nums[<span class="title class_">Symbol</span>.<span class="property">iterator</span>]();   </span><br><span class="line">    <span class="keyword">let</span> objIterator = iterator.<span class="title function_">next</span>();   <span class="comment">// &#123;value: xxx, done: true || false&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (!objIterator.<span class="property">done</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> num = objIterator.<span class="property">value</span>;</span><br><span class="line">        <span class="keyword">let</span> res = <span class="keyword">await</span> <span class="title function_">multi</span>(num);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(res);</span><br><span class="line">        objIterator = iterator.<span class="title function_">next</span>();  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a target="_blank" rel="noopener" href="http://objcer.com/2017/10/12/async-await-with-forEach/">当 async&#x2F;await 遇上 forEach</a></p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Array/forEach">MDN-Array.prototype.forEach()</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://superkatrina123.github.io/2022/07/21/%E8%AE%A1%E7%BD%91&&%E6%B5%8F%E8%A7%88%E5%99%A8%E5%8E%9F%E7%90%86/%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%AD%98%E5%82%A8_cookie/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Katrina">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="耿直咸鱼">
      <meta itemprop="description" content="Katrina is trying...">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 耿直咸鱼">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/21/%E8%AE%A1%E7%BD%91&&%E6%B5%8F%E8%A7%88%E5%99%A8%E5%8E%9F%E7%90%86/%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%AD%98%E5%82%A8_cookie/" class="post-title-link" itemprop="url">客户端存储 | cookie && WebStorage</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-07-21 13:36:47 / Modified: 15:57:57" itemprop="dateCreated datePublished" datetime="2022-07-21T13:36:47+08:00">2022-07-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%92%8C%E6%88%91%E4%B8%80%E8%B5%B7%E8%AF%BB%E7%BA%A2%E5%AE%9D%E4%B9%A6/" itemprop="url" rel="index"><span itemprop="name">和我一起读红宝书</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B8%B8%E8%A7%81%E6%96%B9%E6%B3%95%E5%AF%B9%E6%AF%94/" itemprop="url" rel="index"><span itemprop="name">常见方法对比</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>2.9k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>3 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="cookie"><a href="#Cookie" class="headerlink" title="Cookie"></a>Cookie</h2><h3 id="cookie用于客户端存储会话信息"><a href="#cookie用于客户端存储会话信息" class="headerlink" title="cookie用于客户端存储会话信息"></a><strong>cookie用于客户端存储会话信息</strong></h3><p>服务器在响应HTTP请求时，通过发送<code>Set-Cookie</code> HTTP头部包含会话信息，<strong>value和name在发送时都会经过URL编码</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">HTTP</span>/<span class="number">1.1</span> <span class="number">2.0</span> <span class="variable constant_">OK</span></span><br><span class="line"><span class="title class_">Content</span>-<span class="attr">type</span>: text/html</span><br><span class="line"><span class="title class_">Set</span>-<span class="title class_">Cookie</span>: name=value</span><br><span class="line"><span class="title class_">Other</span>-<span class="attr">header</span>: other-hander-value</span><br></pre></td></tr></table></figure>

<p>浏览器会存储这些会话信息，并在之后每一个请求中都会在HTTP请求头中包含cookie，将cooike信息发回服务器，这些信息可以作为<strong>唯一标识发送请求</strong>的服务器</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">GET</span> /index.<span class="property">js</span> <span class="variable constant_">HTTP</span>/<span class="number">1.1</span></span><br><span class="line"><span class="title class_">Cookie</span>: name=value</span><br><span class="line"><span class="title class_">Other</span>-<span class="attr">header</span>: other-hander-value</span><br></pre></td></tr></table></figure>

<h3 id="cookie的构成"><a href="#cookie的构成" class="headerlink" title="cookie的构成"></a>cookie的构成</h3><img src="/2022/07/21/%E8%AE%A1%E7%BD%91&&%E6%B5%8F%E8%A7%88%E5%99%A8%E5%8E%9F%E7%90%86/%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%AD%98%E5%82%A8_cookie/cookie%E6%9E%84%E6%88%90.png" class title="cookie构成">

<ul>
<li><p><code>name</code>：唯一标识cookie 的名称，cookie 名不区分大小写，cookie 名必须经过URL 编码</p>
</li>
<li><p><code>value</code>：存储在cookie 里的字符串值，这个值必须经过URL 编码</p>
</li>
<li><p><code>domain</code>：cookie 有效的域，发送到这个域的所有请求都会包含对应的cookie，值默认包含子域</p>
</li>
<li><p><code>path</code>：请求URL 中包含这个路径才会把cookie 发送到服务器，默认包含子路径</p>
</li>
<li><p><code>expires/max-age</code>：表示何时删除cookie 的时间戳（即什么时间之后就不发送到服务器了），默认情况下，浏览器会话结束后会删除所有cookie，不过，也可以设置删除cookie 的时间。这个值是GMT 格式（Wdy, DD-Mon-YYYY HH:MM:SS GMT），用于指定删除cookie 的具体时间，这样即使关闭浏览器cookie 也会保留在用户机器上，把过期时间设置为过去的时间会立即删除cookie</p>
</li>
<li><p><code>size</code>：cookie大小</p>
</li>
<li><p><code>secure</code>：设置之后，只在使用SSL 安全连接的情况下才会把cookie 发送到服务器</p>
</li>
<li><p><code>HttpOnly</code>：HttpOnly值为 true 或 false，若设置为true，则不允许通过脚本document.cookie去更改这个值，同样这个值在document.cookie中也不可见，但在发送请求时依旧会携带此Cookie，可防止通过JavaScript访问cookie的值</p>
</li>
<li><p><code>SameSite</code>：用来限制第三方 Cookie，从而减少安全风险，它有3个属性，分别是：</p>
<ul>
<li><p>Strict：Scrict最为严格，完全禁止第三方Cookie，跨站点时，任何情况下都不会发送Cookie</p>
</li>
<li><p>Lax：Lax规则稍稍放宽，大多数情况也是不发送第三方 Cookie，但是导航到目标网址的 Get 请求除外。</p>
</li>
<li><p>None：网站可以选择显式关闭SameSite属性，将其设为None，不过，前提是必须同时设置Secure属性（Cookie 只能通过 HTTPS 协议发送），否则无效</p>
</li>
</ul>
</li>
<li><p><code>Priority</code>：优先级，定义了三种优先级，Low&#x2F;Medium&#x2F;High，当cookie数量超出时，低优先级的cookie会被优先清除</p>
</li>
</ul>
<h2 id="web-storage"><a href="#Web-Storage" class="headerlink" title="Web Storage"></a>Web Storage</h2><p>提出的目的是为了解决通过客户端存储<strong>不需要频繁发送回服务器</strong>的数据时使用cookie的问题</p>
<p>基于cookie，Web Storage提出了两个目标：</p>
<ul>
<li>提供在cookie之外的存储会话数据的目标</li>
<li>提供跨会话持久化存储大量数据的机制</li>
</ul>
<h3 id="storage类型"><a href="#Storage类型" class="headerlink" title="Storage类型"></a>Storage类型</h3><p>Storage类型用于保存名&#x2F;值对数据，直到存储空间上限（浏览器决定！）</p>
<p>Storage在对象的基础上，增加如下方法：</p>
<ul>
<li><code>clear()</code>：删除所有值；不在Firefox 中实现</li>
<li><code>getItem(name)</code>：取得给定name 的值</li>
<li><code>key(index)</code>：取得给定数值位置的名称</li>
<li><code>removeItem(name)</code>：删除给定name 的名&#x2F;值对</li>
<li><code>setItem(name, value)</code>：设置给定name 的值</li>
</ul>
<h3 id="sessionstorage对象跨会话存储"><a href="#sessionStorage对象（跨会话存储）" class="headerlink" title="sessionStorage对象（跨会话存储）"></a><code>sessionStorage</code>对象（跨会话存储）</h3><ul>
<li><p><code>sessionStorage</code>对象只存储<strong>会话数据</strong>，所以数据只会存储到<strong>浏览器关闭</strong></p>
</li>
<li><p>存储在<code>sessionStorage</code>中的数据不受页面刷新影响，可以在浏览器崩溃并重启后恢复</p>
</li>
<li><p>因为<code>sessionStorage</code>对象与服务器会话紧密相关，所以在运行本地文件时不能使用</p>
</li>
<li><p>存储在<code>sessionStorage</code>对象中的数据只能由最初存储数据的页面使用，在多页应用程序中的用处有限</p>
</li>
</ul>
<h3 id="localstorage对象永久存储"><a href="#localStorage对象（永久存储）" class="headerlink" title="localStorage对象（永久存储）"></a><code>localStorage</code>对象（永久存储）</h3><ul>
<li><code>localStorage</code>对象作为在客户端<strong>持久存储数据</strong>的机制</li>
<li>要访问同一个<code>localStorage</code>对象，页面必须来自同一个域（子域不可以）、在相同的端口上使用相同的协议</li>
</ul>
<h3 id="存储事件"><a href="#存储事件" class="headerlink" title="存储事件"></a>存储事件</h3><p>每当Storage 对象发生变化时，都会在文档上触发<code>storage</code>事件。使用属性或<code>setItem()</code>设置值、使用<code>delete</code>或<code>removeItem()</code>删除值，以及每次调用<code>clear()</code>时都会触发这个事件</p>
<p>这个事件的事件对象有如下4 个属性</p>
<ul>
<li><code>domain</code>：存储变化对应的域</li>
<li><code>key</code>：被设置或删除的键</li>
<li><code>newValue</code>：键被设置的新值，若键被删除则为null</li>
<li><code>oldValue</code>：键变化之前的值</li>
</ul>
<p>可以使用如下代码监听<code>storage</code>事件：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;storage&quot;</span>,</span><br><span class="line">	<span class="function">(<span class="params">event</span>) =&gt;</span> <span class="title function_">alert</span>(<span class="string">&#x27;Storage changed for $&#123;event.domain&#125;&#x27;</span>));</span><br></pre></td></tr></table></figure>

<p>对于<code>sessionStorage</code>和<code>localStorage</code>上的任何更改都会触发<code>storage</code>事件，但<code>storage</code>件不会区分这两者</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><h3 id="三者区别"><a href="#三者区别" class="headerlink" title="三者区别"></a>三者区别</h3><h4 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h4><ul>
<li>cookie：可以通过设置<code>expires/max-age</code>来控制失效时间，没设置就默认关闭浏览器后失效</li>
<li>sessionStorage：仅在当前网页会话下有效，关闭页面或者浏览器会被清除</li>
<li>localStorage：永久保存，除非手动清除</li>
</ul>
<h4 id="存放数据大小"><a href="#存放数据大小" class="headerlink" title="存放数据大小"></a>存放数据大小</h4><ul>
<li>cookie：4kb左右</li>
<li>web Storage：5MB</li>
</ul>
<h4 id="http请求"><a href="#http请求" class="headerlink" title="http请求"></a>http请求</h4><ul>
<li>cookie：每次发送请求的时候都会携带在http头中，如果cookie保存过多数据会带来性能问题</li>
<li>web Storage：仅在客户端中保存，不参与和服务器的通信</li>
</ul>
<h4 id="易用性"><a href="#易用性" class="headerlink" title="易用性"></a>易用性</h4><ul>
<li>cookie：需要自己封装，包含get set等方法，详情见红宝书第四版P754页</li>
<li>web Storage：原生接口可以接受，也可以再次封装</li>
</ul>
<h3 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h3><p>从安全性来说，因为每次http请求都会携带cookie信息，这样无形中浪费了带宽，所以cookie应该尽可能少的使用，另外cookie还需要指定作用域，不可以跨域调用，限制比较多</p>
<p>但是用来识别用户登录来说，cookie还是比stprage更好用的，其他情况下，可以使用storage，就用storage</p>
<p>storage在存储数据的大小上面秒杀了cookie，现在基本上很少使用cookie了</p>
<p>localStorage和sessionStorage唯一的差别一个是永久保存在浏览器里面，一个是关闭网页就清除了信息，localStorage可以用来夸页面传递参数，sessionStorage用来保存一些临时的数据，防止用户刷新页面之后丢失了一些参数</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://superkatrina123.github.io/2022/07/20/%E8%AE%A1%E7%BD%91&&%E6%B5%8F%E8%A7%88%E5%99%A8%E5%8E%9F%E7%90%86/%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%AD%98%E5%82%A8_IndexDB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Katrina">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="耿直咸鱼">
      <meta itemprop="description" content="Katrina is trying...">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 耿直咸鱼">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/20/%E8%AE%A1%E7%BD%91&&%E6%B5%8F%E8%A7%88%E5%99%A8%E5%8E%9F%E7%90%86/%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%AD%98%E5%82%A8_IndexDB/" class="post-title-link" itemprop="url">客户端存储 | IndexedDB</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-07-20 16:18:49" itemprop="dateCreated datePublished" datetime="2022-07-20T16:18:49+08:00">2022-07-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-07-21 15:58:05" itemprop="dateModified" datetime="2022-07-21T15:58:05+08:00">2022-07-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%92%8C%E6%88%91%E4%B8%80%E8%B5%B7%E8%AF%BB%E7%BA%A2%E5%AE%9D%E4%B9%A6/" itemprop="url" rel="index"><span itemprop="name">和我一起读红宝书</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>9.7k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>9 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="什么是indexeddb"><a href="#什么是indexedDB" class="headerlink" title="什么是indexedDB"></a>什么是<code>indexedDB</code></h3><p><code>indexedDB</code>是浏览器结构化存储的一种方式，用于代替目前已经废弃的<code>Web SQL Database API</code></p>
<p><code>indexedDB</code>是类似于<code>MySQL</code>或者<code>Web SQL Database</code>的数据库，但是**<code>IndexDB</code>使用对象而不是表格保存数据<strong>，因此，可以说<code>indexedDB</code>是在一个公共空间下的一组对象存储</strong>，类似于NoSQL风格的实现</p>
<h3 id="如何使用indexdb数据库"><a href="#如何使用IndexDB数据库" class="headerlink" title="如何使用IndexDB数据库"></a>如何使用<code>IndexDB</code>数据库</h3><p>使用<code>indexedDB</code>数据库可通过如下步骤（基础）：</p>
<ul>
<li>Step1：调用<code>indexedDB.open()</code>方法</li>
<li>Step2：对象存储</li>
<li>Step3：调用事务进行增删改查</li>
</ul>
<h4 id="step1调用indexeddbopen方法"><a href="#Step1：调用indexedDB-open-方法" class="headerlink" title="Step1：调用indexedDB.open()方法"></a>Step1：调用<code>indexedDB.open()</code>方法</h4><p><code>indexedDB.open()</code>方法用于打开数据库（如果数据库不存在，则为创建）</p>
<p><strong>参数说明</strong></p>
<ul>
<li>要打开的数据库名称（必选）</li>
<li>指定版本号（可选）</li>
</ul>
<p><strong>返回值说明</strong></p>
<p>返回一个<code>IDBRequest</code>的实例，可以在这个实例上添加<code>onerror</code>和<code>onsuccess</code>事件处理程序，<strong>这两个事件处理程序的<code>event.target</code>都指向这个实例</strong></p>
<ul>
<li>如果打开的时候发生错误，就会在<code>event.target.errorCode</code>中存储错误码</li>
<li>如果打开成功，就可以通过<code>event.target.result</code>访问数据库</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> db,</span><br><span class="line">    request,</span><br><span class="line">    version = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">request = indexedDB.<span class="title function_">open</span>(<span class="string">&#x27;admin&#x27;</span>, version);   <span class="comment">// 打开admin这个数据库</span></span><br><span class="line">request.<span class="property">onerror</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Failed to open: <span class="subst">$&#123;event.target.errorCode&#125;</span>`</span>);</span><br><span class="line">&#125;;</span><br><span class="line">request.<span class="property">onsuccess</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">    db = event.<span class="property">target</span>.<span class="property">result</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="step2对象存储"><a href="#Step2：对象存储" class="headerlink" title="Step2：对象存储"></a>Step2：对象存储</h4><p>对象存储你需要准备：</p>
<ul>
<li>指定一个键，必须是全局唯一的</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> user = &#123;</span><br><span class="line">    <span class="attr">username</span>: <span class="string">&#x27;007&#x27;</span>,</span><br><span class="line">    <span class="attr">firstName</span>: <span class="string">&#x27;Katrina&#x27;</span>,</span><br><span class="line">    <span class="attr">lastName</span>: <span class="string">&#x27;Ying&#x27;</span>,</span><br><span class="line">    <span class="attr">password</span>: <span class="string">&#x27;foo&#x27;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>假设要存储这样一个对象，很显然<code>username</code>可以用来做主键</p>
<ul>
<li>upgradeneeded事件用于监听更新数据库</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">request.<span class="property">onupgradeneeded</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> db = event.<span class="property">target</span>.<span class="property">result</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果已经存在则删除当前的objectStore</span></span><br><span class="line">    <span class="keyword">if</span> (db.<span class="property">objectStoreNames</span>.<span class="title function_">contains</span>(<span class="string">&#x27;users&#x27;</span>)) &#123;</span><br><span class="line">        db.<span class="title function_">deleteObjectStore</span>(<span class="string">&#x27;users&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    db.<span class="title function_">createObjectStore</span>(<span class="string">&#x27;users&#x27;</span>, &#123;<span class="attr">keyPath</span>: <span class="string">&#x27;username&#x27;</span>&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="step3通过事务进行后序操作"><a href="#Step3：通过事务进行后序操作" class="headerlink" title="Step3：通过事务进行后序操作"></a>Step3：通过事务进行后序操作</h4><p>在对象存储之后，剩下的所有操作都是通过事务完成的</p>
<ul>
<li>插入对象：add put</li>
<li>删除对象：delete （键作为参数）</li>
<li>获取对象：get（键作为参数）</li>
<li>清空对象：clear</li>
</ul>
<h5 id="1-创建事务-dbtransaction"><a href="#1-创建事务-db-transaction" class="headerlink" title="1. 创建事务 db.transaction()"></a>1. 创建事务 <code>db.transaction()</code></h5><ul>
<li>没有指定名称——数据库中所有的对象都只有只读权限</li>
<li>访问一个或者多个数据库——传入数据库名称，单个直接传入，多个以数组的形式传入</li>
<li>传入第二个参数以修改访问模式——<code>readonly readwrite versionchange</code></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 没有指定名称，数据库中所有的对象都只有只读权限</span></span><br><span class="line"><span class="keyword">let</span> transaction = db.<span class="title function_">transaction</span>();  </span><br><span class="line"></span><br><span class="line"><span class="comment">// 指定名称</span></span><br><span class="line"><span class="keyword">let</span> transaction = db.<span class="title function_">transaction</span>(<span class="string">&#x27;users&#x27;</span>);  </span><br><span class="line"><span class="keyword">let</span> transaction = db.<span class="title function_">transaction</span>([<span class="string">&#x27;users&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>]);  </span><br><span class="line"></span><br><span class="line"><span class="comment">// 指定第二个参数</span></span><br><span class="line"><span class="keyword">let</span> transaction = db.<span class="title function_">transaction</span>(<span class="string">&#x27;users&#x27;</span>, <span class="string">&#x27;readwrite&#x27;</span>);  </span><br></pre></td></tr></table></figure>

<h5 id="2-事务事件处理程序绑定"><a href="#2-事务事件处理程序绑定" class="headerlink" title="2. 事务事件处理程序绑定"></a>2. 事务事件处理程序绑定</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> transaction = db.<span class="title function_">transaction</span>(<span class="string">&#x27;users&#x27;</span>),</span><br><span class="line">      store = transaction.<span class="title function_">objectStore</span>(<span class="string">&#x27;users&#x27;</span>),</span><br><span class="line">      request = store.<span class="title function_">get</span>(<span class="string">&#x27;007&#x27;</span>);</span><br><span class="line"></span><br><span class="line">request.<span class="property">onerror</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> <span class="title function_">alert</span>(<span class="string">&quot;Did not get the object!&quot;</span>);</span><br><span class="line">request.<span class="property">onsuccess</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> <span class="title function_">alert</span>(event.<span class="property">target</span>.<span class="property">result</span>.<span class="property">firstName</span>);</span><br></pre></td></tr></table></figure>

<p>因为一个事务可以完成任意多个请求，所以事务对象本身也有事件处理程序：<code>onerror</code> 和<code>oncomplete</code>，这两个事件可以用来获取事务级的状态信息</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">transaction.<span class="property">onerror</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">	<span class="comment">// 整个事务被取消</span></span><br><span class="line">&#125;;</span><br><span class="line">transaction.<span class="property">oncomplete</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">	<span class="comment">// 整个事务成功完成</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>注意，不能通过<code>oncomplete</code>事件处理程序的<code>event</code>对象访问<code>get()</code>请求返回的任何数据，因此，仍然需要通过这些请求的<code>onsuccess</code>事件处理程序来获取数据</p>
<h3 id="插入数据"><a href="#插入数据" class="headerlink" title="插入数据"></a>插入数据</h3><p>插入数据的方式有：</p>
<ul>
<li>add（增加新值）</li>
<li>put（修改，更新）</li>
</ul>
<p>这两个方法都接收一个参数：要存储的对象</p>
<p>两者的区别在于：传入对象存储已经包含同名键时，add会报错，而put是重写对象</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> user <span class="keyword">of</span> users) &#123;</span><br><span class="line">    store.<span class="title function_">add</span>(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每次调用<code>add()</code>或<code>put()</code>都会创建对象存储的新更新请求</p>
<p>如果想验证请求成功与否，可以把请求对象保存到一个变量，然后为它添加<code>onerror </code>和<code>onsuccess </code>事件处理程序</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> request,</span><br><span class="line">    requests = [];</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> user <span class="keyword">of</span> users) &#123;</span><br><span class="line">    request = store.<span class="title function_">add</span>(user);</span><br><span class="line">    </span><br><span class="line">    request.<span class="property">onerror</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 处理错误程序</span></span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    request.<span class="property">onsuccess</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 处理成功</span></span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    requests.<span class="title function_">push</span>(request);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="通过游标查询"><a href="#通过游标查询" class="headerlink" title="通过游标查询"></a>通过游标查询</h3><p>使用事务可以通过一个已知键取得一条记录，如果想取得多条数据，则需要在事务中创建一个<strong>游标</strong></p>
<p>游标是一个指向结果集的指针</p>
<p>与传统数据库查询不同，游标不会事先收集所有结果，相反，游标指向第一个结果，并在接到指令前不会主动查找下一条数据</p>
<h4 id="创建游标-opencursor"><a href="#创建游标-openCursor" class="headerlink" title="创建游标 openCursor()"></a>创建游标 openCursor()</h4><p>可以接收两个参数：（后面讲！！！）</p>
<ul>
<li>键范围</li>
<li>游标方向</li>
</ul>
<p>openCursor()也返回一个请求，所以必须为它添加onsuccess和onerror事件处理程序</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> transaction = db.<span class="title function_">transaction</span>(<span class="string">&#x27;users&#x27;</span>),</span><br><span class="line">      store = transaction.<span class="title function_">objectStore</span>(<span class="string">&#x27;users&#x27;</span>),</span><br><span class="line">      request = store.<span class="title function_">openCursor</span>();</span><br><span class="line"></span><br><span class="line">request.<span class="property">onerror</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 处理错误程序</span></span><br><span class="line">&#125;;</span><br><span class="line">    </span><br><span class="line">request.<span class="property">onsuccess</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 处理成功</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ol>
<li><p>在调用<code>onsuccess</code>事件处理程序时，可以通过<code>event.target.result</code>访问对象存储中的下一条记录，这个属性中保存着<code>IDBCursor</code>的实例（有下一条记录时）或null（没有记录时）</p>
<p>实例有如下属性：</p>
<ul>
<li>direction：字符串常量，表示游标的前进方向以及是否应该遍历所有重复的值。<ul>
<li>可能的值包括：NEXT(“next”)、NEXTUNIQUE(“nextunique”)、PREV(“prev”)、PREVUNIQUE(“prevunique”)</li>
</ul>
</li>
<li>key：对象的键</li>
<li>value：实际的对象</li>
<li>primaryKey：游标使用的键，可能是对象键或索引键</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">request.<span class="property">onsuccess</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> cursor = event.<span class="property">target</span>.<span class="property">result</span>;</span><br><span class="line">    <span class="keyword">if</span> (cursor) &#123;  <span class="comment">// 永远要检查！</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Key:<span class="subst">$&#123;cursor.key&#125;</span>,Value:<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(cursor.value)&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>游标可用于更新个别记录——update()</p>
</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">request.<span class="property">onsuccess</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">	<span class="keyword">const</span> cursor = event.<span class="property">target</span>.<span class="property">result</span>;</span><br><span class="line">	<span class="keyword">let</span> value,</span><br><span class="line">		updateRequest;</span><br><span class="line">	<span class="keyword">if</span> (cursor) &#123; <span class="comment">// 永远要检查</span></span><br><span class="line">		<span class="keyword">if</span> (cursor.<span class="property">key</span> == <span class="string">&quot;foo&quot;</span>) &#123;</span><br><span class="line">			value = cursor.<span class="property">value</span>; <span class="comment">// 取得当前对象</span></span><br><span class="line">			value.<span class="property">password</span> = <span class="string">&quot;magic!&quot;</span>; <span class="comment">// 更新密码</span></span><br><span class="line">			updateRequest = cursor.<span class="title function_">update</span>(value); <span class="comment">// 请求保存更新后的对象</span></span><br><span class="line">			updateRequest.<span class="property">onsuccess</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">				<span class="comment">// 处理成功</span></span><br><span class="line">			&#125;;</span><br><span class="line">			updateRequest.<span class="property">onerror</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">				<span class="comment">// 处理错误</span></span><br><span class="line">			&#125;;</span><br><span class="line">	&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>可以删除游标位置的记录_delete()</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">request.<span class="property">onsuccess</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">	<span class="keyword">const</span> cursor = event.<span class="property">target</span>.<span class="property">result</span>;</span><br><span class="line">	<span class="keyword">let</span> value,</span><br><span class="line">		deleteRequest;</span><br><span class="line">	<span class="keyword">if</span> (cursor) &#123; <span class="comment">// 永远要检查</span></span><br><span class="line">		<span class="keyword">if</span> (cursor.<span class="property">key</span> == <span class="string">&quot;foo&quot;</span>) &#123;</span><br><span class="line">			deleteRequest = cursor.<span class="title function_">delete</span>(); <span class="comment">// 请求删除对象</span></span><br><span class="line">			deleteRequest.<span class="property">onsuccess</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">				<span class="comment">// 处理成功</span></span><br><span class="line">			&#125;;</span><br><span class="line">			deleteRequest.<span class="property">onerror</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">				<span class="comment">// 处理错误</span></span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>注意：如果事务没有修改对象存储的权限，那么update和delete都会报错</p>
<h4 id="游标迭代"><a href="#游标迭代" class="headerlink" title="游标迭代"></a>游标迭代</h4><p>默认情况下，每个游标只会创建一个请求</p>
<p>要创建另一个请求，必须调用下列中的一个方法</p>
<ul>
<li>continue(key)：移动到结果集中的下一条记录，参数key 是可选的，如果没有指定key，游标就移动到下一条记录；如果指定了，则游标移动到指定的键</li>
<li>advance(count)：游标向前移动指定的count 条记录，这两个方法都会让游标重用相同的请求，因此也会重用onsuccess 和onerror 处理程序，直至不再需要</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">request.<span class="property">onsuccess</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">	<span class="keyword">const</span> cursor = event.<span class="property">target</span>.<span class="property">result</span>;</span><br><span class="line">	<span class="keyword">if</span> (cursor) &#123; <span class="comment">// 永远要检查</span></span><br><span class="line">		<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Key: <span class="subst">$&#123;cursor.key&#125;</span>, Value: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(cursor.value)&#125;</span>`</span>);</span><br><span class="line">		cursor.<span class="title function_">continue</span>(); <span class="comment">// 移动到下一条记录</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Done!&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="键范围"><a href="#键范围" class="headerlink" title="键范围"></a>键范围</h4><p>可以使用键范围更容易地管理游标</p>
<p>键范围对应<code>IDBKeyRange</code>的实例</p>
<p>有四种方式指定键范围</p>
<ul>
<li>方式1：only</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> onlyRange = <span class="title class_">IDBKeyRange</span>.<span class="title function_">only</span>(<span class="string">&#x27;007&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>这个范围保证只获取键为”007”的值</p>
<p>使用这个范围创建的游标类似于直接访问对象存储并调用get(“007”)</p>
<ul>
<li>方式2：lowerBound</li>
</ul>
<blockquote>
<p>定义结果集的下限，下限表示游标开始的位置</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> lowerRange = <span class="title class_">IDBKeyRange</span>.<span class="title function_">lowerRange</span>(<span class="string">&#x27;007&#x27;</span>);   <span class="comment">// 保证游标从&quot;007&quot;这个键开始</span></span><br></pre></td></tr></table></figure>

<ul>
<li>方式3：upperBound</li>
</ul>
<blockquote>
<p>定义结果集的上限，通过调用upperBound()方法可以指定游标不会越过的记录，如果不想包含指定的键，可以在第二个参数传入true</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从头开始，到&quot;ace&quot;记录为止</span></span><br><span class="line"><span class="keyword">const</span> upperRange = <span class="title class_">IDBKeyRange</span>.<span class="title function_">upperBound</span>(<span class="string">&quot;ace&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从头开始，到&quot;ace&quot;的前一条记录为止</span></span><br><span class="line"><span class="keyword">const</span> upperRange = <span class="title class_">IDBKeyRange</span>.<span class="title function_">upperBound</span>(<span class="string">&quot;ace&quot;</span>, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>方式4：bound</li>
</ul>
<blockquote>
<p>同时指定下限和上限，这个方法接收四个参数：下限的键、上限的键、可选的布尔值表示是否跳过下限和可选的布尔值表示是否跳过上限</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从&quot;007&quot;记录开始，到&quot;ace&quot;记录停止</span></span><br><span class="line"><span class="keyword">const</span> boundRange = <span class="title class_">IDBKeyRange</span>.<span class="title function_">bound</span>(<span class="string">&quot;007&quot;</span>, <span class="string">&quot;ace&quot;</span>);</span><br><span class="line"><span class="comment">// 从&quot;007&quot;的下一条记录开始，到&quot;ace&quot;记录停止</span></span><br><span class="line"><span class="keyword">const</span> boundRange = <span class="title class_">IDBKeyRange</span>.<span class="title function_">bound</span>(<span class="string">&quot;007&quot;</span>, <span class="string">&quot;ace&quot;</span>, <span class="literal">true</span>);</span><br><span class="line"><span class="comment">// 从&quot;007&quot;的下一条记录开始，到&quot;ace&quot;的前一条记录停止</span></span><br><span class="line"><span class="keyword">const</span> boundRange = <span class="title class_">IDBKeyRange</span>.<span class="title function_">bound</span>(<span class="string">&quot;007&quot;</span>, <span class="string">&quot;ace&quot;</span>, <span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line"><span class="comment">// 从&quot;007&quot;记录开始，到&quot;ace&quot;的前一条记录停止</span></span><br><span class="line"><span class="keyword">const</span> boundRange = <span class="title class_">IDBKeyRange</span>.<span class="title function_">bound</span>(<span class="string">&quot;007&quot;</span>, <span class="string">&quot;ace&quot;</span>, <span class="literal">false</span>, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure>

<h4 id="游标范围设置传入opencursor"><a href="#游标范围设置——传入openCursor" class="headerlink" title="游标范围设置——传入openCursor"></a>游标范围设置——传入openCursor</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = db.<span class="title function_">transaction</span>(<span class="string">&quot;users&quot;</span>).<span class="title function_">objectStore</span>(<span class="string">&quot;users&quot;</span>),</span><br><span class="line">	range = <span class="title class_">IDBKeyRange</span>.<span class="title function_">bound</span>(<span class="string">&quot;007&quot;</span>, <span class="string">&quot;ace&quot;</span>);</span><br><span class="line"></span><br><span class="line">request = store.<span class="title function_">openCursor</span>(range);</span><br><span class="line">request.<span class="property">onsuccess</span> = <span class="keyword">function</span>(<span class="params">event</span>)&#123;</span><br><span class="line">	<span class="keyword">const</span> cursor = event.<span class="property">target</span>.<span class="property">result</span>;</span><br><span class="line">	<span class="keyword">if</span> (cursor) &#123; <span class="comment">// 永远要检查</span></span><br><span class="line">		<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Key: <span class="subst">$&#123;cursor.key&#125;</span>, Value: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(cursor.value)&#125;</span>`</span>);</span><br><span class="line">		cursor.<span class="title function_">continue</span>(); <span class="comment">// 移动到下一条记录</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Done!&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="设置游标方向"><a href="#设置游标方向" class="headerlink" title="设置游标方向"></a>设置游标方向</h4><p>游标方向：</p>
<ul>
<li><code>next</code>（默认）：从第一条到最后一条，不跳过重复项</li>
<li><code>nextunique</code>：从第一条到最后一条，跳过重复项</li>
<li><code>prev</code>：从最后一条到第一条，不跳过重复项</li>
<li><code>prevunique</code>：从最后一条到第一条，跳过重复项</li>
</ul>
<h3 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h3><h4 id="创建新索引-createindex"><a href="#创建新索引-createIndex" class="headerlink" title="创建新索引 createIndex()"></a>创建新索引 createIndex()</h4><p><strong>参数说明</strong></p>
<ul>
<li>索引名称</li>
<li>索引属性名称</li>
<li>包含键unique的options对象<ul>
<li>unique必须指定，表示这个键是否在所在记录里面唯一</li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> transaction = db.<span class="title function_">transaction</span>(<span class="string">&quot;users&quot;</span>),</span><br><span class="line">	store = transaction.<span class="title function_">objectStore</span>(<span class="string">&quot;users&quot;</span>),</span><br><span class="line">	index = store.<span class="title function_">createIndex</span>(<span class="string">&quot;username&quot;</span>, <span class="string">&quot;username&quot;</span>, &#123; <span class="attr">unique</span>: <span class="literal">true</span> &#125;);</span><br></pre></td></tr></table></figure>

<p><strong>返回值说明</strong></p>
<p>返回IDBIndex实例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> transaction = db.<span class="title function_">transaction</span>(<span class="string">&quot;users&quot;</span>),</span><br><span class="line">	store = transaction.<span class="title function_">objectStore</span>(<span class="string">&quot;users&quot;</span>),</span><br><span class="line">	index = store.<span class="title function_">index</span>(<span class="string">&quot;username&quot;</span>);  <span class="comment">// 使用索引</span></span><br></pre></td></tr></table></figure>

<ol>
<li><p>可以在索引上使用openCursor()方法创建新游标，这个游标与在对象存储上调用openCursor()创建的游标完全一样，只是其result.key 属性中保存的是索引键，而不是主键</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> transaction = db.<span class="title function_">transaction</span>(<span class="string">&quot;users&quot;</span>),</span><br><span class="line">	store = transaction.<span class="title function_">objectStore</span>(<span class="string">&quot;users&quot;</span>),</span><br><span class="line">	index = store.<span class="title function_">index</span>(<span class="string">&quot;username&quot;</span>),</span><br><span class="line">	request = index.<span class="title function_">openCursor</span>();</span><br><span class="line"></span><br><span class="line">request.<span class="property">onsuccess</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">	<span class="comment">// 处理成功</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用openKeyCursor()方法也可以在索引上创建特殊游标，只返回每条记录的主键</p>
<p>这个方法接收的参数与openCursor()一样</p>
<p><strong>最大的不同在于，event.result.key 是索引键，且event.result.value是主键而不是整个记录</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> transaction = db.<span class="title function_">transaction</span>(<span class="string">&quot;users&quot;</span>),</span><br><span class="line">	store = transaction.<span class="title function_">objectStore</span>(<span class="string">&quot;users&quot;</span>),</span><br><span class="line">	index = store.<span class="title function_">index</span>(<span class="string">&quot;username&quot;</span>),</span><br><span class="line">	request = index.<span class="title function_">openKeyCursor</span>();</span><br><span class="line"></span><br><span class="line">request.<span class="property">onsuccess</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">	<span class="comment">// 处理成功</span></span><br><span class="line">	<span class="comment">// event.result.key 是索引键，event.result.value 是主键</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果想只取得给定索引键的主键，可以使用getKey()方法，这样也会创建一个新请求，但result.value 等于主键而不是整个记录</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> transaction = db.<span class="title function_">transaction</span>(<span class="string">&quot;users&quot;</span>),</span><br><span class="line">	store = transaction.<span class="title function_">objectStore</span>(<span class="string">&quot;users&quot;</span>),</span><br><span class="line">	index = store.<span class="title function_">index</span>(<span class="string">&quot;username&quot;</span>),</span><br><span class="line">	request = index.<span class="title function_">getKey</span>(<span class="string">&quot;007&quot;</span>);</span><br><span class="line"></span><br><span class="line">request.<span class="property">onsuccess</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">	<span class="comment">// 处理成功</span></span><br><span class="line">	<span class="comment">// event.target.result.key 是索引键，event.target.result.value 是主键</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>在这个onsuccess 事件处理程序中，event.target.result.value 中应该是用户ID</p>
<p>任何时候，都可以使用IDBIndex 对象的下列属性取得索引的相关信息</p>
<ul>
<li>name：索引的名称</li>
<li>keyPath：调用createIndex()时传入的属性路径</li>
<li>objectStore：索引对应的对象存储</li>
<li>unique：表示索引键是否唯一的布尔值</li>
</ul>
<p>对象存储自身也有一个indexNames 属性，保存着与之相关索引的名称</p>
<p>使用如下代码可以方便地了解对象存储上已存在哪些索引</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> transaction = db.<span class="title function_">transaction</span>(<span class="string">&quot;users&quot;</span>),</span><br><span class="line">	store = transaction.<span class="title function_">objectStore</span>(<span class="string">&quot;users&quot;</span>),</span><br><span class="line">	indexNames = store.<span class="property">indexNames</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> indexName <span class="keyword">in</span> indexNames) &#123;</span><br><span class="line">	<span class="keyword">const</span> index = store.<span class="title function_">index</span>(indexName);</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Index name: <span class="subst">$&#123;index.name&#125;</span></span></span><br><span class="line"><span class="string">		KeyPath: <span class="subst">$&#123;index.keyPath&#125;</span></span></span><br><span class="line"><span class="string">		Unique: <span class="subst">$&#123;index.unique&#125;</span>`</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在对象存储上调用deleteIndex()方法并传入索引的名称可以删除索引</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> transaction = db.<span class="title function_">transaction</span>(<span class="string">&quot;users&quot;</span>),</span><br><span class="line">	store = transaction.<span class="title function_">objectStore</span>(<span class="string">&quot;users&quot;</span>),</span><br><span class="line">	store.<span class="title function_">deleteIndex</span>(<span class="string">&quot;username&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>因为删除索引不会影响对象存储中的数据，所以这个操作没有回调</p>
</li>
</ol>
<h3 id="并发问题"><a href="#并发问题" class="headerlink" title="并发问题"></a>并发问题</h3><p><code>IndexedDB</code>虽然是网页中的异步<code>API</code>，但仍存在并发问题</p>
<p>如果两个不同的浏览器标签页同时打开了同一个网页，则有可能出现一个网页尝试升级数据库而另一个尚未就绪的情形</p>
<p>有问题的操作是设置数据库为新版本，而版本变化只能在浏览器只有一个标签页使用数据库时才能完成</p>
<p>第一次打开数据库时，添加onversionchange 事件处理程序非常重要，另一个同源标签页将数据库打开到新版本时，将执行此回调，对这个事件最好的回应是立即关闭数据库，以便完成版本升级</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> request, database;</span><br><span class="line">request = indexedDB.<span class="title function_">open</span>(<span class="string">&quot;admin&quot;</span>, <span class="number">1</span>);</span><br><span class="line">request.<span class="property">onsuccess</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">	database = event.<span class="property">target</span>.<span class="property">result</span>;</span><br><span class="line">	database.<span class="property">onversionchange</span> = <span class="function">() =&gt;</span> database.<span class="title function_">close</span>();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>应该在每次成功打开数据库后都指定<code>onversionchange</code>事件处理程序</p>
<p>记住，<code>onversionchange</code>有可能会被其他标签页触发</p>
<p>通过始终都指定这些事件处理程序，可以保证<code>Web</code>应用程序能够更好地处理与<code>IndexedDB</code>相关的并发问题</p>
<h3 id="限制"><a href="#限制" class="headerlink" title="限制"></a>限制</h3><ul>
<li>IndexedDB 数据库是与页面源（协议、域和端口）绑定的，因此信息不能跨域共享。这意味着<a target="_blank" rel="noopener" href="http://www.wrox.com/">www.wrox.com</a> 和p2p.wrox.com 会对应不同的数据存储</li>
<li>每个源都有可以存储的空间限制。当前Firefox 的限制是每个源50MB，而Chrome 是5MB，移动版Firefox 有5MB 限制，如果用度超出配额则会请求用户许可</li>
<li>Firefox 还有一个限制——本地文本不能访问IndexedDB 数据库，Chrome 没有这个限制。</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Katrina</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="Symbols count total">304k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">4:37</span>
  </span>
</div>
<div class="busuanzi-count">
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

<!-- 不蒜子统计 -->
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div>
	<span class="user-icon">
      <i class="fa fa-user-md"></i>
    </span>
	Views:<span id="busuanzi_value_site_pv"></span>     
	<span class="post-meta-divider">|</span>
	<span class="view-icon">
      <i class="fa fa-eye"></i>
    </span>
	Visitors:<span id="busuanzi_value_site_uv"></span>
</div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.0/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
